<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ellis Bell Web App 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        // Use Century Gothic, with Questrial as a web-safe fallback
                        sans: ['Century Gothic', 'Questrial', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Questrial&display=swap" rel="stylesheet">
    <style>
        body {
            /* Apply the new font stack */
            font-family: 'Century Gothic', 'Questrial', 'sans-serif';
        }
        /* Styles for Admin Controls */
        /* Hide admin controls and shared delete/edit buttons by default */
        .admin-control, #combined-bell-list .delete-btn, #combined-bell-list .edit-btn {
            display: none;
        }
        /* When body has .admin-mode, show them */
        body.admin-mode .admin-control {
            display: block;  
        }
        /* Show shared delete/edit buttons in admin mode */
        body.admin-mode #combined-bell-list .delete-btn,
        body.admin-mode #combined-bell-list .edit-btn {
            display: inline-block;
        }
        /* Always show custom delete/edit buttons */
        #combined-bell-list .delete-custom-btn,
        #combined-bell-list .edit-custom-btn {
            display: inline-block;
        }
        /* Fix for modal z-index issues */
        #edit-bell-modal { z-index: 50; }
        #confirm-linked-edit-modal { z-index: 60; }
        /* NEW: Z-index for new modal */
        #confirm-delete-bell-modal { z-index: 55; }

        /* REMOVED: Old mute button styles */

        /* NEW: Hide file input, style the button */
        #import-file-input {
            display: none;
        }

    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans"> <div id="welcome-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-10 rounded-lg shadow-xl w-full max-w-md text-center">
            <h2 class="text-3xl font-bold text-blue-700 mb-4">Welcome to School Bell</h2>
            <p class="text-gray-600 mb-8">Please sign in to load and sync schedules.</p>
            <div class="space-y-4">
                <button id="google-start-btn" class="w-full flex items-center justify-center gap-2 px-6 py-3 bg-white text-gray-700 font-medium rounded-lg shadow-md border border-gray-200 hover:bg-gray-50 transition-colors">
                    <svg class="w-5 h-5" viewBox="0 0 48 48">
                        <path fill="#4285F4" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l8.28 6.42C12.92 13.9 18.06 9.5 24 9.5z"></path>
                        <path fill="#34A853" d="M46.98 24.55c0-1.57-.15-3.09-.42-4.55H24v8.51h12.8c-.57 2.73-2.2 5.08-4.79 6.69l7.38 5.71C44.97 36.3 46.98 30.8 46.98 24.55z"></path>
                        <path fill="#FBBC05" d="M10.84 28.71C10.22 26.9 9.83 24.99 9.83 23c0-1.99.39-3.9 1.01-5.71L2.56 10.8C.9 14.28 0 18.48 0 23c0 4.52.9 8.72 2.56 12.2l8.28-6.49z"></path>
                        <path fill="#EA4335" d="M24 48c5.4 0 10.32-1.62 14.34-4.38l-7.38-5.71C28.71 40.5 26.47 42.1 24 42.1c-5.94 0-11.08-4.4-12.96-10.28L2.56 38.2C6.51 46.04 14.62 48 24 48z"></path>
                        <path fill="none" d="M0 0h48v48H0z"></path>
                    </svg>
                    Sign in with Google
                </button>
                <button id="anonymous-start-btn" class="w-full px-6 py-3 bg-gray-600 text-white font-medium rounded-lg shadow-md hover:bg-gray-700 transition-colors">
                    Continue Anonymously
                </button>
            </div>
        </div>
    </div>

    <div id="audio-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40 hidden">
        <button id="start-audio-btn" class="px-8 py-4 bg-blue-600 text-white font-bold text-2xl rounded-lg shadow-lg hover:bg-blue-700 transition-colors">
            Click to Start Audio
        </button>
    </div>

    <div id="add-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 hidden">
        <form id="multi-add-bell-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-medium mb-6">Add Bell to Schedules</h3>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="multi-bell-time" class="block text-sm font-medium text-gray-700">Time (HH:MM:SS)</label>
                    <input type="time" id="multi-bell-time" step="1" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="multi-bell-name" class="block text-sm font-medium text-gray-700">Bell Name</label>
                    <input type="text" id="multi-bell-name" placeholder="e.g. 1st Period End" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div>
                <label for="multi-bell-sound" class="block text-sm font-medium text-gray-700">Sound</label>
                <select id="multi-bell-sound" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="Bell">Bell</option>
                    <option value="Chime">Chime</option>
                    <option value="Beep">Beep</option>
                    <option value="Alarm">Alarm</option>
                    <option value="ellisBell.mp3" selected>Ellis Bell</option> </select>
            </div>

            <div class="mt-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Schedules to Add to:</label>
                <div class="flex gap-2 mb-2">
                    <button type="button" id="multi-select-all" class="px-3 py-1 text-xs bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300">Select All</button>
                    <button type="button" id="multi-select-none" class="px-3 py-1 text-xs bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300">Select None</button>
                </div>
                <div id="multi-schedule-list-container" class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4 grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <p class="text-gray-500">Loading schedules...</p>
                </div>
            </div>
            
            <p id="multi-add-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="multi-add-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" id="multi-add-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Bell</button>
            </div>
        </form>
    </div>

    <div id="edit-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <form id="edit-bell-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-medium mb-6">Edit Bell</h3>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="edit-bell-time" class="block text-sm font-medium text-gray-700">Time (HH:MM:SS)</label>
                    <input type="time" id="edit-bell-time" step="1" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="edit-bell-name" class="block text-sm font-medium text-gray-700">Bell Name</label>
                    <input type="text" id="edit-bell-name" placeholder="e.g. 1st Period End" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div>
                <label for="edit-bell-sound" class="block text-sm font-medium text-gray-700">Sound</label>
                <select id="edit-bell-sound" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="Bell">Bell</option>
                    <option value="Chime">Chime</option>
                    <option value="Beep">Beep</option>
                    <option value="Alarm">Alarm</option>
                    <option value="ellisBell.mp3">Ellis Bell</option> </select>
            </div>
            
            <p id="edit-bell-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="edit-bell-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" id="edit-bell-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
            </div>
        </form>
    </div>

    <div id="confirm-linked-edit-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-xl font-medium mb-4">Update Linked Schedules?</h3>
            <p class="text-gray-700 mb-4">This bell was found in other schedules. Do you want to apply your edit to them as well?</p>
            
            <p class="text-sm font-medium text-gray-700 mb-2">Schedules containing this bell:</p>
            <div id="linked-schedule-list" class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4 grid grid-cols-1 sm:grid-cols-2 gap-2">
                </div>
            
            <p id="linked-edit-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <div class="mt-6 flex flex-col sm:flex-row justify-end gap-3">
                <button type="button" id="linked-edit-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="linked-edit-this-only" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">Update This Schedule Only</button>
                <button type="button" id="linked-edit-apply" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Apply to All Selected</button>
            </div>
        </div>
    </div>


    <div id="confirm-delete-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-medium mb-4">Delete Schedule</h3>
            <p id="confirm-delete-text" class="text-gray-700 mb-6">Are you sure you want to delete this schedule? This action cannot be undone.</p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="delete-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="delete-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>
    
    <div id="confirm-delete-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-medium mb-4">Delete Bell</h3>
            <p id="confirm-delete-bell-text" class="text-gray-700 mb-6">Are you sure you want to delete this bell?</p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="delete-bell-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="delete-bell-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>


    <div class="container mx-auto max-w-2xl p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-700">School Bell</h1>
            <p class="text-lg text-gray-600">A real-time, synchronized bell schedule</p>
            
            <div class="mt-4 flex flex-col sm:flex-row justify-center items-center gap-4">
                <p class="text-sm text-gray-500">
                    <code id="userIdDisplay" class="bg-gray-200 px-2 py-1 rounded">...</code>
                </p>
                <button id="signout-btn" class="w-full sm:w-auto px-4 py-1 text-sm bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors hidden">
                    Sign Out
                </button>
            </div>
        </header>

        <div class="bg-white p-6 md:p-10 rounded-xl shadow-md mb-8">
            <div class="text-center">
                <div id="live-clock-sentence" class="text-2xl font-medium text-gray-600 tabular-nums">
                    Loading...
                </div>
                <div id="countdown-display" class="text-6xl md:text-8xl font-bold text-gray-800 tabular-nums my-2">
                    --:--
                </div>
                <div id="next-bell-sentence" class="text-2xl font-medium text-gray-600">
                    until the next bell.
                </div>
            </div>

            <div class="text-center text-gray-500 text-lg mt-6"> Status: <span id="status-message" class="font-medium text-gray-700">Initializing...</span>
            </div>

            </div>

        <div>
            <div class="flex justify-between items-center mb-4">
                <h2 id="schedule-title" class="text-2xl font-semibold">Current Schedule</h2>
                <label for="mute-all-toggle" class="flex items-center space-x-2 cursor-pointer text-sm font-medium text-gray-700">
                    <input type="checkbox" id="mute-all-toggle" class="rounded text-blue-600 focus:ring-blue-500 h-5 w-5">
                    <span>Mute All</span>
                </label>
            </div>
            <div id="combined-bell-list" class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
                <div class="p-8 text-center text-gray-500">
                    Loading schedule...
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <div class="flex justify-between items-center mb-2">
                <label for="schedule-selector" class="block text-lg font-medium text-gray-700">Active Shared Schedule</label>
                <button id="admin-toggle" class="px-3 py-1 text-sm bg-gray-200 text-gray-800 rounded-full hover:bg-gray-300 transition-colors opacity-50 cursor-not-allowed" disabled title="Sign in to see admin options">
                    Toggle Admin
                </button>
            </div>
            <select id="schedule-selector" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg">
                <option value="">Loading schedules...</option>
            </select>
            
        </div>
        
        <div class="admin-control bg-white p-6 rounded-xl shadow-md mb-8 space-y-6">
            <h3 class="text-xl font-semibold text-gray-800 border-b pb-2">Admin Zone</h3>
            
            <form id="create-schedule-form">
                <label for="new-schedule-name" class="block text-sm font-medium text-gray-700 mb-1">Create New Schedule</label>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="new-schedule-name" placeholder="New Schedule Name" required class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700">
                        Create
                    </button>
                </div>
            </form>

            <form id="add-shared-bell-form" class="border-t pt-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Add Bell to This Schedule</label>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="shared-bell-time" class="block text-sm font-medium text-gray-700 mb-1">Time (HH:MM:SS)</label>
                        <input type="time" id="shared-bell-time" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="shared-bell-name" class="block text-sm font-medium text-gray-700 mb-1">Bell Name</label>
                        <input type="text" id="shared-bell-name" placeholder="e.g. 1st Period Start" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-end gap-4">
                    <div class="flex-grow" style="min-width: 120px;">
                        <label for="shared-bell-sound" class="block text-sm font-medium text-gray-700 mb-1">Sound</label>
                        <select id="shared-bell-sound" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Bell">Bell</option>
                            <option value="Chime">Chime</option>
                            <option value="Beep">Beep</option>
                            <option value="Alarm">Alarm</option>
                            <option value="ellisBell.mp3" selected>Ellis Bell</option> </select>
                    </div>
                    <button type="button" id="preview-shared-sound" class="px-4 py-2 text-2xl bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview sound">
                        ‚ñ∂
                    </button>
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Add Shared Bell
                    </button>
                </div>
                <p id="add-shared-status" class="text-blue-600 text-sm mt-3 hidden"></p>
            </form>

            <div class="border-t pt-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Add Bell to Multiple Schedules</label>
                <button type="button" id="show-add-bell-modal-btn" class="w-full px-6 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700">
                    Add Bell to Schedules...
                </button>
            </div>

            <div class="border-t pt-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Delete Current Schedule</label>
                <button type="button" id="delete-schedule-btn" class="w-full px-4 py-2 bg-red-600 text-white font-medium rounded-lg shadow-md hover:bg-red-700 transition-colors">
                    Delete Selected Schedule
                </button>
            </div>

            <div class="border-t pt-6 space-y-4">
                <h4 class="text-lg font-medium text-gray-800">Backup & Restore</h4>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Export All Schedules</label>
                    <button type="button" id="export-schedules-btn" class="w-full px-4 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                        Download Backup (JSON)
                    </button>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Import & Overwrite Schedules</label>
                    <input type="file" id="import-file-input" accept="application/json">
                    <button type="button" id="import-schedules-btn" class="w-full px-4 py-2 bg-gray-600 text-white font-medium rounded-lg shadow-md hover:bg-gray-700 transition-colors">
                        Upload Backup (JSON)
                    </button>
                    <p id="import-status" class="text-blue-600 text-sm mt-2 hidden"></p>
                </div>
            </div>

        </div>


        <div class="mt-12">
            <h2 class="text-2xl font-semibold mb-4">My Custom Bells (This Browser Only)</h2>

            <form id="add-custom-bell-form" class="bg-white p-6 rounded-xl shadow-md mb-8">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="custom-bell-time" class="block text-sm font-medium text-gray-700 mb-1">Time (HH:MM:SS)</label>
                        <input type="time" id="custom-bell-time" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="custom-bell-name" class="block text-sm font-medium text-gray-700 mb-1">Bell Name</label>
                        <input type="text" id="custom-bell-name" placeholder="e.g. My Reminder" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-end gap-4">
                    <div class="flex-grow" style="min-width: 120px;">
                        <label for="custom-bell-sound" class="block text-sm font-medium text-gray-700 mb-1">Sound</label>
                        <select id="custom-bell-sound" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Bell">Bell</option>
                            <option value="Chime">Chime</option>
                            <option value="Beep">Beep</option>
                            <option value="Alarm">Alarm</option>
                            <option value="ellisBell.mp3">Ellis Bell</option> </select>
                    </div>
                    <button type="button" id="preview-custom-sound" class="px-4 py-2 text-2xl bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview sound">
                        ‚ñ∂
                    </button>
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Add Custom Bell
                    </button>
                </div>
            </form>
        </div>

    </div>

        <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        
        // MODIFIED: Reverted to signInWithPopup
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signOut, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, getDocs, writeBatch, setLogLevel, deleteDoc, getDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Elements ---
        const welcomeOverlay = document.getElementById('welcome-overlay');
        const audioOverlay = document.getElementById('audio-overlay'); // RE-ADDED
        const startAudioBtn = document.getElementById('start-audio-btn'); // RE-ADDED
        
        const googleStartBtn = document.getElementById('google-start-btn');
        const anonymousStartBtn = document.getElementById('anonymous-start-btn');
        
        // MODIFIED: Renamed to countdownElement
        const countdownElement = document.getElementById('countdown-display');
        // NEW: Changed to point to the new sentence elements
        const clockElement = document.getElementById('live-clock-sentence');
        const statusElement = document.getElementById('status-message');
        const nextBellElement = document.getElementById('next-bell-sentence');
        const userIdElement = document.getElementById('userIdDisplay');
        const scheduleSelector = document.getElementById('schedule-selector');
        const scheduleTitle = document.getElementById('schedule-title');
        const adminToggleBtn = document.getElementById('admin-toggle');

        // DELETED: Old Mute Buttons
        
        // NEW: Mute All Toggle
        const muteAllToggle = document.getElementById('mute-all-toggle');
        
        // Custom Bell Form
        const addCustomBellForm = document.getElementById('add-custom-bell-form');
        const customTimeInput = document.getElementById('custom-bell-time');
        const customNameInput = document.getElementById('custom-bell-name');  
        const customSoundInput = document.getElementById('custom-bell-sound');
        
        // Add Shared Bell Form (in Admin Zone)
        const addSharedBellForm = document.getElementById('add-shared-bell-form');
        const sharedTimeInput = document.getElementById('shared-bell-time');
        const sharedNameInput = document.getElementById('shared-bell-name');
        const sharedSoundInput = document.getElementById('shared-bell-sound');
        const previewSharedSoundBtn = document.getElementById('preview-shared-sound');
        const addSharedStatus = document.getElementById('add-shared-status');

        // Combined List
        const combinedBellListElement = document.getElementById('combined-bell-list');
        const previewCustomSoundBtn = document.getElementById('preview-custom-sound');
        
        // Multi-Add Bell Modal
        const addBellModal = document.getElementById('add-bell-modal');
        const showAddBellModalBtn = document.getElementById('show-add-bell-modal-btn');
        const multiAddBellForm = document.getElementById('multi-add-bell-form');
        const multiBellTimeInput = document.getElementById('multi-bell-time');
        const multiBellNameInput = document.getElementById('multi-bell-name');
        const multiBellSoundInput = document.getElementById('multi-bell-sound');
        const multiScheduleListContainer = document.getElementById('multi-schedule-list-container');
        const multiAddCancelBtn = document.getElementById('multi-add-cancel');
        const multiAddSubmitBtn = document.getElementById('multi-add-submit');
        const multiAddStatus = document.getElementById('multi-add-status');
        const multiSelectAllBtn = document.getElementById('multi-select-all');
        const multiSelectNoneBtn = document.getElementById('multi-select-none');

        // Edit Bell Modal
        const editBellModal = document.getElementById('edit-bell-modal');
        const editBellForm = document.getElementById('edit-bell-form');
        const editBellTimeInput = document.getElementById('edit-bell-time');
        const editBellNameInput = document.getElementById('edit-bell-name');
        const editBellSoundInput = document.getElementById('edit-bell-sound');
        const editBellCancelBtn = document.getElementById('edit-bell-cancel');
        const editBellSubmitBtn = document.getElementById('edit-bell-submit');
        const editBellStatus = document.getElementById('edit-bell-status');

        // Linked Edit Modal
        const confirmLinkedEditModal = document.getElementById('confirm-linked-edit-modal');
        const linkedScheduleList = document.getElementById('linked-schedule-list');
        const linkedEditStatus = document.getElementById('linked-edit-status');
        const linkedEditCancelBtn = document.getElementById('linked-edit-cancel');
        const linkedEditThisOnlyBtn = document.getElementById('linked-edit-this-only');
        const linkedEditApplyBtn = document.getElementById('linked-edit-apply');

        // Delete Schedule Modal
        const confirmDeleteModal = document.getElementById('confirm-delete-modal');
        const deleteCancelBtn = document.getElementById('delete-cancel');
        const deleteConfirmBtn = document.getElementById('delete-confirm');
        const confirmDeleteText = document.getElementById('confirm-delete-text');
        
        // Delete Bell Modal
        const confirmDeleteBellModal = document.getElementById('confirm-delete-bell-modal');
        const deleteBellCancelBtn = document.getElementById('delete-bell-cancel');
        const deleteBellConfirmBtn = document.getElementById('delete-bell-confirm');
        const confirmDeleteBellText = document.getElementById('confirm-delete-bell-text');

        // Create Schedule Form
        const createScheduleForm = document.getElementById('create-schedule-form');
        const newScheduleNameInput = document.getElementById('new-schedule-name');
        
        // Admin Buttons
        const deleteScheduleBtn = document.getElementById('delete-schedule-btn');
        const exportSchedulesBtn = document.getElementById('export-schedules-btn');
        const importSchedulesBtn = document.getElementById('import-schedules-btn');
        const importFileInput = document.getElementById('import-file-input');
        const importStatus = document.getElementById('import-status');
        
        // Auth
        const signoutBtn = document.getElementById('signout-btn');
        
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Set this to 'debug' for verbose logging, or 'silent' to turn off
        // setLogLevel('debug');

        // --- Global State ---
        let currentUserId = null;
        let isAdmin = false;
        let isAppInitialized = false; // NEW: Prevents audio overlay on first load
        let isAudioStarted = false; // RE-ADDED
        let localCustomBells = [];
        let sharedSchedules = {}; // Holds all shared schedules
        let currentSharedScheduleId = null; // The ID of the currently selected shared schedule
        let allBells = []; // The combined and sorted list of custom + shared bells
        
        // NEW: Mute State
        // Use a Set for efficient add/delete/has checks
        let mutedBellIds = new Set();
        
        // Edit modal state
        let editingBell = null; // { id, isCustom, ... }
        // Delete modal state
        let scheduleToDeleteId = null;
        // Delete *bell* modal state
        let bellToDelete = null; // { id, isCustom }

        // --- NEW: Mute State Helper Functions ---
        
        /**
         * Loads muted bell IDs from localStorage into the Set
         */
        function loadMutedBells() {
            try {
                const storedMuted = localStorage.getItem('mutedBellIds');
                if (storedMuted) {
                    const mutedArray = JSON.parse(storedMuted);
                    mutedBellIds = new Set(mutedArray);
                }
            } catch (e) {
                console.error("Failed to load muted bells:", e);
                mutedBellIds = new Set();
            }
        }

        /**
         * Saves the current mutedBellIds Set to localStorage
         */
        function saveMutedBells() {
            try {
                const mutedArray = [...mutedBellIds];
                localStorage.setItem('mutedBellIds', JSON.stringify(mutedArray));
            } catch (e) {
                console.error("Failed to save muted bells:", e);
            }
        }

        /**
         * Checks if a specific bell ID is muted
         * @param {string} bellId
         * @returns {boolean}
         */
        function isBellMuted(bellId) {
            return mutedBellIds.has(bellId);
        }
        
        /**
         * Mutes a bell by ID and saves state
         * @param {string} bellId
         */
        function muteBell(bellId) {
            if (!bellId) return;
            mutedBellIds.add(bellId);
            saveMutedBells();
        }

        /**
         * Unmutes a bell by ID and saves state
         * @param {string} bellId
         */
        function unmuteBell(bellId) {
            if (!bellId) return;
            mutedBellIds.delete(bellId);
            saveMutedBells();
        }

        /**
         * Updates the state of the "Mute All" toggle (checked, unchecked, or indeterminate)
         * based on the state of the individual bell toggles in the list.
         */
        function updateMuteAllToggleState() {
            const allToggles = combinedBellListElement.querySelectorAll('.bell-mute-toggle');
            if (allToggles.length === 0) {
                muteAllToggle.checked = false;
                muteAllToggle.indeterminate = false;
                return;
            }
            
            const checkedCount = combinedBellListElement.querySelectorAll('.bell-mute-toggle:checked').length;
            
            if (checkedCount === 0) {
                // None are checked
                muteAllToggle.checked = false;
                muteAllToggle.indeterminate = false;
            } else if (checkedCount === allToggles.length) {
                // All are checked
                muteAllToggle.checked = true;
                muteAllToggle.indeterminate = false;
            } else {
                // Some are checked
                muteAllToggle.checked = false;
                muteAllToggle.indeterminate = true;
            }
        }


        // --- Audio Context & Sounds ---
        const sounds = {
            'Bell': new Tone.Player("./sounds/school-bell.mp3").toDestination(),
            'Chime': new Tone.Player("./sounds/chime.mp3").toDestination(),
            'Beep': new Tone.Player("./sounds/beep.mp3").toDestination(),
            'Alarm': new Tone.Player("./sounds/alarm.mp3").toDestination(),
            'ellisBell.mp3': new Tone.Player("./sounds/ellisBell.mp3").toDestination(),
        };

        /**
         * Starts the Tone.js audio context.
         * Must be triggered by a user interaction.
         */
        async function startAudioContext() {
            if (isAudioStarted) return;
            try {
                await Tone.start();
                isAudioStarted = true;
                console.log("Audio context started.");
                audioOverlay.classList.add('hidden'); // Hide overlay
            } catch (e) {
                console.error("Could not start audio context:", e);
                statusElement.textContent = "Error starting audio.";
            }
        }

        /**
         * Plays a sound by its name.
         * NEW: Checks if the specific bellId is muted.
         * @param {string} soundName - The key from the 'sounds' object (e.g., "Bell")
         * @param {string} bellId - The unique ID of the bell to check mute status
         */
        async function playBellSound(soundName, bellId) {
            // NEW: Check if this specific bell is muted
            if (isBellMuted(bellId)) {
                console.log(`Bell ${bellId} (${soundName}) is muted. Skipping sound.`);
                return;
            }

            if (!isAudioStarted) {
                console.warn("Audio context not started. Cannot play sound.");
                // Show the overlay to prompt user
                audioOverlay.classList.remove('hidden');
                return;
            }
            
            const sound = sounds[soundName];
            if (sound) {
                try {
                    if (sound.state === "started") {
                        await sound.stop();
                    }
                    await sound.start();
                    console.log(`Playing sound: ${soundName}`);
                } catch (e) {
                    console.error(`Error playing sound ${soundName}:`, e);
                }
            } else {
                console.warn(`Sound not found: ${soundName}`);
            }
        }
        
        /**
         * Previews a sound from a select element.
         * @param {HTMLSelectElement} selectInput - The <select> element.
         */
        function previewSound(selectInput) {
            if (!isAudioStarted) {
                // Show the overlay to prompt user
                audioOverlay.classList.remove('hidden');
                statusElement.textContent = "Click to enable audio first.";
                return;
            }
            const soundName = selectInput.value;
            // Use a temporary bell ID "preview" for the check
            playBellSound(soundName, "preview"); 
        }

        // --- Core Application Logic ---

        /**
         * Main update loop for the clock and countdown.
         * This function is the "heartbeat" of the app.
         */
        function updateCountdown() {
            const now = new Date();
            
            // Format time for the live clock
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const currentTimeString = `${hours}:${minutes}:${seconds}`;

            // Update the live clock sentence
            clockElement.textContent = `The time is ${currentTimeString}. There are`;

            const nextBell = findNextBell(now);

            if (nextBell) {
                const bellTime = new Date(now);
                const [bellHours, bellMinutes, bellSeconds] = nextBell.time.split(':').map(Number);
                bellTime.setHours(bellHours, bellMinutes, bellSeconds, 0);

                let secondsUntilNext = (bellTime.getTime() - now.getTime()) / 1000;

                // If the bell time has already passed today, set it for tomorrow
                if (secondsUntilNext < -0.5) { // Use a small buffer
                    bellTime.setDate(bellTime.getDate() + 1);
                    secondsUntilNext = (bellTime.getTime() - now.getTime()) / 1000;
                }
                
                // NEW: Check if this specific next bell is muted
                const isNextBellMuted = isBellMuted(nextBell.id);

                // Check if it's time to ring
                if (secondsUntilNext >= -0.5 && secondsUntilNext < 0.5) { 
                    countdownElement.textContent = "RING!";
                    if (isNextBellMuted) {
                        nextBellElement.textContent = `It's time for ${nextBell.name} (Muted)`;
                    } else {
                        nextBellElement.textContent = `It's time for ${nextBell.name}`;
                    }
                    
                    // Pass the bell ID to the play function
                    playBellSound(nextBell.sound, nextBell.id); 
                    
                    // Highlight the ringing bell
                    highlightBell(nextBell.id);
                    
                    // Wait 1 second before calculating the *next* bell to avoid re-triggering
                    setTimeout(updateCountdown, 1000); 
                    return; // Stop this execution
                } else {
                    // Update countdown display
                    countdownElement.textContent = formatSeconds(secondsUntilNext);
                    // NEW: Update next bell text with mute status
                    if (isNextBellMuted) {
                        nextBellElement.textContent = `until ${nextBell.name} (Muted)`;
                    } else {
                        nextBellElement.textContent = `until ${nextBell.name}`;
                    }
                }
            } else {
                countdownElement.textContent = "--:--:--";
                nextBellElement.textContent = "No upcoming bells.";
            }

            // Request the next frame
            requestAnimationFrame(updateCountdown);
        }

        /**
         * Finds the next bell to ring from the combined 'allBells' list.
         * @param {Date} now - The current date/time.
         * @returns {Object | null} The next bell object or null.
         */
        function findNextBell(now) {
            if (allBells.length === 0) {
                return null;
            }

            const nowInSeconds = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();

            let nextBellToday = null;
            let firstBellTomorrow = null;

            for (const bell of allBells) {
                const [h, m, s] = bell.time.split(':').map(Number);
                const bellTimeInSeconds = h * 3600 + m * 60 + s;

                // Find the first bell for "tomorrow" (which is just the first in the list)
                if (!firstBellTomorrow) {
                    firstBellTomorrow = bell;
                }

                // Find the next bell for "today"
                if (bellTimeInSeconds > nowInSeconds) {
                    nextBellToday = bell;
                    break; // Found the next one for today
                }
            }
            
            // If there's a bell later today, use it. Otherwise, use tomorrow's first bell.
            return nextBellToday || firstBellTomorrow;
        }

        /**
         * Highlights a bell in the list when it rings.
         * @param {string} bellId - The ID of the bell to highlight.
         */
        function highlightBell(bellId) {
            const bellElement = document.querySelector(`[data-bell-id="${bellId}"]`);
            if (bellElement) {
                // Find the parent list item
                const listItem = bellElement.closest('.bell-item');
                if(listItem) {
                    listItem.classList.add('bg-yellow-100');
                    setTimeout(() => {
                        listItem.classList.remove('bg-yellow-100');
                    }, 5000); // Highlight for 5 seconds
                }
            }
        }

        /**
         * Formats a duration in seconds into HH:MM:SS format.
         * @param {number} totalSeconds - The duration in seconds.
         * @returns {string} The formatted time string.
         */
        function formatSeconds(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            return [hours, minutes, seconds]
                .map(v => v.toString().padStart(2, '0'))
                .join(':');
        }

        // --- Bell & Schedule Management ---

        /**
         * Combines shared and local bells, sorts them, and triggers a re-render.
         */
        function updateAndRenderCombinedList() {
            const sharedBells = sharedSchedules[currentSharedScheduleId]?.bells || [];
            
            // Combine, adding 'isCustom' flag and 'id'
            const combined = [
                ...localCustomBells.map(b => ({ ...b, isCustom: true, id: b.id })),
                ...sharedBells.map(b => ({ ...b, isCustom: false, id: b.id }))
            ];
            
            // Sort by time
            combined.sort((a, b) => a.time.localeCompare(b.time));
            
            allBells = combined; // Update global list
            renderCombinedBellList(allBells);
        }

        /**
         * Renders the combined list of bells into the DOM.
         * @param {Array} bells - The sorted list of bell objects to render.
         */
        function renderCombinedBellList(bells) {
            if (bells.length === 0) {
                combinedBellListElement.innerHTML = `<div class="p-8 text-center text-gray-500">No bells in this schedule.</div>`;
                updateMuteAllToggleState(); // NEW: Update toggle state even if empty
                return;
            }

            const bellHtml = bells.map(bell => {
                const isShared = !bell.isCustom;
                const isMuted = isBellMuted(bell.id); // NEW: Check mute state
                
                return `
                <div class="bell-item flex items-center justify-between p-4 border-b border-gray-200 last:border-b-0 hover:bg-gray-50 transition-colors">
                    <div class="grid grid-cols-[auto,auto,1fr,auto] items-center gap-x-4 w-full">
                        
                        <div class="flex-shrink-0">
                            <input 
                                type="checkbox" 
                                class="bell-mute-toggle rounded text-blue-600 focus:ring-blue-500 h-5 w-5" 
                                data-bell-id="${bell.id}" 
                                ${isMuted ? 'checked' : ''}
                                aria-label="Mute this bell"
                            >
                        </div>

                        <div class="flex-shrink-0">
                            <code class="text-lg font-medium ${isShared ? 'text-blue-700' : 'text-purple-700'} bg-gray-100 px-3 py-1 rounded-md tabular-nums">
                                ${bell.time}
                            </code>
                        </div>
                        
                        <div class="flex-grow min-w-0"> <p class="text-lg font-medium text-gray-900 truncate" title="${bell.name}">
                                ${bell.name}
                            </p>
                            <span class="text-xs font-medium ${isShared ? 'text-blue-600' : 'text-purple-600'}">
                                ${isShared ? 'Shared' : 'Custom'}
                            </span>
                        </div>
                        
                        <div class="flex-shrink-0 space-x-2">
                            <button class="edit-btn p-2 rounded-md text-gray-500 hover:bg-yellow-100 hover:text-yellow-700" data-bell-id="${bell.id}" data-is-custom="false" title="Edit Shared Bell">‚úèÔ∏è</button>
                            <button class="delete-btn p-2 rounded-md text-gray-500 hover:bg-red-100 hover:text-red-700" data-bell-id="${bell.id}" data-is-custom="false" title="Delete Shared Bell">üóëÔ∏è</button>
                            
                            <button class="edit-custom-btn p-2 rounded-md text-gray-500 hover:bg-yellow-100 hover:text-yellow-700" data-bell-id="${bell.id}" data-is-custom="true" title="Edit Custom Bell">‚úèÔ∏è</button>
                            <button class="delete-custom-btn p-2 rounded-md text-gray-500 hover:bg-red-100 hover:text-red-700" data-bell-id="${bell.id}" data-is-custom="true" title="Delete Custom Bell">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            combinedBellListElement.innerHTML = bellHtml;
            
            // NEW: Add event listeners to the new mute toggles
            combinedBellListElement.querySelectorAll('.bell-mute-toggle').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const bellId = e.target.dataset.bellId;
                    if (e.target.checked) {
                        muteBell(bellId);
                    } else {
                        unmuteBell(bellId);
                    }
                    // Update the "Mute All" toggle's indeterminate state
                    updateMuteAllToggleState();
                    // Re-run countdown logic to update the "(Muted)" text if needed
                    updateCountdown(); 
                });
            });

            // NEW: Update the "Mute All" toggle state after rendering
            updateMuteAllToggleState();
        }


        /**
         * Attaches event listeners to the bell list for edit/delete buttons.
         * Uses event delegation.
         */
        function setupBellListListeners() {
            combinedBellListElement.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                const bellId = button.dataset.bellId;
                const isCustom = button.dataset.isCustom === 'true';
                
                // Find the full bell object
                const bell = allBells.find(b => b.id === bellId);
                if (!bell) {
                    console.error("Could not find bell data for ID:", bellId);
                    return;
                }

                if (button.classList.contains('edit-btn') || button.classList.contains('edit-custom-btn')) {
                    openEditBellModal(bell);
                } else if (button.classList.contains('delete-btn') || button.classList.contains('delete-custom-btn')) {
                    openDeleteBellModal(bell);
                }
            });
        }
        
        /**
         * Loads custom bells from localStorage.
         */
        function loadCustomBells() {
            try {
                const bells = localStorage.getItem('customBells');
                localCustomBells = bells ? JSON.parse(bells) : [];
                // Ensure all custom bells have a unique ID
                localCustomBells.forEach(bell => {
                    if (!bell.id) {
                        bell.id = `local_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
                    }
                });
                saveCustomBells(); // Save back if IDs were generated
            } catch (e) {
                console.error("Failed to load custom bells:", e);
                localCustomBells = [];
            }
            updateAndRenderCombinedList();
        }

        /**
         * Saves custom bells to localStorage.
         */
        function saveCustomBells() {
            try {
                localStorage.setItem('customBells', JSON.stringify(localCustomBells));
            } catch (e) {
                console.error("Failed to save custom bells:", e);
            }
            updateAndRenderCombinedList();
        }

        /**
         * Handles the submission of the "Add Custom Bell" form.
         * @param {Event} e - The form submission event.
         */
        function handleAddCustomBell(e) {
            e.preventDefault();
            const time = customTimeInput.value;
            const name = customNameInput.value;
            const sound = customSoundInput.value;
            
            if (!time || !name) {
                alert("Please provide a time and name for the custom bell.");
                return;
            }

            const newBell = {
                id: `local_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`,
                time,
                name,
                sound
            };
            
            localCustomBells.push(newBell);
            saveCustomBells();
            
            // Reset form
            customTimeInput.value = '';
            customNameInput.value = '';
            customSoundInput.value = 'ellisBell.mp3'; // Reset to default
        }

        /**
         * Handles the submission of the "Add Shared Bell" form (Admin).
         * @param {Event} e - The form submission event.
         */
        async function handleAddSharedBell(e) {
            e.preventDefault();
            if (!isAdmin || !currentSharedScheduleId) {
                alert("You must be an admin and have a schedule selected.");
                return;
            }

            const time = sharedTimeInput.value;
            const name = sharedNameInput.value;
            const sound = sharedSoundInput.value;

            if (!time || !name) {
                alert("Please provide a time and name for the shared bell.");
                return;
            }
            
            // Create a unique ID for the bell
            // Using a timestamp + random string is good practice for Firestore document IDs
            const newBellId = `bell_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;

            const newBell = {
                id: newBellId, // Add the ID to the bell object itself
                time,
                name,
                sound
            };

            // Get the current schedule
            const currentSchedule = sharedSchedules[currentSharedScheduleId];
            if (!currentSchedule) {
                console.error("No current schedule data found.");
                return;
            }
            
            // Add the new bell to the local copy of the schedule's bells
            const updatedBells = [...(currentSchedule.bells || []), newBell];

            try {
                addSharedStatus.textContent = "Adding bell...";
                addSharedStatus.classList.remove('hidden');

                // Update the schedule document in Firestore
                const scheduleRef = doc(db, 'schedules', currentSharedScheduleId);
                await updateDoc(scheduleRef, {
                    bells: updatedBells
                });

                // Firestore listener (onAllSchedulesSnapshot) will handle updating
                // the local 'sharedSchedules' object and re-rendering.
                
                addSharedStatus.textContent = "Bell added successfully!";
                setTimeout(() => addSharedStatus.classList.add('hidden'), 2000);
                
                // Reset form
                sharedTimeInput.value = '';
                sharedNameInput.value = '';
                sharedSoundInput.value = 'ellisBell.mp3'; // Reset to default

            } catch (error) {
                console.error("Error adding shared bell: ", error);
                alert("Error adding bell. See console for details.");
                addSharedStatus.textContent = "Error adding bell.";
            }
        }
        
        /**
         * Handles the submission of the "Add Bell to Multiple Schedules" modal form.
         * @param {Event} e - The form submission event.
         */
        async function handleMultiAddBell(e) {
            e.preventDefault();
            if (!isAdmin) {
                alert("Admin only.");
                return;
            }
            
            multiAddSubmitBtn.disabled = true;
            multiAddStatus.textContent = "Adding bell(s)...";
            multiAddStatus.classList.remove('hidden');

            const time = multiBellTimeInput.value;
            const name = multiBellNameInput.value;
            const sound = multiBellSoundInput.value;
            
            // Get selected schedule IDs
            const selectedScheduleCheckboxes = multiScheduleListContainer.querySelectorAll('input[type="checkbox"]:checked');
            const selectedScheduleIds = [...selectedScheduleCheckboxes].map(cb => cb.value);
            
            if (selectedScheduleIds.length === 0) {
                multiAddStatus.textContent = "Please select at least one schedule.";
                multiAddSubmitBtn.disabled = false;
                return;
            }
            
            // Create a new bell object for *each* schedule.
            // This is important because they are not "linked".
            // Editing one later will not edit the others.
            
            const batch = writeBatch(db);
            let schedulesToUpdate = 0;

            for (const scheduleId of selectedScheduleIds) {
                const schedule = sharedSchedules[scheduleId];
                if (schedule) {
                    // Create a unique ID for this new bell instance
                    const newBellId = `bell_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
                    const newBell = { id: newBellId, time, name, sound };
                    
                    const updatedBells = [...(schedule.bells || []), newBell];
                    
                    const scheduleRef = doc(db, 'schedules', scheduleId);
                    batch.update(scheduleRef, { bells: updatedBells });
                    schedulesToUpdate++;
                }
            }
            
            try {
                await batch.commit();
                multiAddStatus.textContent = `Successfully added bell to ${schedulesToUpdate} schedule(s)!`;
                setTimeout(() => {
                    closeAddBellModal();
                    multiAddStatus.classList.add('hidden');
                    multiAddSubmitBtn.disabled = false;
                }, 2000);
            } catch (error) {
                console.error("Error adding bell to multiple schedules:", error);
                multiAddStatus.textContent = "An error occurred. See console.";
                multiAddSubmitBtn.disabled = false;
            }
        }


        /**
         * Handles the submission of the "Edit Bell" modal form.
         * @param {Event} e - The form submission event.
         */
        async function handleEditBell(e) {
            e.preventDefault();
            if (!editingBell) return;
            
            editBellSubmitBtn.disabled = true;
            editBellStatus.textContent = "Saving...";
            editBellStatus.classList.remove('hidden');
            
            const updatedBellData = {
                id: editingBell.id, // Keep the original ID
                time: editBellTimeInput.value,
                name: editBellNameInput.value,
                sound: editBellSoundInput.value
            };
            
            if (editingBell.isCustom) {
                // --- Handle Custom Bell Edit ---
                const index = localCustomBells.findIndex(b => b.id === editingBell.id);
                if (index > -1) {
                    localCustomBells[index] = { ...localCustomBells[index], ...updatedBellData };
                    saveCustomBells();
                    editBellStatus.textContent = "Saved!";
                    setTimeout(closeEditBellModal, 1000);
                } else {
                    console.error("Could not find custom bell to edit");
                    editBellStatus.textContent = "Error: Bell not found.";
                }
            } else {
                // --- Handle Shared Bell Edit (Admin) ---
                if (!isAdmin) {
                    alert("You do not have permission to edit shared bells.");
                    closeEditBellModal();
                    return;
                }
                
                // This is a shared bell. We need to check if it exists in other schedules.
                const linkedSchedules = findLinkedSchedules(editingBell);
                
                // If it's only in the current schedule, just update it.
                if (linkedSchedules.length <= 1) {
                    await updateSharedBellInSchedule(currentSharedScheduleId, updatedBellData);
                    editBellStatus.textContent = "Saved!";
                    setTimeout(closeEditBellModal, 1000);
                } else {
                    // It's in multiple schedules. Show the confirmation modal.
                    openConfirmLinkedEditModal(linkedSchedules, updatedBellData);
                    // Keep the edit modal open but hide the status
                    editBellStatus.classList.add('hidden');
                }
            }
        }

        /**
         * Updates a single bell object within a specific schedule's 'bells' array in Firestore.
         * @param {string} scheduleId - The ID of the schedule document to update.
         * @param {Object} updatedBell - The complete, updated bell object.
         */
        async function updateSharedBellInSchedule(scheduleId, updatedBell) {
            const schedule = sharedSchedules[scheduleId];
            if (!schedule) {
                console.error(`Schedule not found for ID: ${scheduleId}`);
                return;
            }
            
            const bellIndex = schedule.bells.findIndex(b => b.id === updatedBell.id);
            if (bellIndex === -1) {
                console.error(`Bell not found in schedule: ${scheduleId}`);
                return;
            }
            
            // Create a new bells array with the updated bell
            const updatedBells = [...schedule.bells];
            updatedBells[bellIndex] = updatedBell;
            
            // Update Firestore
            const scheduleRef = doc(db, 'schedules', scheduleId);
            await updateDoc(scheduleRef, { bells: updatedBells });
        }


        /**
         * Finds all schedules that contain a bell with the same *content* (time, name, sound).
         * This is used to "link" bells for mass editing.
         * @param {Object} bell - The bell object to search for.
         * @returns {Array} An array of schedule { id, name } objects.
         */
        function findLinkedSchedules(bell) {
            const linked = [];
            for (const scheduleId in sharedSchedules) {
                const schedule = sharedSchedules[scheduleId];
                const found = schedule.bells?.find(b => 
                    b.time === bell.time && 
                    b.name === bell.name && 
                    b.sound === bell.sound
                );
                if (found) {
                    linked.push({ id: scheduleId, name: schedule.name });
                }
            }
            return linked;
        }

        /**
         * Deletes a bell.
         * @param {Object} bell - The bell object to delete.
         */
        async function deleteBell(bell) {
            if (!bell) return;
            
            // Unmute the bell first, just in case
            unmuteBell(bell.id);

            if (bell.isCustom) {
                // --- Handle Custom Bell Delete ---
                localCustomBells = localCustomBells.filter(b => b.id !== bell.id);
                saveCustomBells();
            } else {
                // --- Handle Shared Bell Delete (Admin) ---
                if (!isAdmin || !currentSharedScheduleId) {
                    alert("You must be an admin to delete shared bells.");
                    return;
                }
                
                const schedule = sharedSchedules[currentSharedScheduleId];
                if (!schedule) {
                    console.error("Current schedule data not found.");
                    return;
                }
                
                // Filter out the bell to be deleted
                const updatedBells = schedule.bells.filter(b => b.id !== bell.id);
                
                try {
                    // Update the schedule document in Firestore
                    const scheduleRef = doc(db, 'schedules', currentSharedScheduleId);
                    await updateDoc(scheduleRef, {
                        bells: updatedBells
                    });
                    // Firestore listener will handle re-render
                } catch (error) {
                    console.error("Error deleting shared bell: ", error);
                    alert("Error deleting bell. See console for details.");
                }
            }
        }


        /**
         * Populates the schedule selector dropdown.
         */
        function populateScheduleSelector() {
            // Sort schedules by name
            const sortedSchedules = Object.values(sharedSchedules).sort((a, b) => a.name.localeCompare(b.name));
            
            scheduleSelector.innerHTML = ''; // Clear existing options
            
            sortedSchedules.forEach(schedule => {
                const option = document.createElement('option');
                option.value = schedule.id;
                option.textContent = schedule.name;
                scheduleSelector.appendChild(option);
            });
            
            // Try to re-select the previously selected schedule
            const savedScheduleId = localStorage.getItem('selectedScheduleId');
            if (savedScheduleId && sharedSchedules[savedScheduleId]) {
                scheduleSelector.value = savedScheduleId;
                currentSharedScheduleId = savedScheduleId;
            } else if (sortedSchedules.length > 0) {
                // Otherwise, select the first one
                scheduleSelector.value = sortedSchedules[0].id;
                currentSharedScheduleId = sortedSchedules[0].id;
            }
            
            // Update the title and list
            updateActiveSchedule();
        }

        /**
         * Updates the app state when the active schedule changes.
         */
        function updateActiveSchedule() {
            const selectedId = scheduleSelector.value;
            if (selectedId && sharedSchedules[selectedId]) {
                currentSharedScheduleId = selectedId;
                localStorage.setItem('selectedScheduleId', selectedId); // Remember selection
                
                const scheduleName = sharedSchedules[selectedId].name;
                scheduleTitle.textContent = scheduleName;
                
                // Enable/disable 'Add Shared Bell' form
                const canAddBells = isAdmin && currentSharedScheduleId;
                sharedTimeInput.disabled = !canAddBells;
                sharedNameInput.disabled = !canAddBells;
                sharedSoundInput.disabled = !canAddBells;
                addSharedBellForm.querySelector('button[type="submit"]').disabled = !canAddBells;
                
            } else {
                scheduleTitle.textContent = "No Schedule Selected";
                currentSharedScheduleId = null;
            }
            
            updateAndRenderCombinedList();
        }

        /**
         * Handles the "Create Schedule" form submission.
         * @param {Event} e - The form submission event.
         */
        async function handleCreateSchedule(e) {
            e.preventDefault();
            if (!isAdmin) {
                alert("Admin only.");
                return;
            }
            
            const newName = newScheduleNameInput.value.trim();
            if (!newName) {
                alert("Please enter a name for the new schedule.");
                return;
            }
            
            try {
                // Create a new document in the 'schedules' collection
                // We let Firestore generate the ID
                const newScheduleRef = await addDoc(collection(db, "schedules"), {
                    name: newName,
                    bells: [] // Start with an empty array of bells
                });
                
                console.log("New schedule created with ID: ", newScheduleRef.id);
                // The new schedule will appear automatically thanks to the snapshot listener.
                // We can optionally select it right away.
                // The listener will populate 'sharedSchedules', so we wait a moment
                // or just let the listener handle selecting it.
                // For now, just clear the input.
                newScheduleNameInput.value = '';
                
                // Let's set it as the active one.
                // The listener might be fast, but to be safe:
                localStorage.setItem('selectedScheduleId', newScheduleRef.id);
                
            } catch (error) {
                console.error("Error creating new schedule: ", error);
                alert("Error creating schedule. See console for details.");
            }
        }
        
        /**
         * Opens the "Delete Schedule" confirmation modal.
         */
        function openDeleteScheduleModal() {
            if (!isAdmin || !currentSharedScheduleId) {
                alert("Admin only.");
                return;
            }
            const scheduleName = sharedSchedules[currentSharedScheduleId]?.name;
            if (!scheduleName) {
                alert("No schedule selected.");
                return;
            }
            
            scheduleToDeleteId = currentSharedScheduleId;
            confirmDeleteText.textContent = `Are you sure you want to delete the schedule "${scheduleName}"? This action cannot be undone.`;
            confirmDeleteModal.classList.remove('hidden');
        }

        /**
         * Confirms and deletes the selected schedule.
         */
        async function confirmDeleteSchedule() {
            if (!isAdmin || !scheduleToDeleteId) return;
            
            const scheduleId = scheduleToDeleteId;
            scheduleToDeleteId = null; // Clear state
            
            try {
                const scheduleRef = doc(db, 'schedules', scheduleId);
                await deleteDoc(scheduleRef);
                
                console.log(`Schedule ${scheduleId} deleted.`);
                // The snapshot listener will automatically update the UI
                // and the selector will pick a new default.
                closeDeleteScheduleModal();
                
            } catch (error) {
                console.error("Error deleting schedule: ", error);
                alert("Error deleting schedule. See console.");
                closeDeleteScheduleModal();
            }
        }
        
        function closeDeleteScheduleModal() {
            scheduleToDeleteId = null;
            confirmDeleteModal.classList.add('hidden');
        }

        // --- Auth Functions ---

        /**
         * Handles the anonymous sign-in flow.
         */
        async function handleAnonymousSignIn() {
            try {
                statusElement.textContent = "Signing in...";
                await signInAnonymously(auth);
                // Auth state listener (setupAuthListener) will handle the rest
                welcomeOverlay.classList.add('hidden');
            } catch (e) {
                console.error("Anonymous sign-in failed:", e);
                statusElement.textContent = "Sign-in failed.";
            }
        }
        
        /**
         * Handles the Google sign-in flow.
         */
        async function handleGoogleSignIn() {
            try {
                statusElement.textContent = "Opening Google Sign-in...";
                // Use signInWithPopup for a better experience
                await signInWithPopup(auth, provider);
                // Auth state listener (setupAuthListener) will handle the rest
                welcomeOverlay.classList.add('hidden');
            } catch (e) {
                console.error("Google sign-in failed:", e);
                statusElement.textContent = "Google Sign-in failed.";
            }
        }
        
        /**
         * Handles user sign-out.
         */
        function handleSignOut() {
            signOut(auth).catch(e => console.error("Sign out failed:", e));
            // Auth state listener will reset the app
        }


        /**
         * Sets up the listener for authentication state changes.
         * This function controls the main app flow based on user status.
         */
        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                // Reset admin state on any change
                isAdmin = false;
                document.body.classList.remove('admin-mode');
                adminToggleBtn.classList.add('opacity-50', 'cursor-not-allowed');
                adminToggleBtn.disabled = true;
                adminToggleBtn.title = "Sign in to see admin options";

                if (user) {
                    // --- User is Signed In ---
                    currentUserId = user.uid;
                    
                    // Display user info
                    let userDisplay = user.isAnonymous ? `Anonymous (${user.uid.substring(0, 6)})` : (user.email || user.displayName);
                    userIdElement.textContent = `Signed in as: ${userDisplay}`;
                    signoutBtn.classList.remove('hidden');
                    
                    // Show audio overlay if needed (on refresh)
                    if (isAppInitialized && !isAudioStarted) {
                        audioOverlay.classList.remove('hidden');
                    }
                    welcomeOverlay.classList.add('hidden'); // Ensure welcome is hidden
                    
                    statusElement.textContent = "Loading schedules...";

                    // Check for admin privileges
                    try {
                        const adminDoc = await getDoc(doc(db, 'admins', user.uid));
                        if (adminDoc.exists()) {
                            isAdmin = true;
                            adminToggleBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                            adminToggleBtn.disabled = false;
                            adminToggleBtn.title = "Toggle Admin Controls";
                            // Note: Admin mode is not turned on by default
                            console.log("User is an admin.");
                        }
                    } catch (e) {
                        console.error("Error checking admin status:", e);
                    }
                    
                    // User is authenticated, initialize Firestore listeners
                    initializeFirestoreListeners();
                    
                } else {
                    // --- User is Signed Out ---
                    currentUserId = null;
                    isAdmin = false;
                    
                    // Reset UI
                    userIdElement.textContent = "Not signed in.";
                    signoutBtn.classList.add('hidden');
                    welcomeOverlay.classList.remove('hidden'); // Show sign-in
                    audioOverlay.classList.add('hidden'); // Hide audio prompt
                    
                    statusElement.textContent = "Please sign in.";
                    
                    // Clear all schedule data
                    sharedSchedules = {};
                    currentSharedScheduleId = null;
                    populateScheduleSelector(); // Will show "Loading..." or be empty
                    updateAndRenderCombinedList(); // Will clear the list
                }
                
                // Mark that the initial auth check is done
                isAppInitialized = true;
            });
        }
        
        /**
         * Toggles the admin UI visibility.
         */
        function toggleAdminMode() {
            if (!isAdmin) return;
            document.body.classList.toggle('admin-mode');
            if (document.body.classList.contains('admin-mode')) {
                adminToggleBtn.textContent = 'Admin Mode: ON';
                adminToggleBtn.classList.add('bg-blue-600', 'text-white');
            } else {
                adminToggleBtn.textContent = 'Toggle Admin';
                adminToggleBtn.classList.remove('bg-blue-600', 'text-white');
            }
        }

        // --- Firestore Listeners ---
        let allSchedulesUnsubscribe = null; // To hold the unsubscribe function

        /**
         * Initializes the main Firestore snapshot listener for all schedules.
         */
        function initializeFirestoreListeners() {
            // Unsubscribe from previous listener if it exists
            if (allSchedulesUnsubscribe) {
                allSchedulesUnsubscribe();
            }
            
            statusElement.textContent = "Syncing schedules...";
            const schedulesCollection = collection(db, 'schedules');
            
            allSchedulesUnsubscribe = onSnapshot(schedulesCollection, (snapshot) => {
                console.log("Received schedules snapshot update.");
                const newSchedules = {};
                snapshot.forEach(doc => {
                    newSchedules[doc.id] = { id: doc.id, ...doc.data() };
                });
                
                sharedSchedules = newSchedules;
                statusElement.textContent = "Schedules synced.";
                
                // Repopulate selector and update list
                populateScheduleSelector();
                
            }, (error) => {
                console.error("Error listening to schedules: ", error);
                statusElement.textContent = "Error syncing schedules.";
            });
        }
        
        // --- Modal Opening/Closing Functions ---

        /**
         * Opens the "Add Bell to Multiple Schedules" modal.
         */
        function openAddBellModal() {
            // Populate the list of schedules
            multiScheduleListContainer.innerHTML = ''; // Clear
            
            const sortedSchedules = Object.values(sharedSchedules).sort((a, b) => a.name.localeCompare(b.name));
            
            if (sortedSchedules.length === 0) {
                 multiScheduleListContainer.innerHTML = '<p class="text-gray-500">No schedules found. Create one first.</p>';
            }
            
            sortedSchedules.forEach(schedule => {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-100 cursor-pointer';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = schedule.id;
                checkbox.className = 'rounded text-blue-600 focus:ring-blue-500';
                
                // Pre-check the *current* schedule
                if (schedule.id === currentSharedScheduleId) {
                    checkbox.checked = true;
                }
                
                const span = document.createElement('span');
                span.textContent = schedule.name;
                
                label.appendChild(checkbox);
                label.appendChild(span);
                multiScheduleListContainer.appendChild(label);
            });
            
            addBellModal.classList.remove('hidden');
        }
        
        function closeAddBellModal() {
            addBellModal.classList.add('hidden');
            multiAddBellForm.reset();
            multiAddStatus.classList.add('hidden');
        }
        
        /**
         * Opens the "Edit Bell" modal and pre-fills it.
         * @param {Object} bell - The bell object to edit.
         */
        function openEditBellModal(bell) {
            editingBell = bell; // Store the bell being edited
            
            editBellTimeInput.value = bell.time;
            editBellNameInput.value = bell.name;
            editBellSoundInput.value = bell.sound;
            
            editBellModal.classList.remove('hidden');
        }
        
        function closeEditBellModal() {
            editBellModal.classList.add('hidden');
            editBellForm.reset();
            editBellStatus.classList.add('hidden');
            editBellSubmitBtn.disabled = false;
            editingBell = null;
        }

        /**
         * Opens the "Confirm Linked Edit" modal.
         * @param {Array} linkedSchedules - Array of {id, name} objects.
         * @param {Object} updatedBellData - The new data to apply.
         */
        function openConfirmLinkedEditModal(linkedSchedules, updatedBellData) {
            // Populate the list
            linkedScheduleList.innerHTML = linkedSchedules.map(schedule => `
                <label class="flex items-center space-x-2 p-2 rounded-lg bg-gray-100 cursor-pointer">
                    <input type="checkbox" value="${schedule.id}" class="rounded text-blue-600 focus:ring-blue-500" checked>
                    <span>${schedule.name}</span>
                </label>
            `).join('');
            
            confirmLinkedEditModal.classList.remove('hidden');
            
            // --- Attach temporary listeners for this modal ---
            // We remove them on close to avoid memory leaks
            
            const onApply = async () => {
                linkedEditStatus.textContent = "Applying changes...";
                linkedEditStatus.classList.remove('hidden');
                
                const selectedCheckboxes = linkedScheduleList.querySelectorAll('input[type="checkbox"]:checked');
                const selectedScheduleIds = [...selectedCheckboxes].map(cb => cb.value);
                
                // We need to find the *original* bell ID for each selected schedule
                const batch = writeBatch(db);
                let updates = 0;
                
                for (const scheduleId of selectedScheduleIds) {
                    const schedule = sharedSchedules[scheduleId];
                    // Find the bell in this schedule that matches the *original* editingBell
                    const bellToUpdate = schedule.bells.find(b => 
                        b.time === editingBell.time && 
                        b.name === editingBell.name && 
                        b.sound === editingBell.sound
                    );
                    
                    if (bellToUpdate) {
                        // Create the new bell object, preserving its original unique ID
                        const finalUpdatedBell = { ...updatedBellData, id: bellToUpdate.id };
                        
                        // Create a new bells array for the schedule
                        const newBellsArray = schedule.bells.map(b => 
                            b.id === bellToUpdate.id ? finalUpdatedBell : b
                        );
                        
                        const scheduleRef = doc(db, 'schedules', scheduleId);
                        batch.update(scheduleRef, { bells: newBellsArray });
                        updates++;
                    }
                }
                
                try {
                    await batch.commit();
                    linkedEditStatus.textContent = `Updated bell in ${updates} schedules.`;
                    setTimeout(closeConfirmLinkedEditModal, 1500);
                } catch (error) {
                    console.error("Error applying linked edit:", error);
                    linkedEditStatus.textContent = "Error. See console.";
                }
            };
            
            const onThisOnly = async () => {
                linkedEditStatus.textContent = "Applying to this schedule only...";
                linkedEditStatus.classList.remove('hidden');
                
                // This is the "break link" option.
                // We just update the bell in the *current* schedule.
                // It will now be out of sync with the others.
                try {
                    // We need to find the bell in the *current* schedule that matches
                    // the *original* editingBell data, and update it.
                    // But we already have its ID in editingBell.id
                    const finalUpdatedBell = { ...updatedBellData, id: editingBell.id };
                    await updateSharedBellInSchedule(currentSharedScheduleId, finalUpdatedBell);
                    
                    linkedEditStatus.textContent = "Saved!";
                    setTimeout(closeConfirmLinkedEditModal, 1500);
                } catch (error) {
                    console.error("Error applying single edit:", error);
                    linkedEditStatus.textContent = "Error. See console.";
                }
            };
            
            linkedEditApplyBtn.onclick = onApply;
            linkedEditThisOnlyBtn.onclick = onThisOnly;
        }
        
        function closeConfirmLinkedEditModal() {
            confirmLinkedEditModal.classList.add('hidden');
            linkedEditStatus.classList.add('hidden');
            
            // Clean up listeners
            linkedEditApplyBtn.onclick = null;
            linkedEditThisOnlyBtn.onclick = null;
            
            // Close the main edit modal too
            closeEditBellModal();
        }

        /**
         * Opens the "Delete Bell" confirmation modal.
         * @param {Object} bell - The bell object to delete.
         */
        function openDeleteBellModal(bell) {
            bellToDelete = bell;
            confirmDeleteBellText.textContent = `Are you sure you want to delete the bell "${bell.name}" at ${bell.time}?`;
            confirmDeleteBellModal.classList.remove('hidden');
        }
        
        function closeDeleteBellModal() {
            bellToDelete = null;
            confirmDeleteBellModal.classList.add('hidden');
        }
        
        /**
         * Confirms and proceeds with bell deletion.
         */
        function confirmDeleteBell() {
            if (bellToDelete) {
                deleteBell(bellToDelete);
            }
            closeDeleteBellModal();
        }
        
        // --- Backup & Restore (Import/Export) ---
        
        /**
         * Exports all shared schedules to a JSON file.
         */
        function exportSchedules() {
            if (!isAdmin) {
                alert("Admin only.");
                return;
            }
            
            try {
                // Create a clean export object
                const exportData = {
                    version: 1,
                    exportedAt: new Date().toISOString(),
                    schedules: { ...sharedSchedules }
                };
                
                const dataStr = JSON.stringify(exportData, null, 2); // Pretty-print JSON
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `school_bell_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
            } catch (error) {
                console.error("Error exporting schedules:", error);
                alert("Error exporting schedules. See console.");
            }
        }
        
        /**
         * Triggers the file input for importing.
         */
        function triggerImport() {
            if (!isAdmin) {
                alert("Admin only.");
                return;
            }
            importFileInput.click();
        }

        /**
         * Handles the file selection for import.
         * @param {Event} e - The file input change event.
         */
        function handleImportFile(e) {
            const file = e.target.files[0];
            if (!file) {
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const importData = JSON.parse(event.target.result);
                    if (!importData.schedules || typeof importData.schedules !== 'object') {
                        throw new Error("Invalid backup file format. Missing 'schedules' object.");
                    }
                    
                    if (!confirm("This will OVERWRITE all existing schedules. Are you sure?")) {
                        importStatus.textContent = "Import cancelled.";
                        importFileInput.value = ''; // Reset file input
                        return;
                    }
                    
                    importStatus.textContent = "Importing... Please wait.";
                    importStatus.classList.remove('hidden');

                    // --- Process the import ---
                    // 1. Delete all existing schedules
                    const batchDelete = writeBatch(db);
                    for (const scheduleId in sharedSchedules) {
                        batchDelete.delete(doc(db, 'schedules', scheduleId));
                    }
                    await batchDelete.commit();
                    
                    // 2. Add all new schedules
                    const batchAdd = writeBatch(db);
                    const importedSchedules = importData.schedules;
                    
                    for (const scheduleId in importedSchedules) {
                        const scheduleData = importedSchedules[scheduleId];
                        // IMPORTANT: Use the *original* ID from the backup file
                        const scheduleRef = doc(db, 'schedules', scheduleId);
                        // Clean data just in case, ensure 'id' field is removed if it exists
                        // The 'id' is the document key, not a field.
                        const { id, ...dataToSave } = scheduleData; 
                        batchAdd.set(scheduleRef, dataToSave);
                    }
                    await batchAdd.commit();
                    
                    importStatus.textContent = "Import successful! Schedules overwritten.";
                    
                } catch (error) {
                    console.error("Error importing schedules:", error);
                    importStatus.textContent = `Error: ${error.message}`;
                } finally {
                    importFileInput.value = ''; // Reset file input
                }
            };
            reader.readAsText(file);
        }


        // --- Initialization ---

        /**
         * Main initialization function to set up the app.
         */
        function initializeAppLogic() {
            console.log("Initializing app logic...");
            
            // Start the clock/countdown loop
            requestAnimationFrame(updateCountdown);

            // Load persistent data
            loadCustomBells();
            loadMutedBells(); // NEW: Load mute state

            // Set up event listeners
            setupAuthListener();
            setupBellListListeners();
            
            // Auth buttons
            googleStartBtn.addEventListener('click', handleGoogleSignIn);
            anonymousStartBtn.addEventListener('click', handleAnonymousSignIn);
            signoutBtn.addEventListener('click', handleSignOut);
            
            // Audio start
            startAudioBtn.addEventListener('click', startAudioContext);
            
            // Schedule selector
            scheduleSelector.addEventListener('change', updateActiveSchedule);
            
            // Custom Bell form
            addCustomBellForm.addEventListener('submit', handleAddCustomBell);
            previewCustomSoundBtn.addEventListener('click', () => previewSound(customSoundInput));

            // Admin: Toggle
            adminToggleBtn.addEventListener('click', toggleAdminMode);

            // Admin: Create Schedule
            createScheduleForm.addEventListener('submit', handleCreateSchedule);
            
            // Admin: Add Shared Bell
            addSharedBellForm.addEventListener('submit', handleAddSharedBell);
            previewSharedSoundBtn.addEventListener('click', () => previewSound(sharedSoundInput));
            
            // Admin: Delete Schedule
            deleteScheduleBtn.addEventListener('click', openDeleteScheduleModal);
            deleteCancelBtn.addEventListener('click', closeDeleteScheduleModal);
            deleteConfirmBtn.addEventListener('click', confirmDeleteSchedule);
            
            // Admin: Delete Bell
            deleteBellCancelBtn.addEventListener('click', closeDeleteBellModal);
            deleteBellConfirmBtn.addEventListener('click', confirmDeleteBell);

            // Admin: Add Bell to Schedules (Multi)
            showAddBellModalBtn.addEventListener('click', openAddBellModal);
            multiAddCancelBtn.addEventListener('click', closeAddBellModal);
            multiAddBellForm.addEventListener('submit', handleMultiAddBell);
            multiSelectAllBtn.addEventListener('click', () => {
                multiScheduleListContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
            });
            multiSelectNoneBtn.addEventListener('click', () => {
                multiScheduleListContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            });

            // Admin: Edit Bell
            editBellForm.addEventListener('submit', handleEditBell);
            editBellCancelBtn.addEventListener('click', closeEditBellModal);
            
            // Admin: Linked Edit
            linkedEditCancelBtn.addEventListener('click', closeConfirmLinkedEditModal);
            // The Apply/ThisOnly buttons are set up when the modal opens

            // Admin: Import/Export
            exportSchedulesBtn.addEventListener('click', exportSchedules);
            importSchedulesBtn.addEventListener('click', triggerImport);
            importFileInput.addEventListener('change', handleImportFile);
            
            // NEW: Mute All Toggle Listener
            muteAllToggle.addEventListener('change', () => {
                const shouldMute = muteAllToggle.checked;
                
                // Get all bell IDs *currently visible* in the list
                const visibleBellIds = [...combinedBellListElement.querySelectorAll('.bell-mute-toggle')].map(cb => cb.dataset.bellId);

                // Update the Set
                visibleBellIds.forEach(bellId => {
                    if (shouldMute) {
                        mutedBellIds.add(bellId);
                    } else {
                        mutedBellIds.delete(bellId);
                    }
                });
                saveMuteState(); // Save to localStorage
                
                // Update the UI checkboxes
                combinedBellListElement.querySelectorAll('.bell-mute-toggle').forEach(checkbox => {
                    checkbox.checked = shouldMute;
                });
                
                // Re-set the master toggle state (removes indeterminate state)
                updateMuteAllToggleState(); 
                // Refresh countdown to show new mute status
                updateCountdown(); 
            });
            
            // DELETED: Old Mute Button Listeners
        }

        // --- Start the App ---
        // We wrap the init in a DOMContentLoaded just to be safe,
        // although 'module' scripts often defer by default.
        document.addEventListener('DOMContentLoaded', initializeAppLogic);

    </script>
</body>
</html>
