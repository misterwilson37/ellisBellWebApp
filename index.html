<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Bell Web App</title>
    <!-- Using Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Using Tone.js for web audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        // Use Century Gothic, with Questrial as a web-safe fallback
                        sans: ['Century Gothic', 'Questrial', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <!-- Updated Google Font to include Questrial as a Century Gothic fallback -->
    <link href="https://fonts.googleapis.com/css2?family=Questrial&display=swap" rel="stylesheet">
    <style>
        body {
            /* Apply the new font stack */
            font-family: 'Century Gothic', 'Questrial', 'sans-serif';
        }
        /* Styles for Admin Controls */
        /* Hide admin controls and shared delete/edit buttons by default */
        .admin-control, #combined-bell-list .delete-btn, #combined-bell-list .edit-btn {
            display: none;
        }
        /* When body has .admin-mode, show them */
        body.admin-mode .admin-control {
            display: block; 
        }
        /* Show shared delete/edit buttons in admin mode */
        body.admin-mode #combined-bell-list .delete-btn,
        body.admin-mode #combined-bell-list .edit-btn {
            display: inline-block;
        }
        /* Always show custom delete/edit buttons */
        #combined-bell-list .delete-custom-btn,
        #combined-bell-list .edit-custom-btn {
            display: inline-block;
        }
        /* Fix for modal z-index issues */
        #edit-bell-modal { z-index: 50; }
        #confirm-linked-edit-modal { z-index: 60; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans"> <!-- Added font-sans to apply tailwind default -->

    <!-- Audio Start Overlay -->
    <div id="audio-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <button id="start-audio-btn" class="px-8 py-4 bg-blue-600 text-white font-bold text-2xl rounded-lg shadow-lg hover:bg-blue-700 transition-colors">
            Click to Start School Bell
        </button>
    </div>

    <!-- Admin Password Modal -->
    <div id="admin-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-medium mb-4">Admin Access</h3>
            <label for="admin-password" class="block text-sm font-medium text-gray-700">Password</label>
            <input type="password" id="admin-password" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <p id="admin-error" class="text-red-500 text-sm mt-2 hidden">Incorrect password.</p>
            <div class="mt-6 flex justify-end gap-3">
                <button id="admin-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="admin-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Login</button>
            </div>
        </div>
    </div>

    <!-- NEW: Add Bell to Multiple Schedules Modal -->
    <div id="add-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 hidden">
        <form id="multi-add-bell-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-medium mb-6">Add Bell to Schedules</h3>
            
            <!-- Bell Details -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="multi-bell-time" class="block text-sm font-medium text-gray-700">Time (HH:MM:SS)</label>
                    <input type="time" id="multi-bell-time" step="1" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="multi-bell-name" class="block text-sm font-medium text-gray-700">Bell Name</label>
                    <input type="text" id="multi-bell-name" placeholder="e.g. 1st Period End" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div>
                <label for="multi-bell-sound" class="block text-sm font-medium text-gray-700">Sound</label>
                <select id="multi-bell-sound" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="Bell">Bell</option>
                    <option value="Chime">Chime</option>
                    <option value="Beep">Beep</option>
                    <option value="Alarm">Alarm</option>
                    <!-- <option value="ellisBell.mp3">Ellis Bell</option> <-- Removed, external file -->
                </select>
            </div>

            <!-- Schedule Checkboxes -->
            <div class="mt-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Schedules to Add to:</label>
                <div id="multi-schedule-list-container" class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4 grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <!-- Checkboxes will be dynamically injected here -->
                    <p class="text-gray-500">Loading schedules...</p>
                </div>
            </div>
            
            <p id="multi-add-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="multi-add-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" id="multi-add-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Bell</button>
            </div>
        </form>
    </div>

    <!-- NEW: Edit Bell Modal -->
    <div id="edit-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <form id="edit-bell-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-medium mb-6">Edit Bell</h3>
            
            <!-- Bell Details -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="edit-bell-time" class="block text-sm font-medium text-gray-700">Time (HH:MM:SS)</label>
                    <input type="time" id="edit-bell-time" step="1" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="edit-bell-name" class="block text-sm font-medium text-gray-700">Bell Name</label>
                    <input type="text" id="edit-bell-name" placeholder="e.g. 1st Period End" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div>
                <label for="edit-bell-sound" class="block text-sm font-medium text-gray-700">Sound</label>
                <select id="edit-bell-sound" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="Bell">Bell</option>
                    <option value="Chime">Chime</option>
                    <option value="Beep">Beep</option>
                    <option value="Alarm">Alarm</option>
                    <!-- <option value="ellisBell.mp3">Ellis Bell</option> <-- Removed, external file -->
                </select>
            </div>
            
            <p id="edit-bell-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="edit-bell-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" id="edit-bell-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
            </div>
        </form>
    </div>

    <!-- NEW: Confirm Linked Edit Modal -->
    <div id="confirm-linked-edit-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-xl font-medium mb-4">Update Linked Schedules?</h3>
            <p class="text-gray-700 mb-4">This bell was found in other schedules. Do you want to apply your edit to them as well?</p>
            
            <p class="text-sm font-medium text-gray-700 mb-2">Schedules containing this bell:</p>
            <div id="linked-schedule-list" class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4 grid grid-cols-1 sm:grid-cols-2 gap-2">
                <!-- Linked schedules will be injected here -->
            </div>
            
            <p id="linked-edit-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <div class="mt-6 flex flex-col sm:flex-row justify-end gap-3">
                <button type="button" id="linked-edit-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="linked-edit-this-only" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">Update This Schedule Only</button>
                <button type="button" id="linked-edit-apply" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Apply to All Selected</button>
            </div>
        </div>
    </div>


    <!-- NEW: Confirm Delete Schedule Modal -->
    <div id="confirm-delete-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-medium mb-4">Delete Schedule</h3>
            <p id="confirm-delete-text" class="text-gray-700 mb-6">Are you sure you want to delete this schedule? This action cannot be undone.</p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="delete-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="delete-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="container mx-auto max-w-2xl p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-700">School Bell</h1>
            <p class="text-lg text-gray-600">A real-time, synchronized bell schedule</p>
            <p class="text-sm text-gray-500 mt-2">Your User ID (for reference): <code id="userIdDisplay" class="bg-gray-200 px-2 py-1 rounded">...</code></p>
        </header>

        <!-- Live Clock -->
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-md mb-8">
            <div id="live-clock" class="text-6xl md:text-8xl font-bold text-center text-gray-800 tabular-nums">
                00:00:00
            </div>
            <div class="text-center text-gray-500 text-lg mt-2">
                Status: <span id="status-message" class="font-medium text-gray-700">Initializing...</span>
            </div>
            <div class="text-center text-gray-500 text-sm mt-1">
                Next Bell: <span id="next-bell-message" class="font-medium text-gray-700">--:--</span>
            </div>
        </div>

        <!-- Combined Bell Schedule List -->
        <div>
            <h2 id="schedule-title" class="text-2xl font-semibold mb-4">Current Schedule</h2>
            <div id="combined-bell-list" class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
                <!-- Bells will be injected here by JavaScript -->
                <div class="p-8 text-center text-gray-500">
                    Loading schedule...
                </div>
            </div>
        </div>

        <!-- Schedule Selector -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <div class="flex justify-between items-center mb-2">
                <label for="schedule-selector" class="block text-lg font-medium text-gray-700">Active Shared Schedule</label>
                <button id="admin-toggle" class="px-3 py-1 text-sm bg-gray-200 text-gray-800 rounded-full hover:bg-gray-300 transition-colors">
                    Toggle Admin
                </button>
            </div>
            <select id="schedule-selector" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg">
                <option value="">Loading schedules...</option>
            </select>
            
            <!-- NEW: Admin button to delete the selected schedule -->
            <!-- MOVED this button to the main Admin Zone below -->
        </div>
        
        <!-- NEW: Admin Zone for creating schedules and adding bells -->
        <div class="admin-control bg-white p-6 rounded-xl shadow-md mb-8 space-y-6">
            <h3 class="text-xl font-semibold text-gray-800 border-b pb-2">Admin Zone</h3>
            
            <!-- Create New Schedule Form -->
            <form id="create-schedule-form">
                <label for="new-schedule-name" class="block text-sm font-medium text-gray-700 mb-1">Create New Schedule</label>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="new-schedule-name" placeholder="New Schedule Name" required class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700">
                        Create
                    </button>
                </div>
            </form>

            <!-- NEW: Add Bell to THIS Schedule Form -->
            <form id="add-shared-bell-form" class="border-t pt-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Add Bell to This Schedule</label>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="shared-bell-time" class="block text-sm font-medium text-gray-700 mb-1">Time (HH:MM:SS)</label>
                        <input type="time" id="shared-bell-time" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="shared-bell-name" class="block text-sm font-medium text-gray-700 mb-1">Bell Name</label>
                        <input type="text" id="shared-bell-name" placeholder="e.g. 1st Period Start" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-end gap-4">
                    <div class="flex-grow" style="min-width: 120px;">
                        <label for="shared-bell-sound" class="block text-sm font-medium text-gray-700 mb-1">Sound</label>
                        <select id="shared-bell-sound" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Bell">Bell</option>
                            <option value="Chime">Chime</option>
                            <option value="Beep">Beep</option>
                            <option value="Alarm">Alarm</option>
                            <!-- <option value="ellisBell.mp3">Ellis Bell</option> <-- Removed, external file -->
                        </select>
                    </div>
                    <button type="button" id="preview-shared-sound" class="px-4 py-2 text-2xl bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview sound">
                        ▶
                    </button>
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Add Shared Bell
                    </button>
                </div>
                <p id="add-shared-status" class="text-blue-600 text-sm mt-3 hidden"></p>
            </form>

            <!-- Add Bell to Schedules Button -->
            <div class="border-t pt-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Add Bell to Multiple Schedules</label>
                <button type="button" id="show-add-bell-modal-btn" class="w-full px-6 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700">
                    Add Bell to Schedules...
                </button>
            </div>

            <!-- MOVED: Delete Selected Schedule Button -->
            <div class="border-t pt-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Delete Current Schedule</label>
                <button type="button" id="delete-schedule-btn" class="w-full px-4 py-2 bg-red-600 text-white font-medium rounded-lg shadow-md hover:bg-red-700 transition-colors">
                    Delete Selected Schedule
                </button>
            </div>
        </div>


        <!-- Custom Bells (Local) -->
        <div class="mt-12">
            <h2 class="text-2xl font-semibold mb-4">My Custom Bells (This Browser Only)</h2>

            <!-- Add Custom Bell Form -->
            <form id="add-custom-bell-form" class="bg-white p-6 rounded-xl shadow-md mb-8">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="custom-bell-time" class="block text-sm font-medium text-gray-700 mb-1">Time (HH:MM:SS)</label>
                        <input type="time" id="custom-bell-time" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <!-- NEW: Custom Bell Name -->
                    <div>
                        <label for="custom-bell-name" class="block text-sm font-medium text-gray-700 mb-1">Bell Name</label>
                        <input type="text" id="custom-bell-name" placeholder="e.g. My Reminder" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-end gap-4">
                    <div class="flex-grow" style="min-width: 120px;">
                        <label for="custom-bell-sound" class="block text-sm font-medium text-gray-700 mb-1">Sound</label>
                        <select id="custom-bell-sound" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Bell">Bell</option>
                            <option value="Chime">Chime</option>
                            <option value="Beep">Beep</option>
                            <option value="Alarm">Alarm</option>
                            <!-- <option value="ellisBell.mp3">Ellis Bell</option> <-- Removed, external file -->
                        </select>
                    </div>
                    <button type="button" id="preview-custom-sound" class="px-4 py-2 text-2xl bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview sound">
                        ▶
                    </button>
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Add Custom Bell
                    </button>
                </div>
            </form>
        </div>

    </div>

        <!-- Firebase and App Logic -->
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js"; // Not used
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, getDocs, writeBatch, setLogLevel, deleteDoc, getDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Elements ---
        const audioOverlay = document.getElementById('audio-overlay');
        const startAudioBtn = document.getElementById('start-audio-btn');
        const clockElement = document.getElementById('live-clock');
        const statusElement = document.getElementById('status-message');
        const nextBellElement = document.getElementById('next-bell-message');
        const userIdElement = document.getElementById('userIdDisplay');
        const scheduleSelector = document.getElementById('schedule-selector');
        const scheduleTitle = document.getElementById('schedule-title');
        const adminToggleBtn = document.getElementById('admin-toggle');
        const adminModal = document.getElementById('admin-modal');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminSubmitBtn = document.getElementById('admin-submit');
        const adminCancelBtn = document.getElementById('admin-cancel');
        const adminError = document.getElementById('admin-error');
        
        // Custom Bell Form
        const addCustomBellForm = document.getElementById('add-custom-bell-form');
        const customTimeInput = document.getElementById('custom-bell-time');
        const customNameInput = document.getElementById('custom-bell-name'); // New
        const customSoundInput = document.getElementById('custom-bell-sound');
        
        // NEW: Add Shared Bell Form (in Admin Zone)
        const addSharedBellForm = document.getElementById('add-shared-bell-form');
        const sharedTimeInput = document.getElementById('shared-bell-time');
        const sharedNameInput = document.getElementById('shared-bell-name');
        const sharedSoundInput = document.getElementById('shared-bell-sound');
        const previewSharedSoundBtn = document.getElementById('preview-shared-sound');
        const addSharedStatus = document.getElementById('add-shared-status');

        // Combined List
        const combinedBellListElement = document.getElementById('combined-bell-list');
        const previewCustomSoundBtn = document.getElementById('preview-custom-sound');
        
        // NEW: Multi-Add Bell Modal
        const addBellModal = document.getElementById('add-bell-modal');
        const showAddBellModalBtn = document.getElementById('show-add-bell-modal-btn');
        const multiAddBellForm = document.getElementById('multi-add-bell-form');
        const multiBellTimeInput = document.getElementById('multi-bell-time');
        const multiBellNameInput = document.getElementById('multi-bell-name');
        const multiBellSoundInput = document.getElementById('multi-bell-sound');
        const multiScheduleListContainer = document.getElementById('multi-schedule-list-container');
        const multiAddCancelBtn = document.getElementById('multi-add-cancel');
        const multiAddSubmitBtn = document.getElementById('multi-add-submit');
        const multiAddStatus = document.getElementById('multi-add-status');

        // NEW: Edit Bell Modal
        const editBellModal = document.getElementById('edit-bell-modal');
        const editBellForm = document.getElementById('edit-bell-form');
        const editBellTimeInput = document.getElementById('edit-bell-time');
        const editBellNameInput = document.getElementById('edit-bell-name');
        const editBellSoundInput = document.getElementById('edit-bell-sound');
        const editBellCancelBtn = document.getElementById('edit-bell-cancel');
        const editBellSubmitBtn = document.getElementById('edit-bell-submit');
        const editBellStatus = document.getElementById('edit-bell-status');

        // NEW: Linked Edit Modal
        const confirmLinkedEditModal = document.getElementById('confirm-linked-edit-modal');
        const linkedScheduleList = document.getElementById('linked-schedule-list');
        const linkedEditStatus = document.getElementById('linked-edit-status');
        const linkedEditCancel = document.getElementById('linked-edit-cancel');
        const linkedEditThisOnly = document.getElementById('linked-edit-this-only');
        const linkedEditApply = document.getElementById('linked-edit-apply');

        // NEW: Create/Delete Schedule
        const createScheduleForm = document.getElementById('create-schedule-form');
        const newScheduleNameInput = document.getElementById('new-schedule-name');
        const deleteScheduleBtn = document.getElementById('delete-schedule-btn');
        const confirmDeleteModal = document.getElementById('confirm-delete-modal');
        const confirmDeleteText = document.getElementById('confirm-delete-text');
        const deleteConfirmBtn = document.getElementById('delete-confirm');
        const deleteCancelBtn = document.getElementById('delete-cancel'); // Added for completeness

        // --- App State ---
        let db, auth;
        let userId;
        // BELLS ARE NOW { time, name, sound }
        let localSchedule = []; // Holds array of SHARED bells
        let customBells = []; // Holds array of CUSTOM bells
        let scheduleRef; // Firestore document reference TO THE ACTIVE SCHEDULE
        let schedulesCollectionRef; // Reference to the collection of all schedules
        let allSchedules = []; // Array of { id, name, bells: [] }
        let activeScheduleId = null;
        let activeScheduleListenerUnsubscribe = null; // Function to stop listening to old schedule
        let synths = {}; // To hold Tone.js synthesizers
        let lastBellRingTime = null; // To prevent duplicate rings
        
        // NEW: State for editing bells
        let currentEditingBell = null; // Stores { time, name, sound, type, originalTime, originalName } of the bell being edited
        let linkedEditData = null; // Stores data for the linked edit confirmation

        // FIXED: Use the dynamic appId from the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Default Schedules (for seeding) ---
        // This is no longer used for seeding, but as a reference. Seeding is complex in a multi-user env.
        const SCHEDULE_DEFAULTS = [
            { id: "6th-grade-a", name: "6th Grade A" },
            { id: "6th-grade-b", name: "6th Grade B" },
            { id: "7th-grade-a", name: "7th Grade A" },
            { id: "7th-grade-b", name: "7th Grade B" },
            { id: "8th-grade", name: "8th Grade" },
            { id: "related-arts-a", name: "Related Arts A" },
            { id: "related-arts-b", name: "Related Arts B" },
        ];

        // --- Audio Setup (Tone.js) ---
        function setupSynths() {
            // Using .toDestination() connects the synth to the speakers
            synths['Bell'] = new Tone.MetalSynth({
                frequency: 200,
                envelope: { attack: 0.001, decay: 0.4, release: 0.2 },
                harmonicity: 5.1,
                modulationIndex: 32,
                resonance: 4000,
                octaves: 1.5
            }).toDestination();

            synths['Chime'] = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 1 }
            }).toDestination();

            synths['Beep'] = new Tone.Synth({
                oscillator: { type: 'square' },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.05 }
            }).toDestination();

            synths['Alarm'] = new Tone.MonoSynth({
                oscillator: { type: "sine" },
                envelope: { attack: 0.1, decay: 0.2, release: 0.1 }
            }).toDestination();
            
            // FIXED: Removed 'ellisBell.mp3' as it's an external file
            // synths['ellisBell.mp3'] = new Tone.Player("ellisBell.mp3").toDestination();
        }

        function playBell(soundName) {
            if (!synths[soundName]) {
                console.warn(`Sound '${soundName}' not found.`);
                return;
            }

            const now = Tone.now();
            const synth = synths[soundName];

            try {
                if (synth instanceof Tone.Player) {
                    synth.start(now);
                } else {
                    if (soundName === 'Bell') {
                        synth.triggerAttackRelease('C4', '0.5', now);
                        synth.triggerAttackRelease('G4', '0.5', now + 0.3);
                    } else if (soundName === 'Chime') {
                        synth.triggerAttackRelease('G5', '0.8', now);
                        synth.triggerAttackRelease('E6', '0.8', now + 0.5);
                    } else if (soundName === 'Beep') {
                        synth.triggerAttackRelease('A5', '0.1', now);
                    } else if (soundName === 'Alarm') {
                        synth.triggerAttackRelease("C5", "0.1", now);
                        synth.triggerAttackRelease("C5", "0.1", now + 0.15);
                        synth.triggerAttackRelease("C5", "0.1", now + 0.3);
                    }
                }
                statusElement.textContent = `Previewing: ${soundName}`;
            } catch (error) {
                console.error("Error playing sound:", error);
            }
        }

        // --- Clock and Bell Logic ---
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            const currentTimeHHMMSS = `${hours}:${minutes}:${seconds}`;

            clockElement.textContent = currentTimeHHMMSS;

            // Check if a bell should ring
            const allBells = [...localSchedule, ...customBells];
            const bellToRing = allBells.find(bell => bell.time === currentTimeHHMMSS);
            
            if (bellToRing && lastBellRingTime !== currentTimeHHMMSS) {
                // Use a different function for actual ringing to not say "Previewing"
                ringBell(bellToRing); // Pass the whole bell object
                lastBellRingTime = currentTimeHHMMSS;
            }
            
            if (lastBellRingTime && lastBellRingTime !== currentTimeHHMMSS) {
                lastBellRingTime = null;
                statusElement.textContent = "Monitoring...";
            }

            // Update next bell time
            updateNextBellMessage(currentTimeHHMMSS);

            requestAnimationFrame(updateClock); // Loop
        }
        
        // * This was the truncated function. Now completed. *
        function ringBell(bell) {
            console.log("Ringing bell:", bell.name);
            playBell(bell.sound);
            statusElement.textContent = `Ringing: ${bell.name}`;
            
            // Highlight the bell in the list
            const bellElement = document.querySelector(`[data-time="${bell.time}"][data-name="${bell.name}"]`);
            if (bellElement) {
                bellElement.classList.add('bg-blue-100');
                setTimeout(() => {
                    bellElement.classList.remove('bg-blue-100');
                }, 3000); // Remove highlight after 3 seconds
            }
        }

        function updateNextBellMessage(currentTimeHHMMSS) {
            const allBells = [...localSchedule, ...customBells];
            
            // Filter for bells that are in the future *today*
            let upcomingBells = allBells.filter(bell => bell.time > currentTimeHHMMSS);
            
            let nextBell;
            if (upcomingBells.length > 0) {
                // Sort upcoming bells and take the soonest one
                upcomingBells.sort((a, b) => a.time.localeCompare(b.time));
                nextBell = upcomingBells[0];
            } else {
                // If no bells are left today, find the *first* bell of "tomorrow"
                allBells.sort((a, b) => a.time.localeCompare(b.time));
                nextBell = allBells[0]; // This will be the first bell in the sorted list
            }

            if (nextBell) {
                nextBellElement.textContent = `${nextBell.name} at ${nextBell.time}`;
            } else {
                nextBellElement.textContent = "No bells scheduled";
            }
        }

        // --- Render Functions ---
        function renderCombinedList() {
            const allBells = [...localSchedule, ...customBells];
            allBells.sort((a, b) => a.time.localeCompare(b.time));

            if (allBells.length === 0) {
                combinedBellListElement.innerHTML = `<div class="p-8 text-center text-gray-500">No bells scheduled for this day.</div>`;
                return;
            }

            combinedBellListElement.innerHTML = allBells.map((bell, index) => {
                const isCustom = bell.type === 'custom';
                const isFirst = index === 0;
                const isAdmin = document.body.classList.contains('admin-mode');

                // Determine which buttons to show
                const showSharedEdit = !isCustom; // Admin-only, handled by CSS
                const showCustomEdit = isCustom; // Always show
                
                return `
                    <div class="flex items-center justify-between p-4 ${!isFirst ? 'border-t border-gray-200' : ''} hover:bg-gray-50 transition-colors"
                         data-time="${bell.time}" data-name="${bell.name}" data-sound="${bell.sound}" data-type="${bell.type}">
                        <div class="flex items-center space-x-4">
                            <span class="text-xl font-medium text-blue-600 tabular-nums">${bell.time}</span>
                            <div>
                                <span class="font-medium text-gray-800">${bell.name}</span>
                                <span class="text-sm text-gray-500 ml-2">(${bell.sound})</span>
                                ${isCustom ? '<span class="ml-2 text-xs font-semibold bg-purple-200 text-purple-800 px-2 py-0.5 rounded-full">CUSTOM</span>' : ''}
                            </div>
                        </div>
                        <div class="flex-shrink-0 space-x-2">
                            <!-- Shared Bell Edit/Delete (hidden by default, shown in admin mode) -->
                            <button class="edit-btn px-3 py-1 text-sm bg-yellow-500 text-white rounded-lg hover:bg-yellow-600"
                                    aria-label="Edit shared bell ${bell.name}"
                                    title="Edit shared bell">Edit</button>
                            <button class="delete-btn px-3 py-1 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600"
                                    aria-label="Delete shared bell ${bell.name}"
                                    title="Delete shared bell">Delete</button>
                                    
                            <!-- Custom Bell Edit/Delete (always shown) -->
                            <button class="edit-custom-btn px-3 py-1 text-sm bg-yellow-500 text-white rounded-lg hover:bg-yellow-600"
                                    style="${!isCustom ? 'display: none;' : ''}"
                                    aria-label="Edit custom bell ${bell.name}"
                                    title="Edit custom bell">Edit</button>
                            <button class="delete-custom-btn px-3 py-1 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600"
                                    style="${!isCustom ? 'display: none;' : ''}"
                                    aria-label="Delete custom bell ${bell.name}"
                                    title="Delete custom bell">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderScheduleSelector() {
            const lastSelectedId = localStorage.getItem('activeScheduleId') || (allSchedules.length > 0 ? allSchedules[0].id : '');
            
            if (allSchedules.length === 0) {
                 scheduleSelector.innerHTML = '<option value="">No schedules found. Create one!</option>';
                 return;
            }
            
            scheduleSelector.innerHTML = allSchedules.map(schedule => 
                `<option value="${schedule.id}" ${schedule.id === lastSelectedId ? 'selected' : ''}>
                    ${schedule.name}
                </option>`
            ).join('');
            
            // Trigger a change to load the selected schedule
            setActiveSchedule(scheduleSelector.value);
        }

        // --- Local Storage (Custom Bells) ---
        function loadCustomBells() {
            customBells = JSON.parse(localStorage.getItem('customBells') || '[]').map(bell => ({
                ...bell,
                type: 'custom' // Ensure type is set
            }));
            renderCombinedList();
        }

        function saveCustomBells() {
            localStorage.setItem('customBells', JSON.stringify(customBells.map(b => ({
                time: b.time,
                name: b.name,
                sound: b.sound // Only save core data
            }))));
            renderCombinedList();
        }
        
        function handleAddCustomBell(e) {
            e.preventDefault();
            const time = customTimeInput.value;
            const name = customNameInput.value;
            const sound = customSoundInput.value;
            
            if (!time || !name) {
                alert("Please provide a time and name for the custom bell.");
                return;
            }

            // Check for duplicates
            if (customBells.find(b => b.time === time && b.name === name)) {
                alert("This custom bell already exists.");
                return;
            }

            customBells.push({ time, name, sound, type: 'custom' });
            saveCustomBells();
            addCustomBellForm.reset();
        }

        // --- Firebase Logic ---
        async function initFirebase() {
            try {
                // FIXED: Load config from injected variable
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                
                if (!firebaseConfig.apiKey) {
                    console.error("Firebase config is missing.");
                    statusElement.textContent = "Error: Firebase config not found.";
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Enable debug logging for Firestore
                setLogLevel('Debug');

                // FIXED: Use correct auth flow with __initial_auth_token
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("User is signed in:", user.uid);
                        userId = user.uid;
                        userIdElement.textContent = userId;

                        // This is the main entry point after auth
                        await loadAllSchedules();
                        
                        // Setup collection ref now that we have db and appId
                        // Data is public, so we use the 'public' path
                        // FIXED: Added 'data' segment to path
                        schedulesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'schedules');
                        
                        statusElement.textContent = "Connected. Monitoring bells...";

                    } else {
                        console.log("User is signed out. Authenticating...");
                        userId = null;
                        userIdElement.textContent = "Authenticating...";
                        
                        // FIXED: Sign in with token if available, else anonymously
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase Init Error:", error);
                statusElement.textContent = "Error connecting to Firebase.";
            }
        }
        
        async function loadAllSchedules() {
            if (!schedulesCollectionRef) {
                 // FIXED: Added 'data' segment to path
                 schedulesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'schedules');
            }

            try {
                const querySnapshot = await getDocs(schedulesCollectionRef);
                allSchedules = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    name: doc.data().name || "Unnamed Schedule",
                    bells: doc.data().bells || []
                }));

                // Sort schedules by name
                allSchedules.sort((a, b) => a.name.localeCompare(b.name));
                
                console.log("Loaded all schedules:", allSchedules.length);
                renderScheduleSelector();
                
            } catch (error) {
                console.error("Error loading all schedules: ", error);
                statusElement.textContent = "Error loading schedules.";
            }
        }

        function setActiveSchedule(scheduleId) {
            // Unsubscribe from the old schedule listener, if it exists
            if (activeScheduleListenerUnsubscribe) {
                activeScheduleListenerUnsubscribe();
            }

            if (!scheduleId) {
                console.warn("No schedule ID provided.");
                localSchedule = [];
                activeScheduleId = null;
                scheduleTitle.textContent = "No Schedule Selected";
                renderCombinedList();
                return;
            }
            
            console.log("Setting active schedule:", scheduleId);
            activeScheduleId = scheduleId;
            localStorage.setItem('activeScheduleId', scheduleId); // Remember choice

            // Get the doc reference for the new schedule
            // FIXED: Added 'data' segment to path
            scheduleRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', scheduleId);

            // Listen for real-time updates to this schedule
            activeScheduleListenerUnsubscribe = onSnapshot(scheduleRef, (docSnap) => {
                if (docSnap.exists()) {
                    const scheduleData = docSnap.data();
                    scheduleTitle.textContent = scheduleData.name;
                    localSchedule = (scheduleData.bells || []).map(bell => ({
                        ...bell,
                        type: 'shared' // Ensure type is set
                    }));
                    console.log("Active schedule updated:", localSchedule.length, "bells");
                } else {
                    console.warn("Selected schedule does not exist.");
                    localSchedule = [];
                    scheduleTitle.textContent = "Schedule Not Found";
                    // It might have been deleted, reload all schedules
                    loadAllSchedules();
                }
                renderCombinedList();
            }, (error) => {
                console.error("Error on schedule snapshot:", error);
                statusElement.textContent = "Error loading schedule data.";
            });
        }

        async function handleCreateSchedule(e) {
            e.preventDefault();
            const name = newScheduleNameInput.value.trim();
            if (!name) return;
            
            try {
                // Add a new document with a generated ID
                const newDocRef = await addDoc(schedulesCollectionRef, {
                    name: name,
                    bells: [] // Start with an empty bell list
                });
                
                console.log("Schedule created with ID:", newDocRef.id);
                newScheduleNameInput.value = '';
                
                // Reload all schedules to update the dropdown
                await loadAllSchedules();
                
                // Automatically select the new schedule
                scheduleSelector.value = newDocRef.id;
                setActiveSchedule(newDocRef.id);
                
            } catch (error) {
                console.error("Error creating schedule:", error);
            }
        }
        
        async function handleAddSharedBell(e) {
            e.preventDefault();
            if (!activeScheduleId) {
                alert("Please select a schedule first.");
                return;
            }
            
            const time = sharedTimeInput.value;
            const name = sharedNameInput.value;
            const sound = sharedSoundInput.value;
            
            if (!time || !name) {
                alert("Please provide a time and name for the bell.");
                return;
            }

            const newBell = { time, name, sound };

            // Get the current schedule data
            const currentSchedule = allSchedules.find(s => s.id === activeScheduleId);
            if (!currentSchedule) {
                alert("Could not find current schedule data.");
                return;
            }
            
            const existingBells = currentSchedule.bells || [];
            
            // Check for duplicates
            if (existingBells.find(b => b.time === time && b.name === name)) {
                alert("This bell (time and name) already exists in this schedule.");
                return;
            }
            
            const updatedBells = [...existingBells, newBell];

            try {
                // Update the document with the new bells array
                await updateDoc(scheduleRef, {
                    bells: updatedBells
                });
                
                console.log("Shared bell added.");
                addSharedBellForm.reset();
                addSharedStatus.textContent = `Bell "${name}" added to ${currentSchedule.name}.`;
                addSharedStatus.classList.remove('hidden');
                setTimeout(() => addSharedStatus.classList.add('hidden'), 3000);
                
                // Our onSnapshot listener will handle the UI update
            } catch (error) {
                console.error("Error adding shared bell:", error);
                addSharedStatus.textContent = "Error adding bell.";
                addSharedStatus.classList.remove('hidden');
            }
        }
        
        async function handleDeleteSchedule() {
            if (!activeScheduleId) {
                alert("Please select a schedule to delete.");
                return;
            }
            
            const scheduleName = scheduleSelector.options[scheduleSelector.selectedIndex].text;
            confirmDeleteText.textContent = `Are you sure you want to delete "${scheduleName}"? This cannot be undone.`;
            confirmDeleteModal.classList.remove('hidden');
            
            // We'll wait for the confirmation button click...
        }
        
        async function confirmDeleteSchedule() {
            if (!activeScheduleId) return;
            
            const scheduleIdToDelete = activeScheduleId;
            // FIXED: Added 'data' segment to path
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', scheduleIdToDelete);

            try {
                await deleteDoc(docRef);
                console.log("Schedule deleted:", scheduleIdToDelete);
                
                // Clear state
                activeScheduleId = null;
                localSchedule = [];
                
                // Reload schedule list
                await loadAllSchedules();
                
            } catch (error) {
                console.error("Error deleting schedule:", error);
            }
            
            confirmDeleteModal.classList.add('hidden');
        }

        // --- Event Delegation for Bell List ---
        function handleBellListClick(e) {
            const target = e.target;
            const bellElement = target.closest('[data-time]');
            if (!bellElement) return;

            const time = bellElement.dataset.time;
            const name = bellElement.dataset.name;
            const sound = bellElement.dataset.sound;
            const type = bellElement.dataset.type;

            if (target.classList.contains('delete-btn') || target.classList.contains('delete-custom-btn')) {
                handleDeleteBellClick(time, name, type);
            } else if (target.classList.contains('edit-btn') || target.classList.contains('edit-custom-btn')) {
                handleEditBellClick(time, name, sound, type);
            }
        }

        async function handleDeleteBellClick(time, name, type) {
            if (!confirm(`Are you sure you want to delete the bell "${name}" at ${time}?`)) {
                return;
            }
            
            if (type === 'custom') {
                customBells = customBells.filter(b => !(b.time === time && b.name === name));
                saveCustomBells();
            } else if (type === 'shared') {
                // This bell belongs to the active shared schedule
                const currentSchedule = allSchedules.find(s => s.id === activeScheduleId);
                if (!currentSchedule) {
                    alert("Error: Could not find active schedule.");
                    return;
                }
                
                const updatedBells = currentSchedule.bells.filter(b => !(b.time === time && b.name === name));
                
                try {
                    await updateDoc(scheduleRef, { bells: updatedBells });
                    console.log("Shared bell deleted.");
                    // onSnapshot will update the UI
                } catch (error) {
                    console.error("Error deleting shared bell:", error);
                }
            }
        }
        
        // --- Edit Bell Logic ---
        function handleEditBellClick(time, name, sound, type) {
            currentEditingBell = { 
                time, 
                name, 
                sound, 
                type, 
                originalTime: time, // Store original keys for finding it
                originalName: name
            };
            
            editBellTimeInput.value = time;
            editBellNameInput.value = name;
            editBellSoundInput.value = sound;
            
            editBellModal.classList.remove('hidden');
        }

        async function handleEditBellSubmit(e) {
            e.preventDefault();
            if (!currentEditingBell) return;

            const newBellData = {
                time: editBellTimeInput.value,
                name: editBellNameInput.value,
                sound: editBellSoundInput.value
            };
            
            const { originalTime, originalName, type } = currentEditingBell;

            if (type === 'custom') {
                // Find and update in customBells array
                const index = customBells.findIndex(b => b.time === originalTime && b.name === originalName);
                if (index > -1) {
                    customBells[index] = { ...newBellData, type: 'custom' };
                    saveCustomBells();
                }
                closeEditBellModal();
            } else if (type === 'shared') {
                // For shared bells, we must check other schedules
                const originalBell = { time: originalTime, name: originalName, sound: currentEditingBell.sound };
                const linkedSchedules = findLinkedSchedules(originalBell);
                
                // Remove the *current* schedule from the list, as we're already editing it
                const otherLinkedSchedules = linkedSchedules.filter(s => s.id !== activeScheduleId);

                if (otherLinkedSchedules.length > 0) {
                    // Show confirmation modal
                    linkedEditData = {
                        originalBell,
                        newBellData,
                        linkedSchedules: otherLinkedSchedules
                    };
                    renderLinkedScheduleList(otherLinkedSchedules);
                    confirmLinkedEditModal.classList.remove('hidden');
                    // We pause the edit... it will be resumed by the linked modal's buttons
                } else {
                    // No other schedules are linked, just edit this one
                    await updateBellInSchedules(originalBell, newBellData, [activeScheduleId]);
                    closeEditBellModal();
                }
            }
        }

        function findLinkedSchedules(bellToFind) {
            const { time, name, sound } = bellToFind;
            const linked = [];
            
            for (const schedule of allSchedules) {
                const found = schedule.bells.find(b => 
                    b.time === time && b.name === name && b.sound === sound
                );
                if (found) {
                    linked.push({ id: schedule.id, name: schedule.name });
                }
            }
            return linked;
        }

        function renderLinkedScheduleList(schedules) {
            if (schedules.length === 0) {
                linkedScheduleList.innerHTML = '<p class="text-gray-500">No other schedules found.</p>';
                return;
            }
            linkedScheduleList.innerHTML = schedules.map(s => `
                <div class="flex items-center">
                    <input type="checkbox" id="linked-${s.id}" value="${s.id}" checked 
                           class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 linked-schedule-check">
                    <label for="linked-${s.id}" class="ml-2 block text-sm text-gray-900">${s.name}</label>
                </div>
            `).join('');
        }

        async function handleLinkedEdit(applyToAll) {
            if (!linkedEditData) return;
            
            const { originalBell, newBellData, linkedSchedules } = linkedEditData;
            let scheduleIdsToUpdate = [activeScheduleId]; // Always update the current one
            
            if (applyToAll) {
                // Get all *checked* schedule IDs from the modal
                const checkedSchedules = Array.from(document.querySelectorAll('.linked-schedule-check:checked'))
                                              .map(cb => cb.value);
                scheduleIdsToUpdate.push(...checkedSchedules);
            }
            
            linkedEditStatus.textContent = "Applying updates...";
            linkedEditStatus.classList.remove('hidden');

            try {
                await updateBellInSchedules(originalBell, newBellData, scheduleIdsToUpdate);
                console.log("Linked update successful.");
            } catch (error) {
                console.error("Linked update failed:", error);
            }
            
            closeLinkedEditModal();
            closeEditBellModal();
        }

        async function updateBellInSchedules(originalBell, newBellData, scheduleIds) {
            const batch = writeBatch(db);
            
            // Use a Set to avoid duplicate updates if activeScheduleId was also in the list
            const uniqueScheduleIds = [...new Set(scheduleIds)];
            
            for (const scheduleId of uniqueScheduleIds) {
                const schedule = allSchedules.find(s => s.id === scheduleId);
                if (!schedule) continue;

                const updatedBells = schedule.bells.map(bell => {
                    if (bell.time === originalBell.time && bell.name === originalBell.name && bell.sound === originalBell.sound) {
                        return newBellData; // Swap with new data
                    }
                    return bell;
                });

                // FIXED: Added 'data' segment to path
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', scheduleId);
                batch.update(docRef, { bells: updatedBells });
            }

            await batch.commit();
            // onSnapshot will refresh the local data for the active schedule.
            // But we must also refresh allSchedules data to keep it in sync for future edits
            await loadAllSchedules();
        }
        
        function closeEditBellModal() {
            editBellModal.classList.add('hidden');
            currentEditingBell = null;
            editBellForm.reset();
        }
        
        function closeLinkedEditModal() {
            confirmLinkedEditModal.classList.add('hidden');
            linkedEditData = null;
            linkedScheduleList.innerHTML = '';
            linkedEditStatus.classList.add('hidden');
        }


        // --- Multi-Add Bell Modal Logic ---
        function showMultiAddModal() {
            // Populate the schedule list
            if (allSchedules.length === 0) {
                multiScheduleListContainer.innerHTML = '<p class="text-gray-500">No schedules found. Create one first.</p>';
            } else {
                multiScheduleListContainer.innerHTML = allSchedules.map(s => `
                    <div class="flex items-center">
                        <input type="checkbox" id="multi-${s.id}" value="${s.id}" 
                               class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 multi-schedule-check">
                        <label for="multi-${s.id}" class="ml-2 block text-sm text-gray-900">${s.name}</label>
                    </div>
                `).join('');
            }
            addBellModal.classList.remove('hidden');
        }

        async function handleMultiAddSubmit(e) {
            e.preventDefault();
            
            const newBell = {
                time: multiBellTimeInput.value,
                name: multiBellNameInput.value,
                sound: multiBellSoundInput.value
            };
            
            if (!newBell.time || !newBell.name) {
                alert("Please provide a time and name.");
                return;
            }

            const checkedScheduleIds = Array.from(document.querySelectorAll('.multi-schedule-check:checked'))
                                             .map(cb => cb.value);
            
            if (checkedScheduleIds.length === 0) {
                alert("Please select at least one schedule.");
                return;
            }
            
            multiAddStatus.textContent = `Adding bell to ${checkedScheduleIds.length} schedule(s)...`;
            multiAddStatus.classList.remove('hidden');
            multiAddSubmitBtn.disabled = true;

            const batch = writeBatch(db);
            let errors = 0;

            for (const scheduleId of checkedScheduleIds) {
                const schedule = allSchedules.find(s => s.id === scheduleId);
                if (!schedule) {
                    errors++;
                    continue;
                }
                
                // Add bell, but check for duplicates
                const bellExists = schedule.bells.find(b => b.time === newBell.time && b.name === newBell.name);
                if (!bellExists) {
                    const updatedBells = [...schedule.bells, newBell];
                    // FIXED: Added 'data' segment to path
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', scheduleId);
                    batch.update(docRef, { bells: updatedBells });
                }
            }

            try {
                await batch.commit();
                multiAddStatus.textContent = `Successfully added bell to ${checkedScheduleIds.length - errors} schedule(s).`;
                // Refresh allSchedules data
                await loadAllSchedules();
                
                setTimeout(() => {
                    addBellModal.classList.add('hidden');
                    multiAddStatus.classList.add('hidden');
                    multiAddBellForm.reset();
                }, 2000);

            } catch (error) {
                console.error("Error in multi-add batch:", error);
                multiAddStatus.textContent = "An error occurred.";
            } finally {
                multiAddSubmitBtn.disabled = false;
            }
        }


        // --- Admin Mode ---
        function toggleAdminMode() {
            if (document.body.classList.contains('admin-mode')) {
                document.body.classList.remove('admin-mode');
                adminToggleBtn.textContent = 'Toggle Admin';
            } else {
                // Show password prompt
                adminModal.classList.remove('hidden');
            }
        }

        function handleAdminLogin(e) {
            e.preventDefault();
            // Simple hardcoded password.
            // This is NOT secure, but suitable for this type of local-first app.
            if (adminPasswordInput.value === 'admin123') {
                document.body.classList.add('admin-mode');
                adminToggleBtn.textContent = 'Exit Admin';
                adminModal.classList.add('hidden');
                adminError.classList.add('hidden');
                adminPasswordInput.value = '';
            } else {
                adminError.classList.remove('hidden');
            }
        }

        // --- Init and Event Listeners ---
        function init() {
            // Audio overlay
            startAudioBtn.addEventListener('click', () => {
                Tone.start().then(() => {
                    console.log("AudioContext started.");
                    setupSynths();
                    audioOverlay.classList.add('hidden');
                    statusElement.textContent = "Connecting...";
                    // Start Firebase
                    initFirebase();
                    // Start the clock
                    requestAnimationFrame(updateClock);
                }).catch(e => {
                    console.error("Tone.start failed:", e);
                    alert("Could not start audio. Please refresh and try again.");
                });
            });

            // Schedule selection
            scheduleSelector.addEventListener('change', () => {
                setActiveSchedule(scheduleSelector.value);
            });
            
            // Admin controls
            adminToggleBtn.addEventListener('click', toggleAdminMode);
            adminSubmitBtn.addEventListener('click', handleAdminLogin);
            adminPasswordInput.addEventListener('keydown', (e) => {
                if(e.key === 'Enter') handleAdminLogin(e);
            });
            adminCancelBtn.addEventListener('click', () => {
                adminModal.classList.add('hidden');
                adminError.classList.add('hidden');
                adminPasswordInput.value = '';
            });

            // Forms
            addCustomBellForm.addEventListener('submit', handleAddCustomBell);
            addSharedBellForm.addEventListener('submit', handleAddSharedBell);
            createScheduleForm.addEventListener('submit', handleCreateSchedule);

            // Delete Schedule Modal
            deleteScheduleBtn.addEventListener('click', handleDeleteSchedule);
            deleteConfirmBtn.addEventListener('click', confirmDeleteSchedule);
            deleteCancelBtn.addEventListener('click', () => confirmDeleteModal.classList.add('hidden'));

            // Multi-Add Modal
            showAddBellModalBtn.addEventListener('click', showMultiAddModal);
            multiAddBellForm.addEventListener('submit', handleMultiAddSubmit);
            multiAddCancelBtn.addEventListener('click', () => {
                addBellModal.classList.add('hidden');
                multiAddBellForm.reset();
            });
            
            // Edit Bell Modal
            editBellForm.addEventListener('submit', handleEditBellSubmit);
            editBellCancelBtn.addEventListener('click', closeEditBellModal);
            
            // Linked Edit Modal
            linkedEditCancel.addEventListener('click', closeLinkedEditModal);
            linkedEditThisOnly.addEventListener('click', () => handleLinkedEdit(false));
            linkedEditApply.addEventListener('click', () => handleLinkedEdit(true));

            // Sound previews
            previewCustomSoundBtn.addEventListener('click', () => playBell(customSoundInput.value));
            previewSharedSoundBtn.addEventListener('click', () => playBell(sharedSoundInput.value));
            
            // Event delegation for bell list
            combinedBellListElement.addEventListener('click', handleBellListClick);
            
            // Load custom bells from local storage
            loadCustomBells();
        }

        // --- Start the App ---
        init();

    </script>
</body>
</html>

