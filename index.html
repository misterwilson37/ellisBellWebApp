<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Bell Web App</title>
    <!-- Using Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Using Tone.js for web audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        // Use Century Gothic, with Questrial as a web-safe fallback
                        sans: ['Century Gothic', 'Questrial', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <!-- Updated Google Font to include Questrial as a Century Gothic fallback -->
    <link href="https://fonts.googleapis.com/css2?family=Questrial&display=swap" rel="stylesheet">
    <style>
        body {
            /* Apply the new font stack */
            font-family: 'Century Gothic', 'Questrial', 'sans-serif';
        }
        /* Styles for Admin Controls */
        /* Hide admin controls and shared delete/edit buttons by default */
        .admin-control, #combined-bell-list .delete-btn, #combined-bell-list .edit-btn {
            display: none;
        }
        /* When body has .admin-mode, show them */
        body.admin-mode .admin-control {
            display: block; 
        }
        /* Show shared delete/edit buttons in admin mode */
        body.admin-mode #combined-bell-list .delete-btn,
        body.admin-mode #combined-bell-list .edit-btn {
            display: inline-block;
        }
        /* Always show custom delete/edit buttons */
        #combined-bell-list .delete-custom-btn,
        #combined-bell-list .edit-custom-btn {
            display: inline-block;
        }

        /* Hide auth elements by default */
        #sign-out-btn {
            display: none;
        }
        /* Show auth elements when authenticated */
        body.authenticated #sign-out-btn {
            display: inline-block;
        }
        body.authenticated #user-info {
            display: block;
        }
        body.authenticated #admin-toggle {
            display: inline-block;
        }


        /* Fix for modal z-index issues */
        #edit-bell-modal { z-index: 50; }
        #confirm-delete-bell-modal { z-index: 55; }
        #confirm-linked-edit-modal { z-index: 60; }

        /* NEW: Styles for mute buttons */
        #mute-all-btn.muted {
            background-color: #dc2626; /* red-600 */
            color: white;
        }
        #mute-all-btn.muted:hover {
            background-color: #b91c1c; /* red-700 */
        }

    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans"> <!-- Added font-sans to apply tailwind default -->

    <!-- NEW: Auth/Welcome Overlay -->
    <div id="welcome-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-10 md:p-16 rounded-lg shadow-xl w-full max-w-md text-center">
            <h2 class="text-3xl font-bold text-blue-700 mb-6">Welcome to School Bell</h2>
            <p class="text-gray-600 mb-8">Please sign in to synchronize your schedule.</p>
            <div class="space-y-4">
                <button id="google-start-btn" class="w-full px-8 py-4 bg-blue-600 text-white font-bold text-lg rounded-lg shadow-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-3">
                    <!-- Simple SVG for Google 'G' -->
                    <svg class="w-6 h-6" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path fill="#ffffff" d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.9 8.2,4.73 12.18,4.73C15.29,4.73 17.1,6.7 17.1,6.7L19,4.72C19,4.72 16.56,2 12.18,2C6.42,2 2.03,6.8 2.03,12C2.03,17.05 6.16,22 12.18,22C17.6,22 21.5,18.33 21.5,12.33C21.5,11.76 21.45,11.43 21.35,11.1Z"/>
                    </svg>
                    Sign in with Google
                </button>
                <button id="anonymous-start-btn" class="w-full px-8 py-4 bg-gray-600 text-white font-bold text-lg rounded-lg shadow-lg hover:bg-gray-700 transition-colors">
                    Continue Anonymously
                </button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Audio Start Overlay (for refresh) -->
    <div id="audio-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40 hidden">
        <button id="start-audio-btn" class="px-8 py-4 bg-blue-600 text-white font-bold text-2xl rounded-lg shadow-lg hover:bg-blue-700 transition-colors">
            Click to Start Audio
        </button>
    </div>

    <!-- NEW: Add Bell to Multiple Schedules Modal -->
    <div id="add-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 hidden">
        <form id="multi-add-bell-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-medium mb-6">Add Bell to Schedules</h3>
            
            <!-- Bell Details -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="multi-bell-time" class="block text-sm font-medium text-gray-700">Time (HH:MM:SS)</label>
                    <input type="time" id="multi-bell-time" step="1" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="multi-bell-name" class="block text-sm font-medium text-gray-700">Bell Name</label>
                    <input type="text" id="multi-bell-name" placeholder="e.g. 1st Period End" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div>
                <label for="multi-bell-sound" class="block text-sm font-medium text-gray-700">Sound</label>
                <select id="multi-bell-sound" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="ellisBell.mp3">Ellis Bell</option> <!-- Default -->
                    <option value="Bell">Bell</option>
                    <option value="Chime">Chime</option>
                    <option value="Beep">Beep</option>
                    <option value="Alarm">Alarm</option>
                </select>
            </div>

            <!-- Schedule Checkboxes -->
            <div class="mt-6">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-sm font-medium text-gray-700">Select Schedules to Add to:</label>
                    <div class="space-x-2">
                        <!-- NEW: Select All/None -->
                        <button type="button" id="multi-select-all" class="text-sm text-blue-600 hover:underline">Select All</button>
                        <button type="button" id="multi-select-none" class="text-sm text-blue-600 hover:underline">Select None</button>
                    </div>
                </div>
                <div id="multi-schedule-list-container" class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4 grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <!-- Checkboxes will be dynamically injected here -->
                    <p class="text-gray-500">Loading schedules...</p>
                </div>
            </div>
            
            <p id="multi-add-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="multi-add-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Close</button>
                <button type="submit" id="multi-add-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Bell</button>
            </div>
        </form>
    </div>

    <!-- NEW: Edit Bell Modal -->
    <div id="edit-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <form id="edit-bell-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-medium mb-6">Edit Bell</h3>
            
            <!-- Bell Details -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="edit-bell-time" class="block text-sm font-medium text-gray-700">Time (HH:MM:SS)</label>
                    <input type="time" id="edit-bell-time" step="1" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="edit-bell-name" class="block text-sm font-medium text-gray-700">Bell Name</label>
                    <input type="text" id="edit-bell-name" placeholder="e.g. 1st Period End" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div>
                <label for="edit-bell-sound" class="block text-sm font-medium text-gray-700">Sound</label>
                <select id="edit-bell-sound" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="Bell">Bell</option>
                    <option value="Chime">Chime</option>
                    <option value="Beep">Beep</option>
                    <option value="Alarm">Alarm</option>
                    <option value="ellisBell.mp3">Ellis Bell</option>
                </select>
            </div>
            
            <p id="edit-bell-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="edit-bell-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" id="edit-bell-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
            </div>
        </form>
    </div>

    <!-- NEW: Confirm Linked Edit Modal -->
    <div id="confirm-linked-edit-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-xl font-medium mb-4">Update Linked Schedules?</h3>
            <p class="text-gray-700 mb-4">This bell was found in other schedules. Do you want to apply your edit to them as well?</p>
            
            <p class="text-sm font-medium text-gray-700 mb-2">Schedules containing this bell:</p>
            <div id="linked-schedule-list" class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4 grid grid-cols-1 sm:grid-cols-2 gap-2">
                <!-- Linked schedules will be injected here -->
            </div>
            
            <p id="linked-edit-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <div class="mt-6 flex flex-col sm:flex-row justify-end gap-3">
                <button type="button" id="linked-edit-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="linked-edit-this-only" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">Update This Schedule Only</button>
                <button type="button" id="linked-edit-apply" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Apply to All Selected</button>
            </div>
        </div>
    </div>


    <!-- NEW: Confirm Delete Schedule Modal -->
    <div id="confirm-delete-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-medium mb-4">Delete Schedule</h3>
            <p id="confirm-delete-text" class="text-gray-700 mb-6">Are you sure you want to delete this schedule? This action cannot be undone.</p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="delete-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="delete-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- NEW: Confirm Delete Bell Modal -->
    <div id="confirm-delete-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-55 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-medium mb-4">Delete Bell</h3>
            <p id="confirm-delete-bell-text" class="text-gray-700 mb-6">Are you sure you want to delete this bell?</p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="delete-bell-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="delete-bell-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>


    <!-- Main Application -->
    <div class="container mx-auto max-w-2xl p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-700">School Bell</h1>
            <p class="text-lg text-gray-600">A real-time, synchronized bell schedule</p>
            
            <!-- Auth Info & Controls -->
            <div id="user-info" class="text-sm text-gray-500 mt-4 hidden">
                <p>User: <code id="userIdDisplay" class="bg-gray-200 px-2 py-1 rounded">...</code></p>
                <button id="sign-out-btn" class="mt-2 px-3 py-1 text-sm bg-gray-200 text-gray-800 rounded-full hover:bg-gray-300 transition-colors">
                    Sign Out
                </button>
            </div>
        </header>

        <!-- Live Clock & Countdown -->
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-md mb-8">
            <!-- MODIFIED: Countdown Display -->
            <div classs="text-center text-gray-800">
                <div id="countdown-line-1" class="text-2xl md:text-3xl font-medium text-gray-600">Loading...</div>
                <div id="countdown-timer" class="text-6xl md:text-8xl font-bold tabular-nums my-2">--:--:--</div>
                <div id="countdown-line-3" class="text-2xl md:text-3xl font-medium text-gray-600">until the next bell.</div>
            </div>

            <div class="text-center text-gray-500 text-lg mt-4">
                Status: <span id="status-message" class="font-medium text-gray-700">Initializing...</span>
            </div>

            <!-- NEW: Mute Controls -->
            <div class="flex justify-center gap-4 mt-4">
                <button id="mute-all-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                    Mute All Bells
                </button>
                <button id="mute-next-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                    Mute Next Bell
                </button>
            </div>

        </div>

        <!-- Combined Bell Schedule List -->
        <div>
            <h2 id="schedule-title" class="text-2xl font-semibold mb-4">Current Schedule</h2>
            <div id="combined-bell-list" class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
                <!-- Bells will be injected here by JavaScript -->
                <div class="p-8 text-center text-gray-500">
                    Loading schedule...
                </div>
            </div>
        </div>

        <!-- Schedule Selector -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <div class="flex justify-between items-center mb-2">
                <label for="schedule-selector" class="block text-lg font-medium text-gray-700">Active Shared Schedule</label>
                <button id="admin-toggle" class="px-3 py-1 text-sm bg-gray-200 text-gray-800 rounded-full hover:bg-gray-300 transition-colors hidden" disabled>
                    Admin Mode
                </button>
            </div>
            <select id="schedule-selector" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg">
                <option value="">Loading schedules...</option>
            </select>
            
        </div>
        
        <!-- NEW: Admin Zone for creating schedules and adding bells -->
        <div class="admin-control bg-white p-6 rounded-xl shadow-md mb-8 space-y-6">
            <h3 class="text-xl font-semibold text-gray-800 border-b pb-2">Admin Zone</h3>
            
            <!-- Create New Schedule Form -->
            <form id="create-schedule-form">
                <label for="new-schedule-name" class="block text-sm font-medium text-gray-700 mb-1">Create New Schedule</label>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="new-schedule-name" placeholder="New Schedule Name" required class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700">
                        Create
                    </button>
                </div>
            </form>

            <!-- NEW: Add Bell to THIS Schedule Form -->
            <form id="add-shared-bell-form" class="border-t pt-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Add Bell to This Schedule</label>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="shared-bell-time" class="block text-sm font-medium text-gray-700 mb-1">Time (HH:MM:SS)</label>
                        <input type="time" id="shared-bell-time" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="shared-bell-name" class="block text-sm font-medium text-gray-700 mb-1">Bell Name</label>
                        <input type="text" id="shared-bell-name" placeholder="e.g. 1st Period Start" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-end gap-4">
                    <div class="flex-grow" style="min-width: 120px;">
                        <label for="shared-bell-sound" class="block text-sm font-medium text-gray-700 mb-1">Sound</label>
                        <select id="shared-bell-sound" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="ellisBell.mp3">Ellis Bell</option> <!-- Default -->
                            <option value="Bell">Bell</option>
                            <option value="Chime">Chime</option>
                            <option value="Beep">Beep</option>
                            <option value="Alarm">Alarm</option>
                        </select>
                    </div>
                    <button type="button" id="preview-shared-sound" class="px-4 py-2 text-2xl bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview sound">
                        ▶
                    </button>
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Add Shared Bell
                    </button>
                </div>
                <p id="add-shared-status" class="text-blue-600 text-sm mt-3 hidden"></p>
            </form>

            <!-- Add Bell to Schedules Button -->
            <div class="border-t pt-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Add Bell to Multiple Schedules</label>
                <button type="button" id="show-add-bell-modal-btn" class="w-full px-6 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700">
                    Add Bell to Schedules...
                </button>
            </div>

            <!-- MOVED: Delete Selected Schedule Button -->
            <div class="border-t pt-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Delete Current Schedule</label>
                <button type="button" id="delete-schedule-btn" class="w-full px-4 py-2 bg-red-600 text-white font-medium rounded-lg shadow-md hover:bg-red-700 transition-colors">
                    Delete Selected Schedule
                </button>
            </div>
        </div>


        <!-- Custom Bells (Local) -->
        <div class="mt-12">
            <h2 class="text-2xl font-semibold mb-4">My Custom Bells (This Browser Only)</h2>

            <!-- Add Custom Bell Form -->
            <form id="add-custom-bell-form" class="bg-white p-6 rounded-xl shadow-md mb-8">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="custom-bell-time" class="block text-sm font-medium text-gray-700 mb-1">Time (HH:MM:SS)</label>
                        <input type="time" id="custom-bell-time" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <!-- NEW: Custom Bell Name -->
                    <div>
                        <label for="custom-bell-name" class="block text-sm font-medium text-gray-700 mb-1">Bell Name</label>
                        <input type="text" id="custom-bell-name" placeholder="e.g. My Reminder" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-end gap-4">
                    <div class="flex-grow" style="min-width: 120px;">
                        <label for="custom-bell-sound" class="block text-sm font-medium text-gray-700 mb-1">Sound</label>
                        <select id="custom-bell-sound" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Bell">Bell</option>
                            <option value="Chime">Chime</option>
                            <option value="Beep">Beep</option>
                            <option value="Alarm">Alarm</option>
                            <option value="ellisBell.mp3">Ellis Bell</option>
                        </select>
                    </div>
                    <button type="button" id="preview-custom-sound" class="px-4 py-2 text-2xl bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview sound">
                        ▶
                    </button>
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Add Custom Bell
                    </button>
                </div>
            </form>
        </div>

    </div>

        <!-- Firebase and App Logic -->
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js"; // Not used
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithPopup, 
            GoogleAuthProvider,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            onSnapshot, 
            setDoc, 
            updateDoc, 
            collection, 
            getDocs, 
            writeBatch, 
            setLogLevel, 
            deleteDoc, 
            getDoc, 
            addDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Elements ---
        const welcomeOverlay = document.getElementById('welcome-overlay');
        const audioOverlay = document.getElementById('audio-overlay');
        const startAudioBtn = document.getElementById('start-audio-btn');
        
        const googleStartBtn = document.getElementById('google-start-btn');
        const anonymousStartBtn = document.getElementById('anonymous-start-btn');
        
        const statusElement = document.getElementById('status-message');
        const userIdElement = document.getElementById('userIdDisplay');
        const signOutBtn = document.getElementById('sign-out-btn');
        
        const scheduleSelector = document.getElementById('schedule-selector');
        const scheduleTitle = document.getElementById('schedule-title');
        const adminToggleBtn = document.getElementById('admin-toggle');
        
        // Countdown
        const countdownLine1 = document.getElementById('countdown-line-1');
        const countdownTimer = document.getElementById('countdown-timer');
        const countdownLine3 = document.getElementById('countdown-line-3');

        // NEW: Mute Buttons
        const muteAllBtn = document.getElementById('mute-all-btn');
        const muteNextBtn = document.getElementById('mute-next-btn');
        
        // Custom Bell Form
        const addCustomBellForm = document.getElementById('add-custom-bell-form');
        const customTimeInput = document.getElementById('custom-bell-time');
        const customNameInput = document.getElementById('custom-bell-name'); // New
        const customSoundInput = document.getElementById('custom-bell-sound');
        
        // NEW: Add Shared Bell Form (in Admin Zone)
        const addSharedBellForm = document.getElementById('add-shared-bell-form');
        const sharedTimeInput = document.getElementById('shared-bell-time');
        const sharedNameInput = document.getElementById('shared-bell-name');
        const sharedSoundInput = document.getElementById('shared-bell-sound');
        const previewSharedSoundBtn = document.getElementById('preview-shared-sound');
        const addSharedStatus = document.getElementById('add-shared-status');

        // Combined List
        const combinedBellListElement = document.getElementById('combined-bell-list');
        const previewCustomSoundBtn = document.getElementById('preview-custom-sound');
        
        // NEW: Multi-Add Bell Modal
        const addBellModal = document.getElementById('add-bell-modal');
        const showAddBellModalBtn = document.getElementById('show-add-bell-modal-btn');
        const multiAddBellForm = document.getElementById('multi-add-bell-form');
        const multiBellTimeInput = document.getElementById('multi-bell-time');
        const multiBellNameInput = document.getElementById('multi-bell-name');
        const multiBellSoundInput = document.getElementById('multi-bell-sound');
        const multiScheduleListContainer = document.getElementById('multi-schedule-list-container');
        const multiAddCancelBtn = document.getElementById('multi-add-cancel');
        const multiAddSubmitBtn = document.getElementById('multi-add-submit');
        const multiAddStatus = document.getElementById('multi-add-status');
        const multiSelectAllBtn = document.getElementById('multi-select-all');
        const multiSelectNoneBtn = document.getElementById('multi-select-none');

        // NEW: Edit Bell Modal
        const editBellModal = document.getElementById('edit-bell-modal');
        const editBellForm = document.getElementById('edit-bell-form');
        const editBellTimeInput = document.getElementById('edit-bell-time');
        const editBellNameInput = document.getElementById('edit-bell-name');
        const editBellSoundInput = document.getElementById('edit-bell-sound');
        const editBellCancelBtn = document.getElementById('edit-bell-cancel');
        const editBellSubmitBtn = document.getElementById('edit-bell-submit');
        const editBellStatus = document.getElementById('edit-bell-status');

        // NEW: Linked Edit Modal
        const confirmLinkedEditModal = document.getElementById('confirm-linked-edit-modal');
        const linkedScheduleList = document.getElementById('linked-schedule-list');
        const linkedEditStatus = document.getElementById('linked-edit-status');
        const linkedEditCancel = document.getElementById('linked-edit-cancel');
        const linkedEditThisOnly = document.getElementById('linked-edit-this-only');
        const linkedEditApply = document.getElementById('linked-edit-apply');

        // NEW: Create/Delete Schedule
        const createScheduleForm = document.getElementById('create-schedule-form');
        const newScheduleNameInput = document.getElementById('new-schedule-name');
        const deleteScheduleBtn = document.getElementById('delete-schedule-btn');
        const confirmDeleteModal = document.getElementById('confirm-delete-modal');
        const confirmDeleteText = document.getElementById('confirm-delete-text');
        const deleteConfirmBtn = document.getElementById('delete-confirm');
        const deleteCancelBtn = document.getElementById('delete-cancel'); // Added for completeness

        // NEW: Delete Bell Modal
        const confirmDeleteBellModal = document.getElementById('confirm-delete-bell-modal');
        const confirmDeleteBellText = document.getElementById('confirm-delete-bell-text');
        const deleteBellConfirmBtn = document.getElementById('delete-bell-confirm');
        const deleteBellCancelBtn = document.getElementById('delete-bell-cancel');

        // --- App State ---
        let db, auth;
        let userId;
        let isAudioReady = false; // NEW: Track audio state
        // BELLS ARE NOW { time, name, sound }
        let localSchedule = []; // Holds array of SHARED bells
        let customBells = []; // Holds array of CUSTOM bells
        let scheduleRef; // Firestore document reference TO THE ACTIVE SCHEDULE
        let schedulesCollectionRef; // Reference to the collection of all schedules
        let allSchedules = []; // Array of { id, name, bells: [] }
        let activeScheduleId = null;
        let activeScheduleListenerUnsubscribe = null; 
        let synths = {}; 
        let lastBellRingTime = null; 
        let clockIntervalId = null; // MODIFIED: Use interval for background tabs
        
        let currentEditingBell = null; // Stores { time, name, sound, type, originalTime, originalName } of the bell being edited
        let linkedEditData = null; // Stores data for the linked edit confirmation
        let bellToDelete = null; // Stores { time, name, type } for delete confirmation

        // NEW: Mute State
        let isMutedAll = false;
        let mutedNextBell = null; // Stores "TIME-NAME" of the next bell to mute

        // Use the dynamic appId from the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyDfo45UBu-pR8nqMQhVlS_QgyYZ2kzBdvM",
          authDomain: "ellisbell-c185c.firebaseapp.com",
          projectId: "ellisbell-c185c",
          storageBucket: "ellisbell-c185c.firebasestorage.app",
          messagingSenderId: "441560045695",
          appId: "1:441560045695:web:94e51a006663404b8f474a",
          measurementId: "G-D6TX4YRBSD"
        };

        // Admin List
        const ADMIN_EMAIL_LIST = [
            'jacob.v.wilson@gmail.com'
        ];

        // --- Audio Setup (Tone.js) ---
        async function startAudio() {
            try {
                await Tone.start();
                console.log("AudioContext started.");
                setupSynths();
                isAudioReady = true;
                
                // NEW: If user is already signed in (from refresh), start clock
                if (auth && auth.currentUser) {
                    console.log("Audio ready, user signed in. Starting clock.");
                    statusElement.textContent = "Connected. Monitoring bells...";
                    if (clockIntervalId) clearInterval(clockIntervalId);
                    updateClock(); // Run once immediately
                    clockIntervalId = setInterval(updateClock, 1000);
                }

            } catch (e) {
                console.error("Error starting audio:", e);
                statusElement.textContent = "Error starting audio. Please refresh.";
            }
        }

        function setupSynths() {
            // Using .toDestination() connects the synth to the speakers
            synths['Bell'] = new Tone.MetalSynth({
                frequency: 200,
                envelope: { attack: 0.001, decay: 0.4, release: 0.2 },
                harmonicity: 5.1,
                modulationIndex: 32,
                resonance: 4000,
                octaves: 1.5
            }).toDestination();

            synths['Chime'] = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 1 }
            }).toDestination();

            synths['Beep'] = new Tone.Synth({
                oscillator: { type: 'square' },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.05 }
            }).toDestination();

            synths['Alarm'] = new Tone.MonoSynth({
                oscillator: { type: "sine" },
                envelope: { attack: 0.1, decay: 0.2, release: 0.1 }
            }).toDestination();
            
            // This assumes ellisBell.mp3 is in the same directory as index.html
            synths['ellisBell.mp3'] = new Tone.Player("ellisBell.mp3").toDestination();
        }

        function playBell(soundName) {
            if (!isAudioReady) {
                console.warn("Audio not ready, cannot play bell.");
                return;
            }
            if (!synths[soundName]) {
                console.warn(`Sound '${soundName}' not found or not loaded.`);
                // Attempt to load it just in time? Risky.
                if (soundName === 'ellisBell.mp3') {
                     synths['ellisBell.mp3'] = new Tone.Player("ellisBell.mp3").toDestination();
                     console.log("Attempting to hot-load ellisBell.mp3");
                } else {
                    return;
                }
            }

            const now = Tone.now();
            const synth = synths[soundName];

            try {
                if (synth instanceof Tone.Player) {
                    if (synth.loaded) {
                        synth.start(now);
                    } else {
                        console.warn("ellisBell.mp3 not loaded yet. Buffering...");
                        // Try to play as soon as it loads
                        synth.load("ellisBell.mp3").then(() => {
                            console.log("ellisBell.mp3 loaded, now playing.");
                            synth.start(Tone.now());
                        }).catch(e => console.error("Error loading MP3:", e));
                    }
                } else {
                    if (soundName === 'Bell') {
                        synth.triggerAttackRelease('C4', '0.5', now);
                        synth.triggerAttackRelease('G4', '0.5', now + 0.3);
                    } else if (soundName === 'Chime') {
                        synth.triggerAttackRelease('G5', '0.8', now);
                        synth.triggerAttackRelease('E6', '0.8', now + 0.5);
                    } else if (soundName === 'Beep') {
                        synth.triggerAttackRelease('A5', '0.1', now);
                    } else if (soundName === 'Alarm') {
                        synth.triggerAttackRelease("C5", "0.1", now);
                        synth.triggerAttackRelease("C5", "0.1", now + 0.15);
                        synth.triggerAttackRelease("C5", "0.1", now + 0.3);
                    }
                }
                // statusElement.textContent = `Previewing: ${soundName}`; // Don't overwrite main status
            } catch (error) {
                console.error("Error playing sound:", error);
            }
        }

        // --- Clock and Bell Logic ---
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const currentTimeHHMMSS = `${hours}:${minutes}:${seconds}`;

            // --- Find Next Bell ---
            const allBells = [...localSchedule, ...customBells];
            allBells.sort((a, b) => a.time.localeCompare(b.time));
            
            let nextBell = null;
            let upcomingBells = allBells.filter(bell => bell.time > currentTimeHHMMSS);
            
            if (upcomingBells.length > 0) {
                nextBell = upcomingBells[0];
            } else if (allBells.length > 0) {
                nextBell = allBells[0]; // First bell of "tomorrow"
            }

            // --- Update Countdown Display ---
            if (nextBell) {
                const nextBellTime = new Date();
                const [nextH, nextM, nextS] = nextBell.time.split(':').map(Number);
                nextBellTime.setHours(nextH, nextM, nextS, 0);

                let diff = nextBellTime.getTime() - now.getTime();
                if (diff < 0) { // It's for "tomorrow"
                    nextBellTime.setDate(nextBellTime.getDate() + 1);
                    diff = nextBellTime.getTime() - now.getTime();
                }

                const diffSeconds = Math.floor(diff / 1000);
                const h = Math.floor(diffSeconds / 3600);
                const m = Math.floor((diffSeconds % 3600) / 60);
                const s = diffSeconds % 60;

                // Format countdown, remove leading zeros
                let countdownStr = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                countdownStr = countdownStr.replace(/^(00:)+/, ''); // 00:05:30 -> 05:30
                countdownStr = countdownStr.replace(/^0/, ''); // 05:30 -> 5:30

                countdownLine1.textContent = `The time is ${currentTimeHHMMSS}. There are`;
                countdownTimer.textContent = countdownStr;
                
                // NEW: Check if this next bell is muted
                const nextBellId = `${nextBell.time}-${nextBell.name}`;
                if (mutedNextBell === nextBellId) {
                    countdownLine3.textContent = `until ${nextBell.name} (MUTED)`;
                } else {
                    countdownLine3.textContent = `until ${nextBell.name}`;
                }

            } else {
                countdownLine1.textContent = `The time is ${currentTimeHHMMSS}.`;
                countdownTimer.textContent = "No Bells";
                countdownLine3.textContent = "No bells scheduled.";
            }


            // --- Check if a bell should ring ---
            const bellToRing = allBells.find(bell => bell.time === currentTimeHHMMSS);
            
            if (bellToRing && lastBellRingTime !== currentTimeHHMMSS) {
                const bellId = `${bellToRing.time}-${bellToRing.name}`;
                
                // NEW: Check mute status
                if (isMutedAll) {
                    console.log(`Skipping bell (Muted All): ${bellToRing.name}`);
                    statusElement.textContent = `Skipped (All Muted): ${bellToRing.name}`;
                } else if (mutedNextBell === bellId) {
                    console.log(`Skipping bell (Muted Next): ${bellToRing.name}`);
                    statusElement.textContent = `Skipped (Muted): ${bellToRing.name}`;
                    mutedNextBell = null; // Clear the one-time mute
                    muteNextBtn.textContent = "Mute Next Bell";
                    muteNextBtn.disabled = false;
                } else {
                    // Ring the bell
                    ringBell(bellToRing);
                }
                
                lastBellRingTime = currentTimeHHMMSS;
            }
            
            if (lastBellRingTime && lastBellRingTime !== currentTimeHHMMSS) {
                lastBellRingTime = null;
                if (isAudioReady) statusElement.textContent = "Monitoring...";
            }
        }
        
        function ringBell(bell) {
            console.log("Ringing bell:", bell.name);
            playBell(bell.sound);
            statusElement.textContent = `Ringing: ${bell.name}`;
            
            // Highlight the bell in the list
            /*
            This query is fragile because name can have special characters.
            Using time and type is more robust.
            */
            const bellElements = document.querySelectorAll(`[data-time="${bell.time}"][data-type="${bell.type}"]`);
            // Find the one with the matching name, just in case
            const bellElement = Array.from(bellElements).find(el => el.dataset.name === bell.name);

            if (bellElement) {
                bellElement.classList.add('bg-blue-100');
                setTimeout(() => {
                    bellElement.classList.remove('bg-blue-100');
                }, 3000); // Remove highlight after 3 seconds
            }
        }

        // --- Render Functions ---
        function renderCombinedList() {
            const allBells = [...localSchedule, ...customBells];
            allBells.sort((a, b) => a.time.localeCompare(b.time));

            if (allBells.length === 0) {
                combinedBellListElement.innerHTML = `<div class="p-8 text-center text-gray-500">No bells scheduled for this day.</div>`;
                return;
            }

            combinedBellListElement.innerHTML = allBells.map((bell, index) => {
                const isCustom = bell.type === 'custom';
                const isFirst = index === 0;
                const isAdmin = document.body.classList.contains('admin-mode');

                // Sanitize name for use in attributes
                const safeName = bell.name.replace(/"/g, '&quot;');

                return `
                    <div class="flex items-center justify-between p-4 ${!isFirst ? 'border-t border-gray-200' : ''} hover:bg-gray-50 transition-colors"
                         data-time="${bell.time}" data-name="${safeName}" data-sound="${bell.sound}" data-type="${bell.type}">
                        <div class="flex items-center space-x-4 min-w-0">
                            <span class="text-xl font-medium text-blue-600 tabular-nums">${bell.time}</span>
                            <div class="min-w-0">
                                <span class="font-medium text-gray-800 truncate block">${bell.name}</span>
                                <span class="text-sm text-gray-500">(${bell.sound})</span>
                                ${isCustom ? '<span class="ml-2 text-xs font-semibold bg-purple-200 text-purple-800 px-2 py-0.5 rounded-full">CUSTOM</span>' : ''}
                            </div>
                        </div>
                        <div class="flex-shrink-0 space-x-2">
                            <!-- Shared Bell Edit/Delete (hidden by default, shown in admin mode) -->
                            <button class="edit-btn px-3 py-1 text-sm bg-yellow-500 text-white rounded-lg hover:bg-yellow-600"
                                    aria-label="Edit shared bell ${safeName}"
                                    title="Edit shared bell">Edit</button>
                            <button class="delete-btn px-3 py-1 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600"
                                    aria-label="Delete shared bell ${safeName}"
                                    title="Delete shared bell">Delete</button>
                                    
                            <!-- Custom Bell Edit/Delete (always shown) -->
                            <button class="edit-custom-btn px-3 py-1 text-sm bg-yellow-500 text-white rounded-lg hover:bg-yellow-600"
                                    style="${!isCustom ? 'display: none;' : ''}"
                                    aria-label="Edit custom bell ${safeName}"
                                    title="Edit custom bell">Edit</button>
                            <button class="delete-custom-btn px-3 py-1 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600"
                                    style="${!isCustom ? 'display: none;' : ''}"
                                    aria-label="Delete custom bell ${safeName}"
                                    title="Delete custom bell">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderScheduleSelector() {
            const lastSelectedId = localStorage.getItem('activeScheduleId') || (allSchedules.length > 0 ? allSchedules[0].id : '');
            
            if (allSchedules.length === 0) {
                 scheduleSelector.innerHTML = '<option value="">No schedules found. Create one!</option>';
                 // NEW: Stop listening if no schedules exist
                 if (activeScheduleListenerUnsubscribe) {
                     activeScheduleListenerUnsubscribe();
                     activeScheduleListenerUnsubscribe = null;
                 }
                 setActiveSchedule(null); // Clear schedule
                 return;
            }
            
            scheduleSelector.innerHTML = allSchedules.map(schedule => 
                `<option value="${schedule.id}" ${schedule.id === lastSelectedId ? 'selected' : ''}>
                    ${schedule.name}
                </option>`
            ).join('');
            
            // Trigger a change to load the selected schedule
            setActiveSchedule(scheduleSelector.value);
        }

        // --- Local Storage (Custom Bells) ---
        function loadCustomBells() {
            customBells = JSON.parse(localStorage.getItem('customBells') || '[]').map(bell => ({
                ...bell,
                type: 'custom' // Ensure type is set
            }));
            renderCombinedList();
        }

        function saveCustomBells() {
            localStorage.setItem('customBells', JSON.stringify(customBells.map(b => ({
                time: b.time,
                name: b.name,
                sound: b.sound // Only save core data
            }))));
            renderCombinedList();
        }
        
        function handleAddCustomBell(e) {
            e.preventDefault();
            const time = customTimeInput.value;
            const name = customNameInput.value;
            const sound = customSoundInput.value;
            
            if (!time || !name) {
                // Use custom modal later
                alert("Please provide a time and name for the custom bell.");
                return;
            }

            // Check for duplicates
            if (customBells.find(b => b.time === time && b.name === name)) {
                alert("This custom bell already exists.");
                return;
            }

            customBells.push({ time, name, sound, type: 'custom' });
            saveCustomBells();
            addCustomBellForm.reset();
        }

        // --- Firebase Logic ---
        async function initFirebase() {
            try {
                 const app = initializeApp(firebaseConfig);
                 db = getFirestore(app);
                 auth = getAuth(app);
                 
                 // Enable debug logging for Firestore
                 setLogLevel('Debug');

                 onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("User is signed in:", user.uid);
                        userId = user.uid;
                        welcomeOverlay.classList.add('hidden'); // User is in, hide welcome
                        
                        // NEW: Check if audio is ready. If not, show audio start button.
                        if (!isAudioReady) {
                            console.log("User is signed in, but audio not ready. Showing audio start button.");
                            audioOverlay.classList.remove('hidden');
                        } else {
                            // Audio is already ready, just start the clock
                            console.log("User signed in, audio ready. Starting clock.");
                            if (clockIntervalId) clearInterval(clockIntervalId);
                            updateClock(); // Run once immediately
                            clockIntervalId = setInterval(updateClock, 1000);
                        }

                        // Update UI
                        document.body.classList.add('authenticated');
                        userIdElement.textContent = user.isAnonymous ? `${user.uid} (Anonymous)` : `${user.email}`;

                        // Check for admin
                        if (ADMIN_EMAIL_LIST.includes(user.email)) {
                            console.log("Admin user detected.");
                            adminToggleBtn.disabled = false;
                            document.body.classList.add('admin-mode'); // Auto-enable admin mode
                            adminToggleBtn.textContent = 'Exit Admin';
                        } else {
                            console.log("Standard user detected.");
                            adminToggleBtn.disabled = true;
                            document.body.classList.remove('admin-mode');
                            adminToggleBtn.textContent = 'Admin Mode';
                        }
                        
                        // Setup collection ref
                        schedulesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'schedules');
                        
                        // Load data
                        await loadAllSchedules();
                        
                        if (isAudioReady) {
                            statusElement.textContent = "Connected. Monitoring bells...";
                        } else {
                            statusElement.textContent = "Connected. Waiting for audio.";
                        }


                     } else {
                        console.log("User is signed out.");
                        userId = null;
                        
                        // Stop clock
                        if (clockIntervalId) {
                            clearInterval(clockIntervalId);
                            clockIntervalId = null;
                        }
                        
                        // Reset UI
                        document.body.classList.remove('authenticated');
                        document.body.classList.remove('admin-mode');
                        userIdElement.textContent = "...";
                        adminToggleBtn.disabled = true;
                        
                        // Clear data
                        localSchedule = [];
                        allSchedules = [];
                        renderCombinedList();
                        renderScheduleSelector();
                        
                        // Reset countdown
                        countdownLine1.textContent = "Please sign in";
                        countdownTimer.textContent = "--:--:--";
                        countdownLine3.textContent = "to load the schedule.";

                        statusElement.textContent = "Please sign in to load schedules.";
                       
                        // Show welcome overlay
                        welcomeOverlay.classList.remove('hidden');
                        audioOverlay.classList.add('hidden'); // Hide audio overlay if signed out
                     }
                 });

            } catch (error) {
                console.error("Firebase Init Error:", error);
                statusElement.textContent = "Error connecting to Firebase.";
            }
        }

        async function signInWithGoogle() {
            if (!auth) return;
            // Start audio first, as this must be on a user gesture
            try {
                await startAudio();
                welcomeOverlay.classList.add('hidden'); // Hide immediately
            } catch(e) {
                console.error("Audio start failed on Google Sign-In", e);
                statusElement.textContent = "Audio failed to start. Please refresh.";
                return;
            }

            // Then, attempt sign in
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                console.log("Google Sign-In successful", result.user);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                statusElement.textContent = "Google Sign-In failed. Please try again.";
                // If auth failed, show the welcome screen again
                welcomeOverlay.classList.remove('hidden');
            }
        }

        async function signInAnon() {
            if (!auth) return;
            // Start audio first, as this must be on a user gesture
            try {
                await startAudio();
                welcomeOverlay.classList.add('hidden'); // Hide immediately
            } catch(e) {
                console.error("Audio start failed on Anonymous Sign-In", e);
                statusElement.textContent = "Audio failed to start. Please refresh.";
                return;
            }

            // Then, attempt sign in
            try {
                const result = await signInAnonymously(auth);
                console.log("Anonymous Sign-In successful", result.user);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                console.error("Anonymous Sign-In Error:", error);
                statusElement.textContent = "Anonymous Sign-In failed. Please try again.";
                // If auth failed, show the welcome screen again
                welcomeOverlay.classList.remove('hidden');
            }
        }

        async function signOutUser() {
            if (!auth) return;
            try {
                await signOut(auth);
                console.log("User signed out.");
                // onAuthStateChanged will handle UI reset
            } catch (error) {
                console.error("Sign Out Error:", error);
            }
        }
        
        async function loadAllSchedules() {
            if (!schedulesCollectionRef) return;

            try {
                const querySnapshot = await getDocs(schedulesCollectionRef);
                allSchedules = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    name: doc.data().name || "Unnamed Schedule",
                    bells: doc.data().bells || []
                }));

                // Sort schedules by name
                allSchedules.sort((a, b) => a.name.localeCompare(b.name));
                
                console.log("Loaded all schedules:", allSchedules.length);
                renderScheduleSelector();
                
            } catch (error) {
                console.error("Error loading all schedules: ", error);
                statusElement.textContent = "Error loading schedules.";
            }
        }

        function setActiveSchedule(scheduleId) {
            // Unsubscribe from the old schedule listener, if it exists
            if (activeScheduleListenerUnsubscribe) {
                activeScheduleListenerUnsubscribe();
            }

            if (!scheduleId) {
                console.warn("No schedule ID provided.");
                localSchedule = [];
                activeScheduleId = null;
                scheduleTitle.textContent = "No Schedule Selected";
                renderCombinedList();
                return;
            }
            
            console.log("Setting active schedule:", scheduleId);
            activeScheduleId = scheduleId;
            localStorage.setItem('activeScheduleId', scheduleId); // Remember choice

            // Get the doc reference for the new schedule
            scheduleRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', scheduleId);

            // Listen for real-time updates to this schedule
            activeScheduleListenerUnsubscribe = onSnapshot(scheduleRef, (docSnap) => {
                if (docSnap.exists()) {
                    const scheduleData = docSnap.data();
                    scheduleTitle.textContent = scheduleData.name;
                    localSchedule = (scheduleData.bells || []).map(bell => ({
                        ...bell,
                        type: 'shared' // Ensure type is set
                    }));
                    console.log("Active schedule updated:", localSchedule.length, "bells");
                    
                    // Update local allSchedules array
                    const index = allSchedules.findIndex(s => s.id === scheduleId);
                    if (index > -1) {
                        allSchedules[index].bells = scheduleData.bells || [];
                        allSchedules[index].name = scheduleData.name || "Unnamed Schedule";
                    }

                } else {
                    console.warn("Selected schedule does not exist.");
                    localSchedule = [];
                    scheduleTitle.textContent = "Schedule Not Found";
                    // It might have been deleted, reload all schedules
                    loadAllSchedules();
                }
                renderCombinedList();
            }, (error) => {
                console.error("Error on schedule snapshot:", error);
                statusElement.textContent = "Error loading schedule data.";
            });
        }

        async function handleCreateSchedule(e) {
            e.preventDefault();
            const name = newScheduleNameInput.value.trim();
            if (!name) return;
            
            try {
                // Add a new document with a generated ID
                const newDocRef = await addDoc(schedulesCollectionRef, {
                    name: name,
                    bells: [] // Start with an empty bell list
                });
                
                console.log("Schedule created with ID:", newDocRef.id);
                newScheduleNameInput.value = '';
                
                // Reload all schedules to update the dropdown
                await loadAllSchedules();
                
                // Automatically select the new schedule
                scheduleSelector.value = newDocRef.id;
                setActiveSchedule(newDocRef.id);
                
            } catch (error) {
                console.error("Error creating schedule:", error);
            }
        }
        
        async function handleAddSharedBell(e) {
            e.preventDefault();
            if (!activeScheduleId) {
                alert("Please select a schedule first.");
                return;
            }
            
            const time = sharedTimeInput.value;
            const name = sharedNameInput.value;
            const sound = sharedSoundInput.value;
            
            if (!time || !name) {
                alert("Please provide a time and name for the bell.");
                return;
            }

            const newBell = { time, name, sound };

            // Get the current schedule data
            const currentSchedule = allSchedules.find(s => s.id === activeScheduleId);
            if (!currentSchedule) {
                alert("Could not find current schedule data.");
                return;
            }
            
            const existingBells = currentSchedule.bells || [];
            
            // Check for duplicates
            if (existingBells.find(b => b.time === time && b.name === name)) {
                alert("This bell (time and name) already exists in this schedule.");
                return;
            }
            
            const updatedBells = [...existingBells, newBell];

            try {
                // Update the document with the new bells array
                await updateDoc(scheduleRef, {
                    bells: updatedBells
                });
                
                console.log("Shared bell added.");
                addSharedBellForm.reset();
                addSharedStatus.textContent = `Bell "${name}" added to ${currentSchedule.name}.`;
                addSharedStatus.classList.remove('hidden');
                setTimeout(() => addSharedStatus.classList.add('hidden'), 3000);
                
                // Our onSnapshot listener will handle the UI update
            } catch (error) {
                console.error("Error adding shared bell:", error);
                addSharedStatus.textContent = "Error adding bell.";
                addSharedStatus.classList.remove('hidden');
            }
        }
        
        async function handleDeleteSchedule() {
            if (!activeScheduleId) {
                alert("Please select a schedule to delete.");
                return;
            }
            
            const scheduleName = scheduleSelector.options[scheduleSelector.selectedIndex].text;
            confirmDeleteText.textContent = `Are you sure you want to delete "${scheduleName}"? This cannot be undone.`;
            confirmDeleteModal.classList.remove('hidden');
            
            // We'll wait for the confirmation button click...
        }
        
        async function confirmDeleteSchedule() {
            if (!activeScheduleId) return;
            
            const scheduleIdToDelete = activeScheduleId;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', scheduleIdToDelete);

            try {
                await deleteDoc(docRef);
                console.log("Schedule deleted:", scheduleIdToDelete);
                
                // Clear state
                activeScheduleId = null;
                localSchedule = [];
                
                // Reload schedule list
                await loadAllSchedules();
                
            } catch (error) {
                console.error("Error deleting schedule:", error);
            }
            
            confirmDeleteModal.classList.add('hidden');
        }

        // --- Event Delegation for Bell List ---
        function handleBellListClick(e) {
            const target = e.target;
            const bellElement = target.closest('[data-time]');
            if (!bellElement) return;

            const time = bellElement.dataset.time;
            const name = bellElement.dataset.name;
            const sound = bellElement.dataset.sound;
            const type = bellElement.dataset.type;

            if (target.classList.contains('delete-btn') || target.classList.contains('delete-custom-btn')) {
                // NEW: Use confirm modal
                bellToDelete = { time, name, type };
                confirmDeleteBellText.textContent = `Are you sure you want to delete the bell "${name}" at ${time}?`;
                confirmDeleteBellModal.classList.remove('hidden');
            } else if (target.classList.contains('edit-btn') || target.classList.contains('edit-custom-btn')) {
                handleEditBellClick(time, name, sound, type);
            }
        }

        async function confirmDeleteBell() {
            if (!bellToDelete) return;
            
            const { time, name, type } = bellToDelete;

            if (type === 'custom') {
                customBells = customBells.filter(b => !(b.time === time && b.name === name));
                saveCustomBells();
            } else if (type === 'shared') {
                // This bell belongs to the active shared schedule
                const currentSchedule = allSchedules.find(s => s.id === activeScheduleId);
                if (!currentSchedule) {
                    alert("Error: Could not find active schedule.");
                    return;
                }
                
                const updatedBells = currentSchedule.bells.filter(b => !(b.time === time && b.name === name));
                
                try {
                    await updateDoc(scheduleRef, { bells: updatedBells });
                    console.log("Shared bell deleted.");
                    // onSnapshot will update the UI
                } catch (error) {
                    console.error("Error deleting shared bell:", error);
                }
            }

            closeDeleteBellModal();
        }

        function closeDeleteBellModal() {
            confirmDeleteBellModal.classList.add('hidden');
            bellToDelete = null;
        }
        
        // --- Edit Bell Logic ---
        function handleEditBellClick(time, name, sound, type) {
            currentEditingBell = { 
                time, 
                name, 
                sound, 
                type, 
                originalTime: time, // Store original keys for finding it
                originalName: name,
                originalSound: sound // Store original sound
            };
            
            editBellTimeInput.value = time;
            editBellNameInput.value = name;
            editBellSoundInput.value = sound;
            
            editBellModal.classList.remove('hidden');
        }

        async function handleEditBellSubmit(e) {
            e.preventDefault();
            if (!currentEditingBell) return;

            const newBellData = {
                time: editBellTimeInput.value,
                name: editBellNameInput.value,
                sound: editBellSoundInput.value
            };
            
            const { originalTime, originalName, originalSound, type } = currentEditingBell;
            const originalBell = { time: originalTime, name: originalName, sound: originalSound };

            if (type === 'custom') {
                // Find and update in customBells array
                const index = customBells.findIndex(b => b.time === originalTime && b.name === originalName);
                if (index > -1) {
                    customBells[index] = { ...newBellData, type: 'custom' };
                    saveCustomBells();
                }
                closeEditBellModal();
            } else if (type === 'shared') {
                // For shared bells, we must check other schedules
                const linkedSchedules = findLinkedSchedules(originalBell);
                
                // Remove the *current* schedule from the list, as we're already editing it
                const otherLinkedSchedules = linkedSchedules.filter(s => s.id !== activeScheduleId);

                if (otherLinkedSchedules.length > 0) {
                    // Show confirmation modal
                    linkedEditData = {
                        originalBell,
                        newBellData,
                        linkedSchedules: otherLinkedSchedules
                    };
                    renderLinkedScheduleList(otherLinkedSchedules);
                    confirmLinkedEditModal.classList.remove('hidden');
                    // We pause the edit... it will be resumed by the linked modal's buttons
                } else {
                    // No other schedules are linked, just edit this one
                    await updateBellInSchedules(originalBell, newBellData, [activeScheduleId]);
                    closeEditBellModal();
                }
            }
        }

        function findLinkedSchedules(bellToFind) {
            const { time, name, sound } = bellToFind;
            const linked = [];
            
            for (const schedule of allSchedules) {
                const found = schedule.bells.find(b => 
                    b.time === time && b.name === name && b.sound === sound
                );
                if (found) {
                    linked.push({ id: schedule.id, name: schedule.name });
                }
            }
            return linked;
        }

        function renderLinkedScheduleList(schedules) {
            if (schedules.length === 0) {
                linkedScheduleList.innerHTML = '<p class="text-gray-500">No other schedules found.</p>';
                return;
            }
            linkedScheduleList.innerHTML = schedules.map(s => `
                <div class="flex items-center">
                    <input type="checkbox" id="linked-${s.id}" value="${s.id}" checked 
                           class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 linked-schedule-check">
                    <label for="linked-${s.id}" class="ml-2 block text-sm text-gray-900">${s.name}</label>
                </div>
            `).join('');
        }

        async function handleLinkedEdit(applyToAll) {
            if (!linkedEditData) return;
            
            const { originalBell, newBellData, linkedSchedules } = linkedEditData;
            let scheduleIdsToUpdate = [activeScheduleId]; // Always update the current one
            
            if (applyToAll) {
                // Get all *checked* schedule IDs from the modal
                const checkedSchedules = Array.from(document.querySelectorAll('.linked-schedule-check:checked'))
                                                .map(cb => cb.value);
                scheduleIdsToUpdate.push(...checkedSchedules);
            }
            
            linkedEditStatus.textContent = "Applying updates...";
            linkedEditStatus.classList.remove('hidden');

            try {
                await updateBellInSchedules(originalBell, newBellData, scheduleIdsToUpdate);
                console.log("Linked update successful.");
            } catch (error) {
                console.error("Linked update failed:", error);
            }
            
            closeLinkedEditModal();
            closeEditBellModal();
        }

        async function updateBellInSchedules(originalBell, newBellData, scheduleIds) {
            const batch = writeBatch(db);
            
            // Use a Set to avoid duplicate updates if activeScheduleId was also in the list
            const uniqueScheduleIds = [...new Set(scheduleIds)];
            
            for (const scheduleId of uniqueScheduleIds) {
                const schedule = allSchedules.find(s => s.id === scheduleId);
                if (!schedule) continue;

                const updatedBells = schedule.bells.map(bell => {
                    if (bell.time === originalBell.time && bell.name === originalBell.name && bell.sound === originalBell.sound) {
                        return newBellData; // Swap with new data
                    }
                    return bell;
                });

                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', scheduleId);
                batch.update(docRef, { bells: updatedBells });
            }

            await batch.commit();
            // onSnapshot will refresh the local data for the active schedule.
            // But we must also refresh allSchedules data to keep it in sync for future edits
            // Note: loadAllSchedules() will re-trigger the selector render and setActiveSchedule
            await loadAllSchedules();
        }
        
        function closeEditBellModal() {
            editBellModal.classList.add('hidden');
            currentEditingBell = null;
            editBellForm.reset();
        }
        
        function closeLinkedEditModal() {
            confirmLinkedEditModal.classList.add('hidden');
            linkedEditData = null;
            linkedScheduleList.innerHTML = '';
            linkedEditStatus.classList.add('hidden');
        }


        // --- Multi-Add Bell Modal Logic ---
        function showMultiAddModal() {
            // Populate the schedule list
            if (allSchedules.length === 0) {
                multiScheduleListContainer.innerHTML = '<p class="text-gray-500">No schedules found. Create one first.</p>';
            } else {
                multiScheduleListContainer.innerHTML = allSchedules.map(s => `
                    <div class="flex items-center">
                        <input type="checkbox" id="multi-${s.id}" value="${s.id}" 
                               class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 multi-schedule-check">
                        <label for="multi-${s.id}" class="ml-2 block text-sm text-gray-900">${s.name}</label>
                    </div>
                `).join('');
            }
            addBellModal.classList.remove('hidden');
        }

        function setMultiCheckboxes(checked) {
             document.querySelectorAll('.multi-schedule-check').forEach(cb => {
                cb.checked = checked;
            });
        }

        async function handleMultiAddSubmit(e) {
            e.preventDefault();
            
            const newBell = {
                time: multiBellTimeInput.value,
                name: multiBellNameInput.value,
                sound: multiBellSoundInput.value
            };
            
            if (!newBell.time || !newBell.name) {
                alert("Please provide a time and name.");
                return;
            }

            const checkedScheduleIds = Array.from(document.querySelectorAll('.multi-schedule-check:checked'))
                                                .map(cb => cb.value);
            
            if (checkedScheduleIds.length === 0) {
                alert("Please select at least one schedule.");
                return;
            }
            
            multiAddStatus.textContent = `Adding bell to ${checkedScheduleIds.length} schedule(s)...`;
            multiAddStatus.classList.remove('hidden');
            multiAddSubmitBtn.disabled = true;

            const batch = writeBatch(db);
            let errors = 0;
            let schedulesUpdatedNames = [];

            for (const scheduleId of checkedScheduleIds) {
                const schedule = allSchedules.find(s => s.id === scheduleId);
                if (!schedule) {
                    errors++;
                    continue;
                }
                
                // Add bell, but check for duplicates
                const bellExists = schedule.bells.find(b => b.time === newBell.time && b.name === newBell.name);
                if (!bellExists) {
                    const updatedBells = [...schedule.bells, newBell];
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', scheduleId);
                    batch.update(docRef, { bells: updatedBells });
                    schedulesUpdatedNames.push(schedule.name);
                }
            }

            try {
                await batch.commit();
                multiAddStatus.textContent = `Successfully added bell to ${schedulesUpdatedNames.length} schedule(s).`;
                // Refresh allSchedules data
                await loadAllSchedules();
                
                setTimeout(() => {
                    // NEW: Don't close modal, just reset
                    multiAddStatus.classList.add('hidden');
                    multiAddBellForm.reset();
                    multiBellSoundInput.value = 'ellisBell.mp3'; // Reset default
                    setMultiCheckboxes(false); // Uncheck all
                }, 2000);

            } catch (error) {
                console.error("Error in multi-add batch:", error);
                multiAddStatus.textContent = "An error occurred.";
            } finally {
                multiAddSubmitBtn.disabled = false;
            }
        }


        // --- Admin Mode ---
        function toggleAdminMode() {
            // Only admins can toggle
            if (auth.currentUser && ADMIN_EMAIL_LIST.includes(auth.currentUser.email)) {
                if (document.body.classList.contains('admin-mode')) {
                    document.body.classList.remove('admin-mode');
                    adminToggleBtn.textContent = 'Enter Admin';
                } else {
                    document.body.classList.add('admin-mode');
                    adminToggleBtn.textContent = 'Exit Admin';
                }
            }
        }
        
        // --- Mute Logic ---
        function toggleMuteAll() {
            isMutedAll = !isMutedAll;
            if (isMutedAll) {
                muteAllBtn.textContent = "Unmute All";
                muteAllBtn.classList.add('muted');
                statusElement.textContent = "All bells are muted.";
            } else {
                muteAllBtn.textContent = "Mute All Bells";
                muteAllBtn.classList.remove('muted');
                statusElement.textContent = "Monitoring...";
            }
        }

        function handleMuteNext() {
            // Find the next bell
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const currentTimeHHMMSS = `${hours}:${minutes}:${seconds}`;

            const allBells = [...localSchedule, ...customBells];
            allBells.sort((a, b) => a.time.localeCompare(b.time));
            
            let nextBell = null;
            let upcomingBells = allBells.filter(bell => bell.time > currentTimeHHMMSS);
            
            if (upcomingBells.length > 0) {
                nextBell = upcomingBells[0];
            } else if (allBells.length > 0) {
                nextBell = allBells[0]; // First bell of "tomorrow"
            }

            if (nextBell) {
                const bellId = `${nextBell.time}-${nextBell.name}`;
                mutedNextBell = bellId;
                statusElement.textContent = `Muted next bell: ${nextBell.name}`;
                countdownLine3.textContent = `until ${nextBell.name} (MUTED)`; // Update immediately
                muteNextBtn.textContent = "Next Bell Muted";
                muteNextBtn.disabled = true;
            } else {
                statusElement.textContent = "No bells to mute.";
            }
        }


        // --- Init and Event Listeners ---
        function init() {
            // NEW: Init Firebase first thing
            initFirebase(); // This just sets up the listeners

            // NEW: Auth button listeners
            googleStartBtn.addEventListener('click', signInWithGoogle);
            anonymousStartBtn.addEventListener('click', signInAnon);
            signOutBtn.addEventListener('click', signOutUser);
            
            // NEW: Audio start button (for refresh)
            startAudioBtn.addEventListener('click', () => {
                startAudio().then(() => {
                    audioOverlay.classList.add('hidden');
                }).catch(e => {
                    console.error("Manual audio start failed:", e);
                });
            });

            // Schedule selection
            scheduleSelector.addEventListener('change', () => {
                setActiveSchedule(scheduleSelector.value);
            });
            
            // Admin controls
            adminToggleBtn.addEventListener('click', toggleAdminMode);

            // Forms
            addCustomBellForm.addEventListener('submit', handleAddCustomBell);
            addSharedBellForm.addEventListener('submit', handleAddSharedBell);
            createScheduleForm.addEventListener('submit', handleCreateSchedule);

            // Delete Schedule Modal
            deleteScheduleBtn.addEventListener('click', handleDeleteSchedule);
            deleteConfirmBtn.addEventListener('click', confirmDeleteSchedule);
            deleteCancelBtn.addEventListener('click', () => confirmDeleteModal.classList.add('hidden'));

            // Delete Bell Modal
            deleteBellConfirmBtn.addEventListener('click', confirmDeleteBell);
            deleteBellCancelBtn.addEventListener('click', closeDeleteBellModal);

            // Multi-Add Modal
            showAddBellModalBtn.addEventListener('click', showMultiAddModal);
            multiAddBellForm.addEventListener('submit', handleMultiAddSubmit);
            multiAddCancelBtn.addEventListener('click', () => {
                addBellModal.classList.add('hidden');
                multiAddBellForm.reset();
                multiBellSoundInput.value = 'ellisBell.mp3'; // Reset default
            });
            multiSelectAllBtn.addEventListener('click', () => setMultiCheckboxes(true));
            multiSelectNoneBtn.addEventListener('click', () => setMultiCheckboxes(false));
            
            // Edit Bell Modal
            editBellForm.addEventListener('submit', handleEditBellSubmit);
            editBellCancelBtn.addEventListener('click', closeEditBellModal);
            
            // Linked Edit Modal
            linkedEditCancel.addEventListener('click', closeLinkedEditModal);
            linkedEditThisOnly.addEventListener('click', () => handleLinkedEdit(false));
            linkedEditApply.addEventListener('click', () => handleLinkedEdit(true));

            // Sound previews
            previewCustomSoundBtn.addEventListener('click', () => playBell(customSoundInput.value));
            previewSharedSoundBtn.addEventListener('click', () => playBell(sharedSoundInput.value));
            
            // Event delegation for bell list
            combinedBellListElement.addEventListener('click', handleBellListClick);
            
            // Mute Buttons
            muteAllBtn.addEventListener('click', toggleMuteAll);
            muteNextBtn.addEventListener('click', handleMuteNext);
            
            // Load custom bells from local storage
            loadCustomBells();
        }

        // --- Start the App ---
        init();

    </script>
</body>
</html>

