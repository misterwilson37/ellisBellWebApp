<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Bell Web App</title>
    <!-- Using Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Using Tone.js for web audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        // Use Century Gothic, with Questrial as a web-safe fallback
                        sans: ['Century Gothic', 'Questrial', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <!-- Updated Google Font to include Questrial as a Century Gothic fallback -->
    <link href="https://fonts.googleapis.com/css2?family=Questrial&display=swap" rel="stylesheet">
    <style>
        body {
            /* Apply the new font stack */
            font-family: 'Century Gothic', 'Questrial', 'sans-serif';
        }
        /* Styles for Admin Controls */
        /* Hide admin controls and shared delete/edit buttons by default */
        .admin-control, #combined-bell-list .delete-btn, #combined-bell-list .edit-btn {
            display: none;
        }
        /* When body has .admin-mode, show them */
        body.admin-mode .admin-control {
            display: block; 
        }
        /* Show shared delete/edit buttons in admin mode */
        body.admin-mode #combined-bell-list .delete-btn,
        body.admin-mode #combined-bell-list .edit-btn {
            display: inline-block;
        }
        /* Always show custom delete/edit buttons */
        #combined-bell-list .delete-custom-btn,
        #combined-bell-list .edit-custom-btn {
            display: inline-block;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans"> <!-- Added font-sans to apply tailwind default -->

    <!-- Audio Start Overlay -->
    <div id="audio-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <button id="start-audio-btn" class="px-8 py-4 bg-blue-600 text-white font-bold text-2xl rounded-lg shadow-lg hover:bg-blue-700 transition-colors">
            Click to Start School Bell
        </button>
    </div>

    <!-- Admin Password Modal -->
    <div id="admin-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-medium mb-4">Admin Access</h3>
            <label for="admin-password" class="block text-sm font-medium text-gray-700">Password</label>
            <input type="password" id="admin-password" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <p id="admin-error" class="text-red-500 text-sm mt-2 hidden">Incorrect password.</p>
            <div class="mt-6 flex justify-end gap-3">
                <button id="admin-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="admin-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Login</button>
            </div>
        </div>
    </div>

    <!-- NEW: Add Bell to Multiple Schedules Modal -->
    <div id="add-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 hidden">
        <form id="multi-add-bell-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-medium mb-6">Add Bell to Schedules</h3>
            
            <!-- Bell Details -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="multi-bell-time" class="block text-sm font-medium text-gray-700">Time (HH:MM:SS)</label>
                    <input type="time" id="multi-bell-time" step="1" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="multi-bell-name" class="block text-sm font-medium text-gray-700">Bell Name</label>
                    <input type="text" id="multi-bell-name" placeholder="e.g. 1st Period End" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div>
                <label for="multi-bell-sound" class="block text-sm font-medium text-gray-700">Sound</label>
                <select id="multi-bell-sound" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="Bell">Bell</option>
                    <option value="Chime">Chime</option>
                    <option value="Beep">Beep</option>
                    <option value="Alarm">Alarm</option>
                    <option value="ellisBell.mp3">Ellis Bell</option>
                </select>
            </div>

            <!-- Schedule Checkboxes -->
            <div class="mt-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Schedules to Add to:</label>
                <div id="multi-schedule-list-container" class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4 grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <!-- Checkboxes will be dynamically injected here -->
                    <p class="text-gray-500">Loading schedules...</p>
                </div>
            </div>
            
            <p id="multi-add-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="multi-add-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" id="multi-add-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Bell</button>
            </div>
        </form>
    </div>

    <!-- NEW: Edit Bell Modal -->
    <div id="edit-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <form id="edit-bell-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-medium mb-6">Edit Bell</h3>
            
            <!-- Bell Details -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="edit-bell-time" class="block text-sm font-medium text-gray-700">Time (HH:MM:SS)</label>
                    <input type="time" id="edit-bell-time" step="1" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="edit-bell-name" class="block text-sm font-medium text-gray-700">Bell Name</label>
                    <input type="text" id="edit-bell-name" placeholder="e.g. 1st Period End" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div>
                <label for="edit-bell-sound" class="block text-sm font-medium text-gray-700">Sound</label>
                <select id="edit-bell-sound" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="Bell">Bell</option>
                    <option value="Chime">Chime</option>
                    <option value="Beep">Beep</option>
                    <option value="Alarm">Alarm</option>
                    <option value="ellisBell.mp3">Ellis Bell</option>
                </select>
            </div>
            
            <p id="edit-bell-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="edit-bell-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" id="edit-bell-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
            </div>
        </form>
    </div>

    <!-- NEW: Confirm Linked Edit Modal -->
    <div id="confirm-linked-edit-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-xl font-medium mb-4">Update Linked Schedules?</h3>
            <p class="text-gray-700 mb-4">This bell was found in other schedules. Do you want to apply your edit to them as well?</p>
            
            <p class="text-sm font-medium text-gray-700 mb-2">Schedules containing this bell:</p>
            <div id="linked-schedule-list" class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4 grid grid-cols-1 sm:grid-cols-2 gap-2">
                <!-- Linked schedules will be injected here -->
            </div>
            
            <p id="linked-edit-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <div class="mt-6 flex flex-col sm:flex-row justify-end gap-3">
                <button id="linked-edit-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</Object>
                <button id="linked-edit-this-only" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">Update This Schedule Only</button>
                <button id="linked-edit-apply" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Apply to All Selected</button>
            </div>
        </div>
    </div>


    <!-- NEW: Confirm Delete Schedule Modal -->
    <div id="confirm-delete-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-medium mb-4">Delete Schedule</h3>
            <p id="confirm-delete-text" class="text-gray-700 mb-6">Are you sure you want to delete this schedule? This action cannot be undone.</p>
            <div class="mt-6 flex justify-end gap-3">
                <button id="delete-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="delete-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="container mx-auto max-w-2xl p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-700">School Bell</h1>
            <p class="text-lg text-gray-600">A real-time, synchronized bell schedule</p>
            <p class="text-sm text-gray-500 mt-2">Your User ID (for reference): <code id="userIdDisplay" class="bg-gray-200 px-2 py-1 rounded">...</code></p>
        </header>

        <!-- Live Clock -->
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-md mb-8">
            <div id="live-clock" class="text-6xl md:text-8xl font-bold text-center text-gray-800 tabular-nums">
                00:00:00
            </div>
            <div class="text-center text-gray-500 text-lg mt-2">
                Status: <span id="status-message" class="font-medium text-gray-700">Initializing...</span>
            </div>
            <div class="text-center text-gray-500 text-sm mt-1">
                Next Bell: <span id="next-bell-message" class="font-medium text-gray-700">--:--</span>
            </div>
        </div>

        <!-- Combined Bell Schedule List -->
        <div>
            <h2 id="schedule-title" class="text-2xl font-semibold mb-4">Current Schedule</h2>
            <div id="combined-bell-list" class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
                <!-- Bells will be injected here by JavaScript -->
                <div class="p-8 text-center text-gray-500">
                    Loading schedule...
                </div>
            </div>
        </div>

        <!-- Schedule Selector -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <div class="flex justify-between items-center mb-2">
                <label for="schedule-selector" class="block text-lg font-medium text-gray-700">Active Shared Schedule</label>
                <button id="admin-toggle" class="px-3 py-1 text-sm bg-gray-200 text-gray-800 rounded-full hover:bg-gray-300 transition-colors">
                    Toggle Admin
                </button>
            </div>
            <select id="schedule-selector" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg">
                <option value="">Loading schedules...</option>
            </select>
            
            <!-- NEW: Admin button to delete the selected schedule -->
            <!-- MOVED this button to the main Admin Zone below -->
        </div>
        
        <!-- NEW: Admin Zone for creating schedules and adding bells -->
        <div class="admin-control bg-white p-6 rounded-xl shadow-md mb-8 space-y-6">
            <h3 class="text-xl font-semibold text-gray-800 border-b pb-2">Admin Zone</h3>
            
            <!-- Create New Schedule Form -->
            <form id="create-schedule-form">
                <label for="new-schedule-name" class="block text-sm font-medium text-gray-700 mb-1">Create New Schedule</label>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="new-schedule-name" placeholder="New Schedule Name" required class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700">
                        Create
                    </button>
                </div>
            </form>

            <!-- NEW: Add Bell to THIS Schedule Form -->
            <form id="add-shared-bell-form" class="border-t pt-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Add Bell to This Schedule</label>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="shared-bell-time" class="block text-sm font-medium text-gray-700 mb-1">Time (HH:MM:SS)</label>
                        <input type="time" id="shared-bell-time" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="shared-bell-name" class="block text-sm font-medium text-gray-700 mb-1">Bell Name</label>
                        <input type="text" id="shared-bell-name" placeholder="e.g. 1st Period Start" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-end gap-4">
                    <div class="flex-grow" style="min-width: 120px;">
                        <label for="shared-bell-sound" class="block text-sm font-medium text-gray-700 mb-1">Sound</label>
                        <select id="shared-bell-sound" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Bell">Bell</option>
                            <option value="Chime">Chime</option>
                            <option value="Beep">Beep</option>
                            <option value="Alarm">Alarm</option>
                            <option value="ellisBell.mp3">Ellis Bell</option>
                        </select>
                    </div>
                    <button type="button" id="preview-shared-sound" class="px-4 py-2 text-2xl bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview sound">
                        ▶
                    </button>
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Add Shared Bell
                    </button>
                </div>
                <p id="add-shared-status" class="text-blue-600 text-sm mt-3 hidden"></p>
            </form>

            <!-- Add Bell to Schedules Button -->
            <div class="border-t pt-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Add Bell to Multiple Schedules</label>
                <button type="button" id="show-add-bell-modal-btn" class="w-full px-6 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700">
                    Add Bell to Schedules...
                </button>
            </div>

            <!-- MOVED: Delete Selected Schedule Button -->
            <div class="border-t pt-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Delete Current Schedule</label>
                <button id="delete-schedule-btn" class="w-full px-4 py-2 bg-red-600 text-white font-medium rounded-lg shadow-md hover:bg-red-700 transition-colors">
                    Delete Selected Schedule
                </button>
            </div>
        </div>


        <!-- Custom Bells (Local) -->
        <div class="mt-12">
            <h2 class="text-2xl font-semibold mb-4">My Custom Bells (This Browser Only)</h2>

            <!-- Add Custom Bell Form -->
            <form id="add-custom-bell-form" class="bg-white p-6 rounded-xl shadow-md mb-8">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="custom-bell-time" class="block text-sm font-medium text-gray-700 mb-1">Time (HH:MM:SS)</label>
                        <input type="time" id="custom-bell-time" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <!-- NEW: Custom Bell Name -->
                    <div>
                        <label for="custom-bell-name" class="block text-sm font-medium text-gray-700 mb-1">Bell Name</label>
                        <input type="text" id="custom-bell-name" placeholder="e.g. My Reminder" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-end gap-4">
                    <div class="flex-grow" style="min-width: 120px;">
                        <label for="custom-bell-sound" class="block text-sm font-medium text-gray-700 mb-1">Sound</label>
                        <select id="custom-bell-sound" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Bell">Bell</option>
                            <option value="Chime">Chime</option>
                            <option value="Beep">Beep</option>
                            <option value="Alarm">Alarm</option>
                            <option value="ellisBell.mp3">Ellis Bell</option>
                        </select>
                    </div>
                    <button type="button" id="preview-custom-sound" class="px-4 py-2 text-2xl bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview sound">
                        ▶
                    </button>
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Add Custom Bell
                    </button>
                </div>
            </form>
        </div>

    </div>

        <!-- Firebase and App Logic -->
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, getDocs, writeBatch, setLogLevel, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // REMOVED: App Check import

        // --- DOM Elements ---
        const audioOverlay = document.getElementById('audio-overlay');
        const startAudioBtn = document.getElementById('start-audio-btn');
        const clockElement = document.getElementById('live-clock');
        const statusElement = document.getElementById('status-message');
        const nextBellElement = document.getElementById('next-bell-message');
        const userIdElement = document.getElementById('userIdDisplay');
        const scheduleSelector = document.getElementById('schedule-selector');
        const scheduleTitle = document.getElementById('schedule-title');
        const adminToggleBtn = document.getElementById('admin-toggle');
        const adminModal = document.getElementById('admin-modal');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminSubmitBtn = document.getElementById('admin-submit');
        const adminCancelBtn = document.getElementById('admin-cancel');
        const adminError = document.getElementById('admin-error');
        
        // Custom Bell Form
        const addCustomBellForm = document.getElementById('add-custom-bell-form');
        const customTimeInput = document.getElementById('custom-bell-time');
        const customNameInput = document.getElementById('custom-bell-name'); // New
        const customSoundInput = document.getElementById('custom-bell-sound');
        
        // NEW: Add Shared Bell Form (in Admin Zone)
        const addSharedBellForm = document.getElementById('add-shared-bell-form');
        const sharedTimeInput = document.getElementById('shared-bell-time');
        const sharedNameInput = document.getElementById('shared-bell-name');
        const sharedSoundInput = document.getElementById('shared-bell-sound');
        const previewSharedSoundBtn = document.getElementById('preview-shared-sound');
        const addSharedStatus = document.getElementById('add-shared-status');

        // Combined List
        const combinedBellListElement = document.getElementById('combined-bell-list');
        const previewCustomSoundBtn = document.getElementById('preview-custom-sound');
        
        // NEW: Multi-Add Bell Modal
        const addBellModal = document.getElementById('add-bell-modal');
        const showAddBellModalBtn = document.getElementById('show-add-bell-modal-btn');
        const multiAddBellForm = document.getElementById('multi-add-bell-form');
        const multiBellTimeInput = document.getElementById('multi-bell-time');
        const multiBellNameInput = document.getElementById('multi-bell-name');
        const multiBellSoundInput = document.getElementById('multi-bell-sound');
        const multiScheduleListContainer = document.getElementById('multi-schedule-list-container');
        const multiAddCancelBtn = document.getElementById('multi-add-cancel');
        const multiAddSubmitBtn = document.getElementById('multi-add-submit');
        const multiAddStatus = document.getElementById('multi-add-status');

        // NEW: Edit Bell Modal
        const editBellModal = document.getElementById('edit-bell-modal');
        const editBellForm = document.getElementById('edit-bell-form');
        const editBellTimeInput = document.getElementById('edit-bell-time');
        const editBellNameInput = document.getElementById('edit-bell-name');
        const editBellSoundInput = document.getElementById('edit-bell-sound');
        const editBellCancelBtn = document.getElementById('edit-bell-cancel');
        const editBellSubmitBtn = document.getElementById('edit-bell-submit');
        const editBellStatus = document.getElementById('edit-bell-status');

        // NEW: Linked Edit Modal
        const confirmLinkedEditModal = document.getElementById('confirm-linked-edit-modal');
        const linkedScheduleList = document.getElementById('linked-schedule-list');
        const linkedEditStatus = document.getElementById('linked-edit-status');
        const linkedEditCancel = document.getElementById('linked-edit-cancel');
        const linkedEditThisOnly = document.getElementById('linked-edit-this-only');
        const linkedEditApply = document.getElementById('linked-edit-apply');

        // NEW: Create/Delete Schedule
        const createScheduleForm = document.getElementById('create-schedule-form');
        const newScheduleNameInput = document.getElementById('new-schedule-name');
        const deleteScheduleBtn = document.getElementById('delete-schedule-btn');
        const confirmDeleteModal = document.getElementById('confirm-delete-modal');
        const confirmDeleteText = document.getElementById('confirm-delete-text');
        const deleteConfirmBtn = document.getElementById('delete-confirm');

        // --- App State ---
        let db, auth;
        let userId;
        // BELLS ARE NOW { time, name, sound }
        let localSchedule = []; // Holds array of SHARED bells
        let customBells = []; // Holds array of CUSTOM bells
        let scheduleRef; // Firestore document reference TO THE ACTIVE SCHEDULE
        let schedulesCollectionRef; // Reference to the collection of all schedules
        let allSchedules = []; // Array of { id, name }
        let activeScheduleId = null;
        let activeScheduleListenerUnsubscribe = null; // Function to stop listening to old schedule
        let synths = {}; // To hold Tone.js synthesizers AND players
        let lastBellRingTime = null; // To prevent duplicate rings
        
        // NEW: State for editing bells
        let currentEditingBell = null; // Stores { time, name, sound, type } of the bell being edited
        let linkedEditData = null; // Stores data for the linked edit confirmation

        // Use the Project ID from your config for the Firestore data path
        const appId = "ellisbell-c185c"; 

        // --- Default Schedules (for seeding) ---
        const SCHEDULE_DEFAULTS = [
            { id: "6th-grade-a", name: "6th Grade A" },
            { id: "6th-grade-b", name: "6th Grade B" },
            { id: "7th-grade-a", name: "7th Grade A" },
            { id: "7th-grade-b", name: "7th Grade B" },
            { id: "8th-grade", name: "8th Grade" },
            { id: "related-arts-a", name: "Related Arts A" },
            { id: "related-arts-b", name: "Related Arts B" },
        ];

        // --- Audio Setup (Tone.js) ---
        function setupSynths() {
            // Using .toDestination() connects the synth to the speakers
            synths['Bell'] = new Tone.MetalSynth({
                frequency: 200,
                envelope: { attack: 0.001, decay: 0.4, release: 0.2 },
                harmonicity: 5.1,
                modulationIndex: 32,
                resonance: 4000,
                octaves: 1.5
            }).toDestination();

            synths['Chime'] = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 1 }
            }).toDestination();

            synths['Beep'] = new Tone.Synth({
                oscillator: { type: 'square' },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.05 }
            }).toDestination();

            synths['Alarm'] = new Tone.MonoSynth({
                oscillator: { type: "sine" },
                envelope: { attack: 0.1, decay: 0.2, release: 0.1 }
            }).toDestination();
            
            // Assumes 'ellisBell.mp3' is in the same directory as this HTML file.
            synths['ellisBell.mp3'] = new Tone.Player("ellisBell.mp3").toDestination();
        }

        function playBell(soundName) {
            if (!synths[soundName]) {
                console.warn(`Sound '${soundName}' not found.`);
                return;
            }

            const now = Tone.now();
            const synth = synths[soundName];

            try {
                if (synth instanceof Tone.Player) {
                    synth.start(now);
                } else {
                    if (soundName === 'Bell') {
                        synth.triggerAttackRelease('C4', '0.5', now);
                        synth.triggerAttackRelease('G4', '0.5', now + 0.3);
                    } else if (soundName === 'Chime') {
                        synth.triggerAttackRelease('G5', '0.8', now);
                        synth.triggerAttackRelease('E6', '0.8', now + 0.5);
                    } else if (soundName === 'Beep') {
                        synth.triggerAttackRelease('A5', '0.1', now);
                    } else if (soundName === 'Alarm') {
                        synth.triggerAttackRelease("C5", "0.1", now);
                        synth.triggerAttackRelease("C5", "0.1", now + 0.15);
                        synth.triggerAttackRelease("C5", "0.1", now + 0.3);
                    }
                }
                statusElement.textContent = `Previewing: ${soundName}`;
            } catch (error) {
                console.error("Error playing sound:", error);
            }
        }

        // --- Clock and Bell Logic ---
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            const currentTimeHHMMSS = `${hours}:${minutes}:${seconds}`;

            clockElement.textContent = currentTimeHHMMSS;

            // Check if a bell should ring
            const bellToRing = localSchedule.find(bell => bell.time === currentTimeHHMMSS) ||
                               customBells.find(bell => bell.time === currentTimeHHMMSS);
            
            if (bellToRing && lastBellRingTime !== currentTimeHHMMSS) {
                // Use a different function for actual ringing to not say "Previewing"
                ringBell(bellToRing); // Pass the whole bell object
                lastBellRingTime = currentTimeHHMMSS;
            }
            
            if (lastBellRingTime && lastBellRingTime !== currentTimeHHMMSS) {
                 lastBellRingTime = null;
                 statusElement.textContent = "Monitoring...";
            }

            // Update next bell time
            updateNextBellMessage(currentTimeHHMMSS);

            requestAnimationFrame(updateClock); // Loop
        }
        
        // UPDATED: Now takes a bell object
        function ringBell(bell) {
            playBell(bell.sound); // Call the main play function
            statusElement.textContent = `Ringing: ${bell.name} (${bell.sound})`; // Overwrite status
        }

        // UPDATED: To show bell name
        function updateNextBellMessage(currentTimeHHMMSS) {
            const allBells = [...localSchedule, ...customBells];
            const sortedBells = allBells.sort((a, b) => a.time.localeCompare(b.time));
            const nextBell = sortedBells.find(bell => bell.time > currentTimeHHMMSS);
            
            if (nextBell) {
                nextBellElement.textContent = `${nextBell.time} - ${nextBell.name}`;
            } else if (sortedBells.length > 0) {
                // Wrap to tomorrow
                nextBellElement.textContent = `Tomorrow ${sortedBells[0].time} - ${sortedBells[0].name}`;
            } else {
                nextBellElement.textContent = "--:--";
            }
        }


        // --- UI Rendering ---

        /**
         * UPDATED: Renders the single, combined, chronological list of bells with names.
         */
        function renderCombinedList() {
            const sharedBells = localSchedule.map(bell => ({ ...bell, type: 'shared' }));
            const customBellsList = customBells.map(bell => ({ ...bell, type: 'custom' }));
            
            const allBells = [...sharedBells, ...customBellsList];
            allBells.sort((a, b) => a.time.localeCompare(b.time));

            const activeSchedule = allSchedules.find(s => s.id === activeScheduleId);
            scheduleTitle.textContent = activeSchedule ? `${activeSchedule.name} Schedule` : 'Current Schedule';

            if (allBells.length === 0) {
                combinedBellListElement.innerHTML = `<div class="p-8 text-center text-gray-500">No bells scheduled.</div>`;
                return;
            }

            combinedBellListElement.innerHTML = ""; // Clear list
            allBells.forEach(bell => {
                const bellDiv = document.createElement('div');
                
                const isShared = bell.type === 'shared';
                
                // Style distinctions
                const textClass = isShared ? 'font-medium text-gray-800' : 'italic text-gray-600';
                const label = isShared ? '' : '(custom)';
                
                const deleteButtonClass = isShared ? 'delete-btn' : 'delete-custom-btn'; 
                const editButtonClass = isShared ? 'edit-btn' : 'edit-custom-btn'; 

                bellDiv.className = "flex items-center justify-between p-4 border-b border-gray-200 last:border-b-0";
                
                // NEW: Added bell.name
                bellDiv.innerHTML = `
                    <div class="flex items-center gap-4">
                        <span class="text-xl font-mono bg-gray-100 px-3 py-1 rounded">${bell.time}</span>
                        <div>
                            <span class="${textClass}">${bell.name || 'Untitled'}</span>
                            <span class="block text-sm text-gray-500">
                                ${bell.sound} ${label}
                            </span>
                        </div>
                    </div>
                    <div class="flex-shrink-0">
                        <button data-time="${bell.time}" data-name="${bell.name || 'Untitled'}" data-sound="${bell.sound}" data-type="${bell.type}"
                                class="${editButtonClass} text-blue-600 hover:text-blue-800 font-medium transition-colors mr-3">
                            Edit
                        </button>
                        <button data-time="${bell.time}" data-type="${bell.type}" 
                                class="${deleteButtonClass} text-red-500 hover:text-red-700 font-medium transition-colors">
                            Delete
                        </button>
                    </div>
                `;
                combinedBellListElement.appendChild(bellDiv);
            });
        }

        function renderScheduleDropdown() {
            scheduleSelector.innerHTML = ''; // Clear options
            if (allSchedules.length === 0) {
                scheduleSelector.innerHTML = '<option value="">No schedules found...</option>';
                return;
            }

            allSchedules.forEach(schedule => {
                const option = document.createElement('option');
                option.value = schedule.id;
                option.textContent = schedule.name;
                if (schedule.id === activeScheduleId) {
                    option.selected = true;
                }
                scheduleSelector.appendChild(option);
            });
        }
        
        // NEW: Renders checkboxes for the multi-add modal
        function renderMultiAddScheduleList() {
            multiScheduleListContainer.innerHTML = ''; // Clear
            if (allSchedules.length === 0) {
                multiScheduleListContainer.innerHTML = '<p class="text-gray-500">No schedules found to add to.</p>';
                return;
            }
            
            allSchedules.forEach(schedule => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input type="checkbox" id="schedule-check-${schedule.id}" value="${schedule.id}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="schedule-check-${schedule.id}" class="ml-3 block text-sm font-medium text-gray-700">${schedule.name}</label>
                `;
                multiScheduleListContainer.appendChild(div);
            });
        }

        // --- Firestore Logic ---
        async function updateActiveScheduleBells() {
            if (!scheduleRef) return;
            try {
                // Use updateDoc to update just the bells array on the active schedule document
                await updateDoc(scheduleRef, { bells: localSchedule });
            } catch (error) {
                console.error("Error updating Firestore schedule: ", error);
            }
        }

        /**
         * Creates the 7 default schedules if they don't exist.
         */
        async function checkAndSeedSchedules() {
            const snapshot = await getDocs(schedulesCollectionRef);
            if (snapshot.empty) {
                console.log("No schedules found, seeding database...");
                const batch = writeBatch(db);

                // Add all 7 schedule documents
                SCHEDULE_DEFAULTS.forEach(schedule => {
                    const newScheduleRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', schedule.id);
                    batch.set(newScheduleRef, { name: schedule.name, bells: [] });
                });
                
                await batch.commit();
                console.log("Database seeded successfully.");
            }
        }
        
        /**
         * Listens to the collection of all schedules to populate the dropdown.
         */
        function listenToSchedulesCollection() {
            onSnapshot(schedulesCollectionRef, (snapshot) => {
                allSchedules = [];
                snapshot.forEach(doc => {
                    allSchedules.push({ id: doc.id, ...doc.data() });
                });
                // Sort schedules by name
                allSchedules.sort((a, b) => a.name.localeCompare(b.name));
                
                // If the active schedule was just deleted, update it
                if (activeScheduleId && !allSchedules.some(s => s.id === activeScheduleId)) {
                    console.log("Active schedule was deleted. Finding new one.");
                    const newActiveId = allSchedules.length > 0 ? allSchedules[0].id : null;
                    activeScheduleId = newActiveId;
                    localStorage.setItem('schoolBell-activeScheduleId', newActiveId);
                    listenToActiveScheduleDoc(newActiveId); // Switch listener
                }
                
                renderScheduleDropdown();
                renderMultiAddScheduleList(); // NEW: Update the modal too
            }, (error) => {
                console.error("Error listening to schedules collection:", error);
            });
        }

        /**
         * Listens to the currently active schedule document for its bells.
         */
        function listenToActiveScheduleDoc(scheduleId) {
            // Unsubscribe from the old schedule listener, if it exists
            if (activeScheduleListenerUnsubscribe) {
                activeScheduleListenerUnsubscribe();
            }

            localSchedule = []; // Clear old data
            renderCombinedList(); // Render empty state
            
            if (!scheduleId) {
                scheduleTitle.textContent = "No Schedule Selected";
                statusElement.textContent = "No schedule selected.";
                return;
            }
            
            // Create a new reference to the active schedule
            scheduleRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', scheduleId);

            // Subscribe to the new schedule
            activeScheduleListenerUnsubscribe = onSnapshot(scheduleRef, (docSnap) => {
                if (docSnap.exists()) {
                    localSchedule = docSnap.data().bells || [];
                } else {
                    localSchedule = []; // Doc was deleted
                }
                renderCombinedList(); // Re-render the combined list
                statusElement.textContent = "Monitoring...";
            }, (error) => {
                console.error("Error listening to active schedule doc: ", error);
                statusElement.textContent = "Connection error!";
            });
        }
        
        // --- Custom Bell Logic (LocalStorage) ---
        function loadCustomBells() {
            const bellsJSON = localStorage.getItem('schoolBell-customBells');
            if (bellsJSON) {
                customBells = JSON.parse(bellsJSON);
            } else {
                customBells = [];
            }
            renderCombinedList(); // Render the combined list
        }

        function saveCustomBells() {
            localStorage.setItem('schoolBell-customBells', JSON.stringify(customBells));
        }

        // --- Admin Mode Logic ---
        function toggleAdminMode(enable) {
            if (enable) {
                document.body.classList.add('admin-mode');
                adminToggleBtn.textContent = 'Admin Mode: ON';
                adminToggleBtn.classList.add('bg-blue-600', 'text-white');
                adminToggleBtn.classList.remove('bg-gray-200', 'text-gray-800');
            } else {
                document.body.classList.remove('admin-mode');
                adminToggleBtn.textContent = 'Toggle Admin';
                adminToggleBtn.classList.remove('bg-blue-600', 'text-white');
                adminToggleBtn.classList.add('bg-gray-200', 'text-gray-800');
            }
            // Re-render the list to show/hide delete buttons correctly
            renderCombinedList();
        }
        
        // --- Event Handlers ---
        
        // NEW: Add Bell to Multiple Schedules
        async function handleAddBellToMultiple(e) {
            e.preventDefault();
            multiAddSubmitBtn.disabled = true;
            multiAddStatus.textContent = 'Adding bells...';
            multiAddStatus.classList.remove('hidden');

            const newBell = {
                time: multiBellTimeInput.value,
                name: multiBellNameInput.value,
                sound: multiBellSoundInput.value
            };

            // Get all checked schedule IDs
            const checkedBoxes = multiScheduleListContainer.querySelectorAll('input[type="checkbox"]:checked');
            const targetScheduleIds = Array.from(checkedBoxes).map(cb => cb.value);

            if (targetScheduleIds.length === 0) {
                multiAddStatus.textContent = 'Please select at least one schedule.';
                multiAddSubmitBtn.disabled = false;
                return;
            }

            // Loop and update each doc. We read-then-write, so batch isn't ideal.
            let successCount = 0;
            let skippedCount = 0;
            const promises = targetScheduleIds.map(async (id) => {
                const scheduleRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', id);
                try {
                    const docSnap = await getDoc(scheduleRef); // Read the doc
                    if (docSnap.exists()) {
                        const bells = docSnap.data().bells || [];
                        // Check for duplicate time
                        if (bells.find(b => b.time === newBell.time)) {
                            skippedCount++;
                        } else {
                            const newBells = [...bells, newBell];
                            await updateDoc(scheduleRef, { bells: newBells }); // Write the doc
                            successCount++;
                        }
                    }
                } catch (error) {
                    console.error(`Failed to update schedule ${id}:`, error);
                }
            });

            await Promise.all(promises); // Wait for all updates

            // UPDATED: Don't hide modal, just clear inputs and show success
            multiAddStatus.textContent = `Done. Added to ${successCount} schedules. Skipped ${skippedCount} (due to duplicate times).`;
            multiAddSubmitBtn.disabled = false;
            multiBellTimeInput.value = '';
            multiBellNameInput.value = '';
            
            // Clear status after 2 seconds
            setTimeout(() => {
                multiAddStatus.classList.add('hidden');
            }, 2000);
        }
        
        // NEW: Add Bell to THIS Schedule (single)
        async function handleAddSharedBell(e) {
            e.preventDefault();
            const time = sharedTimeInput.value;
            const name = sharedNameInput.value;
            const sound = sharedSoundInput.value;

            if (!time || !name) return;

            // Check for duplicates
            if (localSchedule.find(bell => bell.time === time)) {
                addSharedStatus.textContent = `A bell already exists on this schedule at ${time}`;
                addSharedStatus.classList.remove('hidden');
                return;
            }

            localSchedule.push({ time, name, sound });
            renderCombinedList(); // Optimistic update
            
            try {
                await updateActiveScheduleBells(); // Push to cloud
                addSharedStatus.textContent = "Bell added successfully!";
                addSharedStatus.classList.remove('hidden');
            } catch (error) {
                console.error("Error adding shared bell:", error);
                addSharedStatus.textContent = "Error adding bell.";
                addSharedStatus.classList.remove('hidden');
                // Revert optimistic update on error?
                localSchedule.pop();
                renderCombinedList();
            }
            
            sharedTimeInput.value = ""; // Clear form
            sharedNameInput.value = "";
            
            setTimeout(() => {
                addSharedStatus.classList.add('hidden');
            }, 2000);
        }

        // NEW: Create a new shared schedule
        async function handleCreateSchedule(e) {
            e.preventDefault();
            const newName = newScheduleNameInput.value.trim();
            if (!newName) return;

            // Create a simple ID from the name
            const newId = newName.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
            if (!newId || allSchedules.some(s => s.id === newId)) {
                statusElement.textContent = `A schedule with ID '${newId}' already exists.`;
                return;
            }

            try {
                const newScheduleRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', newId);
                await setDoc(newScheduleRef, { name: newName, bells: [] });
                newScheduleNameInput.value = '';
                statusElement.textContent = `Schedule '${newName}' created.`;
                
                // Select the new schedule
                localStorage.setItem('schoolBell-activeScheduleId', newId);
                activeScheduleId = newId;
                listenToActiveScheduleDoc(newId);
                // Dropdown will update via snapshot listener
                
            } catch (error) {
                console.error("Error creating schedule:", error);
                statusElement.textContent = "Error creating schedule.";
            }
        }

        // NEW: Delete the currently active schedule
        async function handleDeleteSchedule() {
            if (!activeScheduleId) {
                statusElement.textContent = "No schedule selected to delete.";
                return;
            }
            
            const schedule = allSchedules.find(s => s.id === activeScheduleId);
            if (!schedule) return;

            // Show confirmation modal
            confirmDeleteText.textContent = `Are you sure you want to delete the schedule "${schedule.name}"? This action cannot be undone.`;
            confirmDeleteModal.classList.remove('hidden');

            // Set up a one-time listener for the confirm button
            deleteConfirmBtn.onclick = async () => {
                try {
                    const docToDeleteRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', activeScheduleId);
                    await deleteDoc(docToDeleteRef);
                    
                    statusElement.textContent = `Schedule "${schedule.name}" deleted.`;
                    confirmDeleteModal.classList.add('hidden');
                    // The collection listener will handle dropdown refresh
                    // and selecting a new default schedule
                } catch (error) {
                    console.error("Error deleting schedule:", error);
                    statusElement.textContent = "Error deleting schedule.";
                    confirmDeleteModal.classList.add('hidden');
                }
            };
        }


        // Single delete handler for the combined list
        async function handleDeleteFromCombinedList(e) {
            const button = e.target.closest('button');
            if (!button) return;

            // Handle Delete
            if (button.dataset.type && button.classList.contains('delete-btn') || button.classList.contains('delete-custom-btn')) {
                const time = button.dataset.time;
                const type = button.dataset.type;

                if (type === 'shared') {
                    // ... (delete logic as before)
                    const isAdmin = document.body.classList.contains('admin-mode');
                    if (!isAdmin) return;
                    
                    const index = localSchedule.findIndex(bell => bell.time === time);
                    if (index > -1) {
                        localSchedule.splice(index, 1);
                        renderCombinedList(); // Optimistic update
                        await updateActiveScheduleBells(); // Push to cloud
                    }
                } else if (type === 'custom') {
                    // ... (delete logic as before)
                    const index = customBells.findIndex(bell => bell.time === time);
                    if (index > -1) {
                        customBells.splice(index, 1);
                        saveCustomBells(); // Save to local storage
                        renderCombinedList(); // Update UI
                    }
                }
            }

            // NEW: Handle Edit
            if (button.dataset.type && (button.classList.contains('edit-btn') || button.classList.contains('edit-custom-btn'))) {
                // Store the original data of the bell being edited
                currentEditingBell = {
                    time: button.dataset.time,
                    name: button.dataset.name,
                    sound: button.dataset.sound,
                    type: button.dataset.type
                };
                
                // Pre-fill and show the edit modal
                editBellTimeInput.value = currentEditingBell.time;
                editBellNameInput.value = currentEditingBell.name;
                editBellSoundInput.value = currentEditingBell.sound;
                editBellStatus.classList.add('hidden');
                editBellModal.classList.remove('hidden');
            }
        }

        // NEW: Handle saving the edit from the modal
        async function handleSaveEditBell(e) {
            e.preventDefault();
            if (!currentEditingBell) return;

            const newBellData = {
                time: editBellTimeInput.value,
                name: editBellNameInput.value,
                sound: editBellSoundInput.value
            };

            const originalBellData = {
                time: currentEditingBell.time,
                name: currentEditingBell.name,
                sound: currentEditingBell.sound
            };
            
            // Check if data actually changed
            if (newBellData.time === originalBellData.time && 
                newBellData.name === originalBellData.name &&
                newBellData.sound === originalBellData.sound) {
                editBellStatus.textContent = "No changes detected.";
                editBellStatus.classList.remove('hidden');
                return;
            }

            editBellSubmitBtn.disabled = true;

            // --- Logic for CUSTOM bell ---
            if (currentEditingBell.type === 'custom') {
                const index = customBells.findIndex(b => b.time === originalBellData.time);
                if (index > -1) {
                    customBells[index] = newBellData; // Replace with new data
                    saveCustomBells();
                    renderCombinedList();
                }
                editBellModal.classList.add('hidden');
                editBellSubmitBtn.disabled = false;
                currentEditingBell = null;
                return;
            }

            // --- Logic for SHARED bell (more complex) ---
            if (currentEditingBell.type === 'shared') {
                editBellStatus.textContent = "Checking for linked bells...";
                editBellStatus.classList.remove('hidden');

                // Find other schedules that have this *exact original* bell
                const matchedSchedules = await findSchedulesWithBell(originalBellData);
                
                // Store all data needed for the final confirmation step
                linkedEditData = {
                    originalBell: originalBellData,
                    newBell: newBellData,
                    matchedSchedules: matchedSchedules // Array of {id, name}
                };

                if (matchedSchedules.length > 0) {
                    // Matches found! Show the "linked edit" modal
                    renderLinkedScheduleList(matchedSchedules);
                    linkedEditStatus.classList.add('hidden');
                    confirmLinkedEditModal.classList.remove('hidden');
                    editBellModal.classList.add('hidden'); // Hide the edit modal
                } else {
                    // No matches. Just apply to this one schedule.
                    await applyLinkedEdit([activeScheduleId], originalBellData, newBellData);
                    editBellModal.classList.add('hidden');
                }
                
                editBellSubmitBtn.disabled = false;
                currentEditingBell = null;
            }
        }

        // NEW: Finds all schedules (except the active one) that contain an exact bell
        async function findSchedulesWithBell(bellToFind) {
            const matches = [];
            // Check all schedules *except* the currently active one
            const otherSchedules = allSchedules.filter(s => s.id !== activeScheduleId);
            
            const promises = otherSchedules.map(async (schedule) => {
                const scheduleRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', schedule.id);
                try {
                    const docSnap = await getDoc(scheduleRef);
                    if (docSnap.exists()) {
                        const bells = docSnap.data().bells || [];
                        const found = bells.some(b => 
                            b.time === bellToFind.time &&
                            b.name === bellToFind.name &&
                            b.sound === bellToFind.sound
                        );
                        if (found) {
                            matches.push({ id: schedule.id, name: schedule.name });
                        }
                    }
                } catch (error) {
                    console.error(`Error checking schedule ${schedule.id}:`, error);
                }
            });

            await Promise.all(promises);
            return matches; // Returns array of {id, name}
        }

        // NEW: Renders the list of schedules for the linked edit modal
        function renderLinkedScheduleList(matchedSchedules) {
            linkedScheduleList.innerHTML = '';
            // Add the *current* schedule to the list (always checked and disabled)
            const currentSchedule = allSchedules.find(s => s.id === activeScheduleId);
            linkedScheduleList.innerHTML += `
                <div class="flex items-center">
                    <input type="checkbox" id="linked-check-${currentSchedule.id}" value="${currentSchedule.id}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" checked disabled>
                    <label for="linked-check-${currentSchedule.id}" class="ml-3 block text-sm font-medium text-gray-700">${currentSchedule.name} (current)</label>
                </div>
            `;
            // Add all other matched schedules
            matchedSchedules.forEach(schedule => {
                linkedScheduleList.innerHTML += `
                    <div class="flex items-center">
                        <input type="checkbox" id="linked-check-${schedule.id}" value="${schedule.id}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" checked>
                        <label for="linked-check-${schedule.id}" class="ml-3 block text-sm font-medium text-gray-700">${schedule.name}</label>
                    </div>
                `;
            });
        }
        
        // NEW: Performs the final "find/replace" batch write
        async function applyLinkedEdit(scheduleIds, originalBell, newBell) {
            const batch = writeBatch(db);
            
            const promises = scheduleIds.map(async (id) => {
                const scheduleRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', id);
                try {
                    // We MUST read the doc inside the transaction/batch loop
                    const docSnap = await getDoc(scheduleRef);
                    if (docSnap.exists()) {
                        const bells = docSnap.data().bells || [];
                        // Find and replace the original bell
                        const newBells = bells.map(b => 
                            (b.time === originalBell.time && b.name === originalBell.name && b.sound === originalBell.sound) 
                            ? newBell 
                            : b
                        );
                        batch.update(scheduleRef, { bells: newBells });
                    }
                } catch (error) {
                    console.error(`Error updating doc ${id} in batch:`, error);
                }
            });

            await Promise.all(promises); // Wait for all reads
            await batch.commit(); // Commit all writes
        }


        // UPDATED: To save bell name
        async function handleAddCustomBell(e) {
            e.preventDefault();
            const time = customTimeInput.value;
            const name = customNameInput.value; // New
            const sound = customSoundInput.value;

            if (!time || !name) return;

            // Check for duplicates
            if (customBells.find(bell => bell.time === time)) {
                statusElement.textContent = `A custom bell already exists at ${time}`;
                return;
            }

            customBells.push({ time, name, sound }); // New structure
            saveCustomBells();
            renderCombinedList(); // Re-render the combined list
            
            customTimeInput.value = ""; // Clear form
            customNameInput.value = "";
        }

        async function handleScheduleChange(e) {
            const newScheduleId = e.target.value;
            if (newScheduleId && newScheduleId !== activeScheduleId) {
                // Save the user's choice locally, not globally
                localStorage.setItem('schoolBell-activeScheduleId', newScheduleId);
                activeScheduleId = newScheduleId;
                // Switch the listener to the new schedule
                listenToActiveScheduleDoc(newScheduleId);
            }
        }

       /**
        * Loads the initial schedule on startup.
        */
        async function loadAndSetInitialSchedule() {
           const savedId = localStorage.getItem('schoolBell-activeScheduleId');
           
           const snapshot = await getDocs(schedulesCollectionRef);
           allSchedules = [];
           snapshot.forEach(doc => {
               allSchedules.push({ id: doc.id, ...doc.data() });
           });
           allSchedules.sort((a, b) => a.name.localeCompare(b.name));

           const isValid = allSchedules.some(s => s.id === savedId);

           if (isValid) {
               activeScheduleId = savedId;
           } else if (allSchedules.length > 0) {
               activeScheduleId = allSchedules[0].id; // Default to first
               localStorage.setItem('schoolBell-activeScheduleId', activeScheduleId); // Save default
           } else {
               activeScheduleId = null; // No schedules exist
           }

           renderScheduleDropdown(); // Render dropdown with correct selection
           listenToActiveScheduleDoc(activeScheduleId); // Start listening to bell data
        }

        // --- Initialization ---
        async function initialize() {
            
            // Your web app's Firebase configuration (from your snippet)
            // This is PUBLIC and that is OK. Security is handled by Firestore Rules.
            const firebaseConfig = {
              apiKey: "AIzaSyDfo45UBu-pR8nqMQhVlS_QgyYZ2kzBdvM",
              authDomain: "ellisbell-c185c.firebaseapp.com",
              projectId: "ellisbell-c185c",
              storageBucket: "ellisbell-c185c.firebasestorage.app",
              messagingSenderId: "441560045695",
              appId: "1:441560045695:web:94e51a006663404b8f474a",
              measurementId: "G-D6TX4YRBSD"
            };

            // 1. Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app); // Added analytics
            
            // REMOVED: App Check initialization block
            
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug'); // Enable debug logging for firestore
            
            // 2. Sign in (using anonymous auth)
            try {
                await signInAnonymously(auth);
                console.log("Signed in anonymously.");

            } catch (error) {
                console.error("Firebase Auth Error:", error);
                statusElement.textContent = "Auth Error. Check console.";
                return;
            }

            // 3. Set up Auth listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdElement.textContent = userId;

                    // Setup collection ref using the hardcoded appId
                    schedulesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'schedules');

                    await checkAndSeedSchedules();
                    await loadAndSetInitialSchedule();
                    loadCustomBells(); // Load custom bells
                    listenToSchedulesCollection(); // This listener is key!

                } else {
                    userId = null;
                    userIdElement.textContent = "Not signed in";
                }
            });
        }
        
        // --- Start the App ---
        startAudioBtn.addEventListener('click', async () => {
            try {
                await Tone.start(); // Start the audio context
                console.log("Audio Context Started");
                
                setupSynths(); // Init the synths
                initialize(); // Init Firebase
                updateClock(); // Start the live clock
                
                audioOverlay.style.display = 'none'; // Hide overlay
            } catch (error) { // <-- This opening brace was missing
                console.error("Error starting Tone.js:", error);
                audioOverlay.innerHTML = `<div class="text-white text-2xl text-center">Sorry, audio could not be started.<br>Please refresh and try again.</div>`;
            }
        });

        // --- Attach form/list listeners
        addCustomBellForm.addEventListener('submit', handleAddCustomBell);
        scheduleSelector.addEventListener('change', handleScheduleChange);
        combinedBellListElement.addEventListener('click', handleDeleteFromCombinedList);
        previewCustomSoundBtn.addEventListener('click', () => {
            playBell(customSoundInput.value); // Preview custom sound
        });
        
        // NEW: Admin Listeners
        createScheduleForm.addEventListener('submit', handleCreateSchedule);
        deleteScheduleBtn.addEventListener('click', handleDeleteSchedule);
        deleteCancelBtn.addEventListener('click', () => confirmDeleteModal.classList.add('hidden'));
        addSharedBellForm.addEventListener('submit', handleAddSharedBell);
        previewSharedSoundBtn.addEventListener('click', () => {
            playBell(sharedSoundInput.value);
        });

        // Admin Modal Listeners
        adminToggleBtn.addEventListener('click', () => {
            adminModal.classList.remove('hidden');
            adminPasswordInput.value = '';
            adminPasswordInput.focus();
            adminError.classList.add('hidden');
        });
        adminCancelBtn.addEventListener('click', () => {
            adminModal.classList.add('hidden');
        });
        adminSubmitBtn.addEventListener('click', () => {
            const password = adminPasswordInput.value;
            if (password === 'admin123') { // Simple password, as requested
                toggleAdminMode(true);
                adminModal.classList.add('hidden');
            } else {
                adminError.classList.remove('hidden');
            }
        });

D: Multi-Add Bell Modal Listeners
        showAddBellModalBtn.addEventListener('click', () => {
            // Re-render the schedule list every time modal is opened
            // to ensure it's up to date.
            renderMultiAddScheduleList();
            addBellModal.classList.remove('hidden');
        });
        multiAddCancelBtn.addEventListener('click', () => {
            addBellModal.classList.add('hidden');
        });
        multiAddBellForm.addEventListener('submit', handleAddBellToMultiple);

        // NEW: Edit Bell Modal Listeners
        editBellForm.addEventListener('submit', handleSaveEditBell);
        editBellCancelBtn.addEventListener('click', () => {
            editBellModal.classList.add('hidden');
            currentEditingBell = null;
        });

        // NEW: Linked Edit Modal Listeners
        linkedEditCancel.addEventListener('click', () => {
            confirmLinkedEditModal.classList.add('hidden');
            linkedEditData = null;
        });

        linkedEditThisOnly.addEventListener('click', async () => {
            if (!linkedEditData) return;
            linkedEditStatus.textContent = "Applying to this schedule only...";
            linkedEditStatus.classList.remove('hidden');

            const { originalBell, newBell } = linkedEditData;
            await applyLinkedEdit([activeScheduleId], originalBell, newBell);
            
            confirmLinkedEditModal.classList.add('hidden');
            linkedEditData = null;
        });

        linkedEditApply.addEventListener('click', async () => {
            if (!linkedEditData) return;
            linkedEditStatus.textContent = "Applying to all selected schedules...";
            linkedEditStatus.classList.remove('hidden');

            const { originalBell, newBell } = linkedEditData;
            // Get all checked IDs
            const checkedBoxes = linkedScheduleList.querySelectorAll('input[type="checkbox"]:checked');
            const targetScheduleIds = Array.from(checkedBoxes).map(cb => cb.value);

            await applyLinkedEdit(targetScheduleIds, originalBell, newBell);

            confirmLinkedEditModal.classList.add('hidden');
            linkedEditData = null;
        });

    </script>
</body>
</html>



